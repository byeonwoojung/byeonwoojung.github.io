{"componentChunkName":"component---src-templates-blog-template-js","path":"/26-01-13_1/","result":{"data":{"cur":{"id":"34d120bf-0552-506b-8640-779280088570","html":"<p>참고 : 테디노트의 RAG 비법노트 (<a href=\"https://fastcampus.co.kr/data_online_teddy)\">https://fastcampus.co.kr/data_online_teddy)</a><br>소스코드: <a href=\"https://github.com/teddylee777/langchain-kr\">https://github.com/teddylee777/langchain-kr</a><br>위키독스: <a href=\"https://wikidocs.net/book/14314\">https://wikidocs.net/book/14314</a></p>\n<p> </p>\n<p>오늘은 정말 뜬금없이 갖가지 내용들을 끄적이고자 합니다..<br><strong>@chain 데코레이터</strong>, <strong>Configurable</strong>, <strong>Route</strong> 등에 대해 정리하고자 합니다.</p>\n<p>레츠기릿</p>\n<p> </p>\n<h2 id=\"chain-데코레이터\" style=\"position:relative;\"><a href=\"#chain-%EB%8D%B0%EC%BD%94%EB%A0%88%EC%9D%B4%ED%84%B0\" aria-label=\"chain 데코레이터 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>@chain 데코레이터</h2>\n<hr>\n<p><code class=\"language-text\">from langchain_core.runnables import chain</code>으로 가져와서<br><code class=\"language-text\">@chain</code> 데코레이터를 이용해 <strong>함수를 <code class=\"language-text\">chain</code>으로 변환</strong>하도록 합시다.</p>\n<p>즉, <code class=\"language-text\">chain</code>은 <code class=\"language-text\">Runnable</code> 객체이기 때문에 LCEL 인터페이스에 따라 <code class=\"language-text\">invoke()</code> 메서드 등을 활용할 수 있습니다.</p>\n<p>chain.get_graph().print_ascii()로 체인의 그래프 출력 가능<br>(<code class=\"language-text\">!pip install -qU grandalf</code> 그래프 그리는 라이브러리 설치해야 함)</p>\n<p><code class=\"language-text\">chain.get_prompts()</code>로 체인의 프롬프트 확인 가능</p>\n<h2 id=\"helper-함수와-wrapper-함수\" style=\"position:relative;\"><a href=\"#helper-%ED%95%A8%EC%88%98%EC%99%80-wrapper-%ED%95%A8%EC%88%98\" aria-label=\"helper 함수와 wrapper 함수 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Helper 함수와 Wrapper 함수</h2>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token triple-quoted-string string\">\"\"\"\nHelper 함수: Wrapper 함수를 통해서만 사용된다는 의미로 _를 붙임\n- 실제 로직이 실행되는 함수\n\"\"\"</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">_multiple_length_function</span><span class=\"token punctuation\">(</span>text1<span class=\"token punctuation\">,</span> text2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 두 텍스트의 길이를 곱하는 함수</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>text1<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>text2<span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"\nWrapper 함수: 2개 인자를 받는 함수로 연결하는 함수\n- Helper 함수에서 실제 로직이 실행되기 위해, 형식을 맞춰주는 함수\n- RunnableLambda에서 인자는 1개로 받아야 하므로, 딕셔너리 활용\n- 이 함수에서만 사용한다는 의미와 dict 기본 명령어 겹치지 않기 위해 _dict라는 이름을 사용\n\"\"\"</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">multiple_length_function</span><span class=\"token punctuation\">(</span>\n    _dict<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 딕셔너리에서 \"text1\"과 \"text2\"의 길이를 곱하는 함수</span>\n    <span class=\"token keyword\">return</span> _multiple_length_function<span class=\"token punctuation\">(</span>_dict<span class=\"token punctuation\">[</span><span class=\"token string\">\"text1\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> _dict<span class=\"token punctuation\">[</span><span class=\"token string\">\"text2\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"configurable\" style=\"position:relative;\"><a href=\"#configurable\" aria-label=\"configurable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Configurable</h2>\n<hr>\n<p><code class=\"language-text\">chain</code>에 <code class=\"language-text\">config</code>로 전달하는 딕셔너리(<code class=\"language-text\">RunnableConfig</code>)에서 주로 쓰는 약속된 키가 몇 가지 존재합니다. <code class=\"language-text\">chain.invoke(입력값, config)</code>로 config 설정 가능합니다. 사용하는 방법은 <code class=\"language-text\">Configurable</code>에 챕터에서 자세히 보고자 합니다.</p>\n<ol>\n<li>\n<p><code class=\"language-text\">callbacks</code> (가장 중요 ⭐)</p>\n<ul>\n<li>\n<p><strong>역할</strong>: 실행 과정을 지켜보는 감시자(핸들러)를 등록합니다.</p>\n</li>\n<li>\n<p><strong>용도</strong>: Log 출력, LangSmith 추적, 스트리밍 처리 등.</p>\n</li>\n<li>\n<p><strong>예시</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\"callbacks\": [ConsoleCallbackHandler()]}</code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">tags</code></p>\n<ul>\n<li>\n<p><strong>역할</strong>: 이 실행에 태그(꼬리표)를 붙입니다.</p>\n</li>\n<li>\n<p><strong>용도</strong>: 나중에 로그나 LangSmith에서 “이 태그 달린 것만 보여줘” 하고 필터링할 때 씁니다.</p>\n</li>\n<li>\n<p><strong>예시</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\"tags\": [\"my-tag\", \"experiment-1\"]}</code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">metadata</code></p>\n<ul>\n<li>\n<p><strong>역할</strong>: 추가적인 정보를 딕셔너리로 저장합니다.</p>\n</li>\n<li>\n<p><strong>용도</strong>: 사용자 ID, 세션 ID 처럼 실행 로직에는 영향이 없지만 기록해두고 싶은 정보들.</p>\n</li>\n<li>\n<p><strong>예시</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\"metadata\": {\"user_id\": \"123\", \"session_id\": \"abc\"}}</code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">run_name</code></p>\n<ul>\n<li>\n<p><strong>역할</strong>: 이 실행(Run)의 이름을 강제로 지정합니다.</p>\n</li>\n<li>\n<p><strong>용도</strong>: LangSmith 트레이스 화면에서 “RunnableLambda” 대신 “내 수정 함수” 처럼 예쁜 이름으로 보고 싶을 때.</p>\n</li>\n<li>\n<p><strong>예시</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\"run_name\": \"MyCustomParsingJob\"}</code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">recursion_limit</code></p>\n<ul>\n<li>\n<p><strong>역할</strong>: 체인이 너무 깊게 뺑뺑이 도는 것을 막습니다. (기본값 25)</p>\n</li>\n<li>\n<p><strong>용도</strong>: 무한 루프 방지.</p>\n</li>\n<li>\n<p><strong>예시</strong>:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">{\"recursion_limit\": 10}</code></pre></div>\n</li>\n</ul>\n</li>\n</ol>\n<p> </p>\n<p>이외에도 <code class=\"language-text\">configurable_field()</code> 메서드를 이용해 LLM 모델을 생성한 후<br><strong><code class=\"language-text\">config</code>에서 <code class=\"language-text\">configurable</code>키를 설정해 LLM 모델의 필드(파라미터)를 동적으로 바꿀 수 있습니다.</strong></p>\n<p> </p>\n<p> </p>\n<p>앞서 얘기한 <strong>configurable</strong>에 대해 더 구체적이고 명확하게 정리하고자 합니다.</p>\n<h3 id=\"동적-변경을-허용할-속성runnable-대안-정의하는-방법\" style=\"position:relative;\"><a href=\"#%EB%8F%99%EC%A0%81-%EB%B3%80%EA%B2%BD%EC%9D%84-%ED%97%88%EC%9A%A9%ED%95%A0-%EC%86%8D%EC%84%B1runnable-%EB%8C%80%EC%95%88-%EC%A0%95%EC%9D%98%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\" aria-label=\"동적 변경을 허용할 속성runnable 대안 정의하는 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>동적 변경을 허용할 ‘속성/Runnable 대안’ 정의하는 방법</h3>\n<ol>\n<li>\n<p><code class=\"language-text\">.configurable_fields()</code>: 동적 변경 가능한 속성(필드)을 정의하는 메서드</p>\n<p>[동적 변경할 ChatOpenAI의 model_name 속성 정의]</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain<span class=\"token punctuation\">.</span>prompts <span class=\"token keyword\">import</span> PromptTemplate\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables <span class=\"token keyword\">import</span> ConfigurableField\n<span class=\"token keyword\">from</span> langchain_openai <span class=\"token keyword\">import</span> ChatOpenAI\n\n<span class=\"token comment\"># model_name: 동적 설정 가능 (default:gpt-4o)</span>\nmodel <span class=\"token operator\">=</span> ChatOpenAI<span class=\"token punctuation\">(</span>temperature<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> model_name<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>configurable_fields<span class=\"token punctuation\">(</span>\n\t<span class=\"token comment\"># ChatOpenAI의 필드 model_name을 동적으로 변경할 것임을 설정</span>\n    model_name<span class=\"token operator\">=</span>ConfigurableField<span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">id</span><span class=\"token operator\">=</span><span class=\"token string\">\"gpt_version\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># model_name의 id 설정</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"Version of GPT\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># model_name의 이름 설정</span>\n        <span class=\"token comment\"># model_name의 설명 설정</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Official model name of GPTs. ex) gpt-4o, gpt-4o-mini\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">ChatOpenAI</code>에 <code class=\"language-text\">configurable_fields()</code> 메서드를 이용해 속성 <code class=\"language-text\">model_name</code>을 동적 변경 가능한 속성으로 정의함</li>\n<li>속성 <code class=\"language-text\">model_name</code>에 <code class=\"language-text\">ConfigurableField</code>을 이용해 정의함</li>\n<li>속성 변경 시, <code class=\"language-text\">model_name</code>의 <code class=\"language-text\">id</code> 값인 <code class=\"language-text\">gpt_version</code>에 변경할 값을 주면 됨</li>\n</ul>\n<p> </p>\n<p>[HubRunnable을 이용한 랭체인 허브 프롬프트 동적 변경 정의]</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain<span class=\"token punctuation\">.</span>runnables<span class=\"token punctuation\">.</span>hub <span class=\"token keyword\">import</span> HubRunnable\n\nprompt <span class=\"token operator\">=</span> HubRunnable<span class=\"token punctuation\">(</span><span class=\"token string\">\"teddynote/rag-prompt-korean\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>configurable_fields<span class=\"token punctuation\">(</span>\n    <span class=\"token comment\"># 소유자 저장소 커밋을 설정하는 ConfigurableField</span>\n    owner_repo_commit<span class=\"token operator\">=</span>ConfigurableField<span class=\"token punctuation\">(</span>  <span class=\"token comment\"># ⭐️ owner_repo_commit는 \"teddynote/rag-prompt-korean\" 부분을 말하는 것 ⭐️</span>\n        <span class=\"token comment\"># 필드의 ID</span>\n        <span class=\"token builtin\">id</span><span class=\"token operator\">=</span><span class=\"token string\">\"hub_commit\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\"># 필드의 이름</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"Hub Commit\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\"># 필드에 대한 설명</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Korean RAG prompt by teddynote\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\nprompt</code></pre></div>\n<ul>\n<li><code class=\"language-text\">HubRunnable</code>에 <code class=\"language-text\">configurable_fields()</code> 메서드를 이용해 속성 <code class=\"language-text\">owner_repo_commit</code>을 동적 변경 가능한 속성으로 정의함\n<ul>\n<li><strong>정확히 말하자면, LangChain Hub에서 프롬프트 불러오는 repo 속성을 변경하는 것입니다!!!</strong></li>\n</ul>\n</li>\n<li>속성 <code class=\"language-text\">owner_repo_commit</code>에 <code class=\"language-text\">ConfigurableField</code>을 이용해 정의함</li>\n<li>속성 변경 시, <code class=\"language-text\">owner_repo_commit</code>의 <code class=\"language-text\">id</code> 값인 <code class=\"language-text\">hub_commit</code>에 변경할 값을 주면 됨</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">.configurable_alternatives()</code>: Runnable 객체 대안을 정의하는 메서드</p>\n<p>[LLM의 객체 대안 정의]</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain<span class=\"token punctuation\">.</span>prompts <span class=\"token keyword\">import</span> PromptTemplate\n<span class=\"token keyword\">from</span> langchain_anthropic <span class=\"token keyword\">import</span> ChatAnthropic\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables <span class=\"token keyword\">import</span> ConfigurableField\n<span class=\"token keyword\">from</span> langchain_openai <span class=\"token keyword\">import</span> ChatOpenAI\n\n<span class=\"token comment\"># ⭐️ configurable_alternatives: Runnable 객체 자체를 바꿈 ⭐️</span>\n\nllm <span class=\"token operator\">=</span> ChatAnthropic<span class=\"token punctuation\">(</span>\n    temperature<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> model<span class=\"token operator\">=</span><span class=\"token string\">\"claude-3-5-sonnet-20240620\"</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>configurable_alternatives<span class=\"token punctuation\">(</span>\n    <span class=\"token comment\"># 이 필드에 id를 부여합니다.</span>\n    <span class=\"token comment\"># 최종 실행 가능한 객체를 구성할 때, 이 id를 사용하여 이 필드를 구성할 수 있습니다.</span>\n    ConfigurableField<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span><span class=\"token string\">\"llm\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 기본 키를 설정합니다.</span>\n    <span class=\"token comment\"># ⭐️ configurable에서 llm에 이 키를 지정하면 위에서 초기화된 기본 LLM(ChatAnthropic(temperature=0, model=\"claude-3-5-sonnet-20240620\"))이 사용됩니다. ⭐️</span>\n    default_key<span class=\"token operator\">=</span><span class=\"token string\">\"anthropic\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 'openai'라는 이름의 새 옵션을 추가하며, 이는 `ChatOpenAI()`와 동일합니다.</span>\n    openai<span class=\"token operator\">=</span>ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 'gpt4'라는 이름의 새 옵션을 추가하며, 이는 `ChatOpenAI(model=\"gpt-4\")`와 동일합니다.</span>\n    gpt4o<span class=\"token operator\">=</span>ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 여기에 더 많은 구성 옵션을 추가할 수 있습니다.</span>\n<span class=\"token punctuation\">)</span>\nprompt <span class=\"token operator\">=</span> PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span><span class=\"token string\">\"{topic} 에 대해 간단히 설명해주세요.\"</span><span class=\"token punctuation\">)</span>\nchain <span class=\"token operator\">=</span> prompt <span class=\"token operator\">|</span> llm</code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">ChatAnthropic</code>에 <code class=\"language-text\">configurable_alternatives()</code> 메서드를 이용해 LLM 모델 자체를 변경 가능하도록 정의함<br>(속성 변경이 아니므로 메서드에 필드명 없이 바로 <code class=\"language-text\">ConfigurableField</code> 넣음)</p>\n</li>\n<li>\n<p>LLM 모델 변경 시</p>\n<ul>\n<li>\n<p><code class=\"language-text\">id</code> 값인 <code class=\"language-text\">llm</code>에 변경할 값을 주면 됨</p>\n</li>\n<li>\n<p><code class=\"language-text\">id</code>에 줄 수 있는 변경 가능한 값</p>\n<ul>\n<li><code class=\"language-text\">anthropic</code>: <code class=\"language-text\">default_key</code>로 설정한 원래 모델 설정<br>(<code class=\"language-text\">ChatAnthropic(temperature=0, model=\"claude-3-5-sonnet-20240620\")</code>)을 이용할 때, <code class=\"language-text\">id</code>에 줄 값</li>\n<li><code class=\"language-text\">openai</code>: <code class=\"language-text\">ChatOpenAI(model=\"gpt-4o-mini\")</code>로 설정</li>\n<li><code class=\"language-text\">gpt4o</code>: <code class=\"language-text\">ChatOpenAI(model=\"gpt-4o\")</code>로 설정</li>\n</ul>\n</li>\n<li>\n<p>모델 변경 방법 예시</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">chain<span class=\"token punctuation\">.</span>with_config<span class=\"token punctuation\">(</span>configurable<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"llm\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"openai\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"뉴진스\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n</li>\n</ul>\n<p>[프롬프트 객체 대안 정의]</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 언어 모델을 초기화하고 temperature를 0으로 설정합니다.</span>\nllm <span class=\"token operator\">=</span> ChatOpenAI<span class=\"token punctuation\">(</span>temperature<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\nprompt <span class=\"token operator\">=</span> PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"{country} 의 수도는 어디야?\"</span>  <span class=\"token comment\"># 기본 프롬프트 템플릿</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>configurable_alternatives<span class=\"token punctuation\">(</span>\n    <span class=\"token comment\"># 이 필드에 id를 부여합니다. (⭐️ 변경할 값을 prompt 변수명에 넣으면 됨 ⭐️)</span>\n    ConfigurableField<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span><span class=\"token string\">\"prompt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 기본 키를 설정합니다. -> ⭐️ configurable에서 prompt에 capital로 넣으면 원래 프롬프트 \"{country} 의 수도는 어디야?\"로 설정됨 ⭐️</span>\n    default_key<span class=\"token operator\">=</span><span class=\"token string\">\"capital\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 'area'이라는 새로운 옵션을 추가합니다.</span>\n    area<span class=\"token operator\">=</span>PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span><span class=\"token string\">\"{country} 의 면적은 얼마야?\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 'population'이라는 새로운 옵션을 추가합니다.</span>\n    population<span class=\"token operator\">=</span>PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span><span class=\"token string\">\"{country} 의 인구는 얼마야?\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 'eng'이라는 새로운 옵션을 추가합니다.</span>\n    eng<span class=\"token operator\">=</span>PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span><span class=\"token string\">\"{input} 을 영어로 번역해주세요.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 여기에 더 많은 구성 옵션을 추가할 수 있습니다.</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 프롬프트와 언어 모델을 연결하여 체인을 생성합니다.</span>\nchain <span class=\"token operator\">=</span> prompt <span class=\"token operator\">|</span> llm</code></pre></div>\n<p>LLM 객체 대안 설정과 비슷합니다 !!</p>\n</li>\n<li>\n<p><code class=\"language-text\">ConfigurableField()</code>: 동적으로 변경할 필드 정의</p>\n<ul>\n<li>\n<p><code class=\"language-text\">id</code> : 동적으로 변경할 필드명을 대신할 변수명(필수로 지정)<br>ex ChatOpenAI의 model_name 필드명을 gpt_version으로 대신함 -> 나중에 gpt_version에 속성값을 지정함</p>\n</li>\n<li>\n<p><code class=\"language-text\">name</code>: id에 대한 이름</p>\n<ul>\n<li>동적으로 변경하는 필드명이 무엇인지 이름을 정함</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">description</code>: 해당 필드에 대한 설명</p>\n</li>\n</ul>\n</li>\n</ol>\n<p> </p>\n<h3 id=\"속성을-변경하는-방법\" style=\"position:relative;\"><a href=\"#%EC%86%8D%EC%84%B1%EC%9D%84-%EB%B3%80%EA%B2%BD%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\" aria-label=\"속성을 변경하는 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>속성을 변경하는 방법</h3>\n<ol>\n<li>\n<p><code class=\"language-text\">.invoke(config={\"configurable\": {id: 바꾸고자 하는 값}})</code>: chain에서 <code class=\"language-text\">invoke()</code> 호출 시 config 설정으로 속성을 동적으로 변경합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># gpt_version(model_name의 ConfigurableField에서 id)을 gpt-3.5-turbo로 동적 설정</span>\nmodel<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"대한민국의 수도는 어디야?\"</span><span class=\"token punctuation\">,</span>\n    config<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"configurable\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"gpt_version\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"gpt-3.5-turbo\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p><code class=\"language-text\">.with_config(configurable={id: 바꾸고자하는 값})</code>: 속성 또는 객체를 동적 변경을 위한 Runnable의 메서드<br>(<code class=\"language-text\">configurable</code> 값에 바꿀 값을 전달합니다.)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">chain<span class=\"token punctuation\">.</span>with_config<span class=\"token punctuation\">(</span>configurable<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"llm\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"openai\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"뉴진스\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ol>\n<p>차이점: <code class=\"language-text\">invoke</code>에서 config 설정은 **“이번 한 번만 실행할 때 적용”**하는 느낌이고, <code class=\"language-text\">.with_config()</code>는 “설정이 적용된 새로운 체인 객체를 아예 만들어내는” 느낌입니다. (그래서 변수에 저장해서 재사용 가능)</p>\n<p> </p>\n<p> </p>\n<h2 id=\"route\" style=\"position:relative;\"><a href=\"#route\" aria-label=\"route permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Route</h2>\n<hr>\n<p>라우팅은 이전 단계의 출력이 경로를 정하는 것입니다.<br><strong>간단한 질문 분류</strong>나 <strong>주제 분류</strong> 등에 유용한 방식이죠.</p>\n<p>유저의 질문이 들어왔을 때 라우팅을 하는 방법은<br><code class=\"language-text\">RunnableLambda</code>, <code class=\"language-text\">RunnableBranch</code> 2가지가 존재합니다.</p>\n<p> </p>\n<h3 id=\"code-classlanguage-textrunnablelambdacode에서-routing\" style=\"position:relative;\"><a href=\"#code-classlanguage-textrunnablelambdacode%EC%97%90%EC%84%9C-routing\" aria-label=\"code classlanguage textrunnablelambdacode에서 routing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">RunnableLambda</code>에서 Routing</h3>\n<p><code class=\"language-text\">route</code>를 정해주는 <code class=\"language-text\">route_chain</code> 생성</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_openai <span class=\"token keyword\">import</span> ChatOpenAI\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>output_parsers <span class=\"token keyword\">import</span> StrOutputParser\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>prompts <span class=\"token keyword\">import</span> PromptTemplate\n\nroute_prompt <span class=\"token operator\">=</span> PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"주어진 사용자 질문을 `수학`, `과학`, 또는 `기타` 중 하나로 분류하세요. 한 단어 이상으로 응답하지 마세요.\n\n&lt;question>\n{question}\n&lt;/question>\n\nClassification:\"\"\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 체인 생성</span>\nroute_chain <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    route_prompt\n    <span class=\"token operator\">|</span> ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|</span> StrOutputParser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p> </p>\n<p><code class=\"language-text\">route</code>별 수행해야 할 <code class=\"language-text\">chain</code> 생성</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">math_chain <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"You are an expert in math. \\\nAlways answer questions starting with \"깨봉선생님께서 말씀하시기를..\". \\\nRespond to the following question:\n\nQuestion: {question}\nAnswer:\"\"\"</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|</span> ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\nscience_chain <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"You are an expert in science. \\\nAlways answer questions starting with \"아이작 뉴턴 선생님께서 말씀하시기를..\". \\\nRespond to the following question:\n\nQuestion: {question}\nAnswer:\"\"\"</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|</span> ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\ngeneral_chain <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"Respond to the following question concisely:\n\nQuestion: {question}\nAnswer:\"\"\"</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|</span> ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p> </p>\n<p>정해진 <code class=\"language-text\">route</code>에 따라 <code class=\"language-text\">chain</code>으로 안내하는 교차로 역할의 함수 정의</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># RunnableLambda로 실행되는 함수이므로, 인자는 1개를 받아와야 함</span>\n<span class=\"token comment\"># info = {\"topic\": route_chain 결과, \"question\": 사용자 입력}</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">route</span><span class=\"token punctuation\">(</span>info<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 주제에 \"수학\"이 포함되어 있는 경우</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">\"수학\"</span> <span class=\"token keyword\">in</span> info<span class=\"token punctuation\">[</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># datascience_chain을 반환</span>\n        <span class=\"token keyword\">return</span> math_chain\n    <span class=\"token comment\"># 주제에 \"과학\"이 포함되어 있는 경우</span>\n    <span class=\"token keyword\">elif</span> <span class=\"token string\">\"과학\"</span> <span class=\"token keyword\">in</span> info<span class=\"token punctuation\">[</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># art_chain을 반환</span>\n        <span class=\"token keyword\">return</span> science_chain\n    <span class=\"token comment\"># 그 외의 경우</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># general_chain을 반환</span>\n        <span class=\"token keyword\">return</span> general_chain</code></pre></div>\n<p> </p>\n<p>이들을 모두 엮어주는 메인 chain</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> operator <span class=\"token keyword\">import</span> itemgetter\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables <span class=\"token keyword\">import</span> RunnableLambda\n\nfull_chain <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">:</span> route_chain<span class=\"token punctuation\">,</span> <span class=\"token string\">\"question\"</span><span class=\"token punctuation\">:</span> itemgetter<span class=\"token punctuation\">(</span><span class=\"token string\">\"question\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">|</span> RunnableLambda<span class=\"token punctuation\">(</span>\n        <span class=\"token comment\"># 경로를 지정하는 함수를 인자로 전달합니다.</span>\n        route\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|</span> StrOutputParser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">{\"topic\": route_chain, \"question\": itemgetter(\"question\")}</code>부터 이해가 안 갈 수 있지만</p>\n<p>1가지 기억합시다.</p>\n<blockquote>\n<p><strong>“chain에는 딕셔너리 형태로 계속 무언가가 전달된다.”</strong></p>\n</blockquote>\n<p>즉,</p>\n<p><strong>전달되는 것과 출력되는 것들에 집중하고<br>항상 입력을 딕셔너리로 받아온 후, itemgetter 등으로 뽑아서 사용된다는 것을 잊지 말자.</strong></p>\n<p> </p>\n<p>사용자 입력은</p>\n<ol>\n<li><code class=\"language-text\">chain</code>에 전달돼서 주제를 가져와 <code class=\"language-text\">topic</code>에 저장하고</li>\n<li><code class=\"language-text\">question</code>에 그대로 저장됩니다.</li>\n</ol>\n<p><code class=\"language-text\">topic</code>과 <code class=\"language-text\">question</code>은 <code class=\"language-text\">RunnableLambda</code>에 의해<br><code class=\"language-text\">route</code> 함수에서 <code class=\"language-text\">info</code> 딕셔너리로 그대로 받아와 <code class=\"language-text\">topic</code>에 따라 루트가 정해집니다.</p>\n<p>결국, 해당 주제별 체인에 <code class=\"language-text\">topic</code>과 <code class=\"language-text\">question</code>이 전달되면서 변수에 맞게 프롬프트가 채워지는 거죠.</p>\n<p> </p>\n<p><code class=\"language-text\">full_chain.get_graph().print_ascii()</code>를 하면</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                      \n                    <span class=\"token operator\">|</span> Parallel<span class=\"token operator\">&lt;</span>topic<span class=\"token punctuation\">,</span>question<span class=\"token operator\">></span>Input <span class=\"token operator\">|</span>                      \n                    <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                      \n                             <span class=\"token operator\">**</span><span class=\"token operator\">*</span>           <span class=\"token operator\">**</span><span class=\"token operator\">*</span>                             \n                           <span class=\"token operator\">**</span>                 <span class=\"token operator\">**</span>                           \n                         <span class=\"token operator\">**</span>                     <span class=\"token operator\">**</span>                         \n              <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                  <span class=\"token operator\">**</span>                       \n              <span class=\"token operator\">|</span> PromptTemplate <span class=\"token operator\">|</span>                   <span class=\"token operator\">*</span>                       \n              <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                   <span class=\"token operator\">*</span>                       \n                       <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>                       \n                       <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>                       \n                       <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>                       \n                <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                     <span class=\"token operator\">*</span>                       \n                <span class=\"token operator\">|</span> ChatOpenAI <span class=\"token operator\">|</span>                     <span class=\"token operator\">*</span>                       \n                <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                     <span class=\"token operator\">*</span>                       \n                       <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>                       \n                       <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>                       \n                       <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>                       \n              <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>             <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                   \n              <span class=\"token operator\">|</span> StrOutputParser <span class=\"token operator\">|</span>             <span class=\"token operator\">|</span> Lambda <span class=\"token operator\">|</span>                   \n              <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>             <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                   \n                             <span class=\"token operator\">**</span><span class=\"token operator\">*</span>           <span class=\"token operator\">**</span><span class=\"token operator\">*</span>                             \n                                <span class=\"token operator\">**</span>       <span class=\"token operator\">**</span>                                \n                                  <span class=\"token operator\">**</span>   <span class=\"token operator\">**</span>                                  \n                    <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                     \n                    <span class=\"token operator\">|</span> Parallel<span class=\"token operator\">&lt;</span>topic<span class=\"token punctuation\">,</span>question<span class=\"token operator\">></span>Output <span class=\"token operator\">|</span>                     \n                    <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                     \n                                     <span class=\"token operator\">*</span>                                     \n                                     <span class=\"token operator\">*</span>                                     \n                                     <span class=\"token operator\">*</span>                                     \n                              <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                              \n                              <span class=\"token operator\">|</span> route_input <span class=\"token operator\">|</span>                              \n                          <span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span><span class=\"token operator\">**</span><span class=\"token operator\">**</span>                          \n                     <span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token operator\">*</span>           <span class=\"token operator\">*</span>           <span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token operator\">*</span>                     \n                 <span class=\"token operator\">**</span><span class=\"token operator\">**</span>                <span class=\"token operator\">*</span>                <span class=\"token operator\">**</span><span class=\"token operator\">**</span>                 \n              <span class=\"token operator\">**</span><span class=\"token operator\">*</span>                    <span class=\"token operator\">*</span>                    <span class=\"token operator\">**</span><span class=\"token operator\">*</span>              \n<span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>          <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>          <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span> \n<span class=\"token operator\">|</span> PromptTemplate <span class=\"token operator\">|</span>          <span class=\"token operator\">|</span> PromptTemplate <span class=\"token operator\">|</span>          <span class=\"token operator\">|</span> PromptTemplate <span class=\"token operator\">|</span> \n<span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>          <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>          <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span> \n         <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>         \n         <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>         \n         <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>                           <span class=\"token operator\">*</span>         \n  <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>              <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>              <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>   \n  <span class=\"token operator\">|</span> ChatOpenAI <span class=\"token operator\">|</span><span class=\"token operator\">*</span>             <span class=\"token operator\">|</span> ChatOpenAI <span class=\"token operator\">|</span>              <span class=\"token operator\">|</span> ChatOpenAI <span class=\"token operator\">|</span>   \n  <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span> <span class=\"token operator\">**</span><span class=\"token operator\">**</span>         <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>          <span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>   \n                     <span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token operator\">*</span>           <span class=\"token operator\">*</span>           <span class=\"token operator\">**</span><span class=\"token operator\">**</span><span class=\"token operator\">*</span>                     \n                          <span class=\"token operator\">**</span><span class=\"token operator\">**</span>       <span class=\"token operator\">*</span>       <span class=\"token operator\">**</span><span class=\"token operator\">**</span>                          \n                              <span class=\"token operator\">**</span><span class=\"token operator\">*</span>    <span class=\"token operator\">*</span>    <span class=\"token operator\">**</span><span class=\"token operator\">*</span>                              \n                             <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                              \n                             <span class=\"token operator\">|</span> route_output <span class=\"token operator\">|</span>                              \n                             <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                              \n                                     <span class=\"token operator\">*</span>                                     \n                                     <span class=\"token operator\">*</span>                                     \n                                     <span class=\"token operator\">*</span>                                     \n                            <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                            \n                            <span class=\"token operator\">|</span> StrOutputParser <span class=\"token operator\">|</span>                            \n                            <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                            \n                                     <span class=\"token operator\">*</span>                                     \n                                     <span class=\"token operator\">*</span>                                     \n                                     <span class=\"token operator\">*</span>                                     \n                        <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span>                          \n                        <span class=\"token operator\">|</span> StrOutputParserOutput <span class=\"token operator\">|</span>                          \n                        <span class=\"token operator\">+</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">-</span><span class=\"token operator\">+</span></code></pre></div>\n<p>아름다운 그림이 나와요.</p>\n<p> </p>\n<p> </p>\n<h3 id=\"code-classlanguage-textrunnablebranchcode에서-routing\" style=\"position:relative;\"><a href=\"#code-classlanguage-textrunnablebranchcode%EC%97%90%EC%84%9C-routing\" aria-label=\"code classlanguage textrunnablebranchcode에서 routing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">RunnableBranch</code>에서 Routing</h3>\n<p><code class=\"language-text\">RunnableBranch</code>는 <code class=\"language-text\">if-elif-else</code>의 <code class=\"language-text\">chain</code> 버전이라고 생각하시면 됩니다.</p>\n<p>우선, ”<code class=\"language-text\">route</code>를 정해주는 <code class=\"language-text\">route_chain</code> 생성”, ”<code class=\"language-text\">route</code>별 수행해야 할 <code class=\"language-text\">chain</code> 생성”을 한 후</p>\n<p><strong>교차로 역할인 <code class=\"language-text\">route</code> 함수에서 <code class=\"language-text\">if-elif-else</code>문을 <br><code class=\"language-text\">RunnableBranch</code>에서 3개의 <code class=\"language-text\">Runnable</code> 형식으로 나열해주면 됩니다</strong>.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> operator <span class=\"token keyword\">import</span> itemgetter\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables <span class=\"token keyword\">import</span> RunnableBranch\n\nbranch <span class=\"token operator\">=</span> RunnableBranch<span class=\"token punctuation\">(</span>\n    <span class=\"token comment\"># 주제에 \"수학\"이 포함되어 있는지 확인하고, 포함되어 있다면 math_chain을 실행합니다.</span>\n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">lambda</span> x<span class=\"token punctuation\">:</span> <span class=\"token string\">\"수학\"</span> <span class=\"token keyword\">in</span> x<span class=\"token punctuation\">[</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> math_chain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 주제에 \"과학\"이 포함되어 있는지 확인하고, 포함되어 있다면 science_chain을 실행합니다.</span>\n    <span class=\"token punctuation\">(</span><span class=\"token keyword\">lambda</span> x<span class=\"token punctuation\">:</span> <span class=\"token string\">\"과학\"</span> <span class=\"token keyword\">in</span> x<span class=\"token punctuation\">[</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> science_chain<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 위의 조건에 해당하지 않는 경우 general_chain을 실행합니다.</span>\n    general_chain<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 주제와 질문을 입력받아 branch를 실행하는 전체 체인을 정의합니다.</span>\nfull_chain <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"topic\"</span><span class=\"token punctuation\">:</span> route_chain<span class=\"token punctuation\">,</span> <span class=\"token string\">\"question\"</span><span class=\"token punctuation\">:</span> itemgetter<span class=\"token punctuation\">(</span><span class=\"token string\">\"question\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> <span class=\"token operator\">|</span> branch <span class=\"token operator\">|</span> StrOutputParser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">RunnableBranch</code>안에서 <code class=\"language-text\">Runnable</code>인 <code class=\"language-text\">lamda</code> 함수로 if, elif, else 순으로 나열하면 됩니다.</p>\n<p><code class=\"language-text\">lamda</code> 함수는 <code class=\"language-text\">(lamda 입력: 조건, 실행할 것)</code> 식으로 작성하며<br>앞에서부터 해당하는 조건에서 실행됩니다.</p>\n<p> </p>\n<p> </p>\n<p>여기서 끊고 넘어가도록 하겠습니다. 👍🏻</p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#chain-%EB%8D%B0%EC%BD%94%EB%A0%88%EC%9D%B4%ED%84%B0\">@chain 데코레이터</a></p>\n</li>\n<li>\n<p><a href=\"#helper-%ED%95%A8%EC%88%98%EC%99%80-wrapper-%ED%95%A8%EC%88%98\">Helper 함수와 Wrapper 함수</a></p>\n</li>\n<li>\n<p><a href=\"#configurable\">Configurable</a></p>\n<ul>\n<li><a href=\"#%EB%8F%99%EC%A0%81-%EB%B3%80%EA%B2%BD%EC%9D%84-%ED%97%88%EC%9A%A9%ED%95%A0-%EC%86%8D%EC%84%B1runnable-%EB%8C%80%EC%95%88-%EC%A0%95%EC%9D%98%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\">동적 변경을 허용할 ‘속성/Runnable 대안’ 정의하는 방법</a></li>\n<li><a href=\"#%EC%86%8D%EC%84%B1%EC%9D%84-%EB%B3%80%EA%B2%BD%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\">속성을 변경하는 방법</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#route\">Route</a></p>\n<ul>\n<li><a href=\"#runnablelambda%EC%97%90%EC%84%9C-routing\"><code class=\"language-text\">RunnableLambda</code>에서 Routing</a></li>\n<li><a href=\"#runnablebranch%EC%97%90%EC%84%9C-routing\"><code class=\"language-text\">RunnableBranch</code>에서 Routing</a></li>\n</ul>\n</li>\n</ul>\n</div>","excerpt":"참고 : 테디노트의 RAG 비법노트 (https://fastcampus.co.kr/data_online_teddy)소스코드: https://github.com/teddylee777/langchain-kr위키독스: https://wikidocs.net/book/14314   오늘은 정말 뜬금없이 갖가지 내용들을 끄적이고자 합니다..@chain 데코레이터, Configurable, Route 등에 대해 정리하고자 합니다. 레츠기릿   @chain 데코레이터 으로 가져와서 데코레이터를 이용해 함수를 으로 변환하도록 합시다. 즉, 은  객체이기 때문에 LCEL 인터페이스에 따라  메서드 등을 활용할 수 있습니다. chain.get_graph().print_ascii()로 체인의 그래프 출력 가능( 그래프 그리는 라이브러리 설치해야 함) 로 체인의 프롬프트 확인 가능 Helper 함수와 Wrapper 함수 Configurable 에 로 전달하는 딕셔너리()에서 주로 쓰는 약속된 키가 몇 가…","frontmatter":{"date":"January 13, 2026","title":"[LLM] 테디노트의 RAG 비법노트 끄적끄적-13","categories":"LLM RAG","author":"변우중","emoji":"☀️"},"fields":{"slug":"/26-01-13_1/"}},"next":{"id":"73d60c32-da40-5d8c-adea-c9b7352ed91c","html":"<p>참고 : 테디노트의 RAG 비법노트 (<a href=\"https://fastcampus.co.kr/data_online_teddy)\">https://fastcampus.co.kr/data_online_teddy)</a><br>소스코드: <a href=\"https://github.com/teddylee777/langchain-kr\">https://github.com/teddylee777/langchain-kr</a><br>위키독스: <a href=\"https://wikidocs.net/book/14314\">https://wikidocs.net/book/14314</a></p>\n<p> </p>\n<p>오랜만에 왔습니다!! (열심히 공부하고 왔습니다 🫡)</p>\n<p>Text Embedding와 Vectorstore, Retriver, Reranker는 워낙 모델이 많아서 모두 각각 정리하는 것보다는<br>RAG 개발 시 각 단계별로 고려할 점들을 정리해보는 것이 좋지 않을까 해서 가져왔습니다.</p>\n<p>고럼,, 레츠기릿~!</p>\n<p> </p>\n<h2 id=\"rag-개발-단계별-고려할-점\" style=\"position:relative;\"><a href=\"#rag-%EA%B0%9C%EB%B0%9C-%EB%8B%A8%EA%B3%84%EB%B3%84-%EA%B3%A0%EB%A0%A4%ED%95%A0-%EC%A0%90\" aria-label=\"rag 개발 단계별 고려할 점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RAG 개발 단계별 고려할 점</h2>\n<hr>\n<p>각 단계에서 고려할 점들을 제 생각대로 정리해보았습니다. 떠오르는 부분들만 적어두었는데, 추가적으로 고려할 점들이 있다면 알려주시면 감사하겠습니다 😊</p>\n<h3 id=\"1-데이터-로드\" style=\"position:relative;\"><a href=\"#1-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%A1%9C%EB%93%9C\" aria-label=\"1 데이터 로드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. <strong>데이터 로드</strong></h3>\n<ul>\n<li>데이터에 따라 로드 방식 설정</li>\n<li>PDF 등의 이미지의 문서의 경우 텍스트 OCR 모델 선정</li>\n</ul>\n<p> </p>\n<h3 id=\"2-텍스트-데이터-임베딩하면서-벡터스토어에-저장\" style=\"position:relative;\"><a href=\"#2-%ED%85%8D%EC%8A%A4%ED%8A%B8-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%9E%84%EB%B2%A0%EB%94%A9%ED%95%98%EB%A9%B4%EC%84%9C-%EB%B2%A1%ED%84%B0%EC%8A%A4%ED%86%A0%EC%96%B4%EC%97%90-%EC%A0%80%EC%9E%A5\" aria-label=\"2 텍스트 데이터 임베딩하면서 벡터스토어에 저장 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. <strong>텍스트 데이터 임베딩하면서 벡터스토어에 저장</strong></h3>\n<ul>\n<li>\n<p>이미지, 오디오, 비디오 등 데이터는 텍스트화 해놓은 것이 좋음</p>\n</li>\n<li>\n<p><strong>임베딩 모델 선정</strong>: <strong>임베딩 차원 수, 언어</strong> 등을 고려해야 합니다.</p>\n</li>\n<li>\n<p><strong>벡터스토어 선정</strong>: <strong>메타필터링</strong> 등 검색 시 기능들을 확인해야 합니다.</p>\n</li>\n<li>\n<p><strong>문서 요약을 넣을 것인지, 넣는다면 방법은?</strong><br>: ”<strong>나의 문서 요약이 검색에 활용하는 것이 좋은 방법인지</strong>“를 판단해야 합니다.</p>\n<ul>\n<li>\n<p><strong>요약 활용 방법</strong>: 문서를 다양한 방식으로 요약하여, 그 요약들을 벡터스토어에 함께 넣을 수 있습니다. <strong><code class=\"language-text\">MultiVectorRetriever</code></strong>는 요약된 텍스트의 원본 문서를 <code class=\"language-text\">docstore</code>에 지정하면서 <strong>검색된 문서가 요약된 텍스트이었을 때 해당 원본 문서를 가져오게끔</strong> 할 수도 있습니다.</p>\n</li>\n<li>\n<p><strong>요약 방식</strong>:</p>\n<ul>\n<li>\n<p><strong>단순히 청크별 요약</strong>하는 방식</p>\n</li>\n<li>\n<p><strong>RAPTOR</strong>(Recursive Abstractive Processing For Tree-Organized Retrieval) 활용</p>\n<blockquote>\n<p>유사한 청크들을 묶어 요약을 한 후<br>요약 텍스트들에서 유사한 것들을 묶어 <strong>재귀적으로 요약</strong>하는 방법</p>\n</blockquote>\n<p>개인적으로는</p>\n<blockquote>\n<p><strong>구조적인 문서(전체 내용이 논리적인 구조인 논문 등)에는 유리하지만<br>시계열 문서(대화 등)에는 어울리지 않는 방법</strong>이라 생각합니다.</p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p> </p>\n<h3 id=\"3-청킹-방식방법길이-설정\" style=\"position:relative;\"><a href=\"#3-%EC%B2%AD%ED%82%B9-%EB%B0%A9%EC%8B%9D%EB%B0%A9%EB%B2%95%EA%B8%B8%EC%9D%B4-%EC%84%A4%EC%A0%95\" aria-label=\"3 청킹 방식방법길이 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. <strong>청킹 방식/방법/길이 설정</strong></h3>\n<ul>\n<li><strong>청킹 방식</strong>: <strong>데이터와 retriever에 따라 결정</strong>\n<ul>\n<li>어떤 식으로 메타데이터를 구축 해놓을지</li>\n<li>부모/자식 문서 검색(청크를 더 쪼개어 자식 청크에서 부모 청크 찾음) 방법을 활용할지</li>\n<li>멀티벡터 검색(요약 등 다양한 형태 데이터를 만들어서 부모 청크 찾음) 방법을 활용할지 등등</li>\n</ul>\n</li>\n<li><strong>청킹 방법</strong>: <strong>Splitter 선정</strong>\n<ul>\n<li>재귀적으로 문자 단위를 분할할지</li>\n<li>토큰화 모델을 활용할지</li>\n<li>시맨틱 분할, 코드/마크다운/JSON 등 전용 분할 등등</li>\n</ul>\n</li>\n<li><strong>청크 길이</strong>: <strong>어느 정도 길이로 분할하는 것이 서로 유사한 정도가 잘 나올지 판단</strong><br>(검색은 쿼리와 데이터 각각 임베딩한 것을 바탕으로 유사한 것을 가져오는 bi-encoder 방식이기 때문에 청크 길이가 중요합니다.)</li>\n</ul>\n<p> </p>\n<h3 id=\"4-벡터스토어에서-retriever-설정\" style=\"position:relative;\"><a href=\"#4-%EB%B2%A1%ED%84%B0%EC%8A%A4%ED%86%A0%EC%96%B4%EC%97%90%EC%84%9C-retriever-%EC%84%A4%EC%A0%95\" aria-label=\"4 벡터스토어에서 retriever 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. <strong>벡터스토어에서 retriever 설정</strong></h3>\n<ul>\n<li>\n<p>Retriever는 쿼리와 문서를 각각 독립적으로 벡터화(Bi-encoder)하여<br>유사도(Dense)나 키워드 중요도(Sparse)를 계산해 원하는 정보를 찾아옵니다. <br>(리랭커보단 보통 빠른 방식임)</p>\n</li>\n<li>\n<p><strong>검색 방식</strong>: ”<strong>어떤 벡터를 쓸 것인가?</strong> (데이터에 따라 결정)</p>\n<ul>\n<li>\n<p><strong>Dense 검색</strong>(밀집 검색): ⭐️ <strong>의미적 검색</strong>할 때 사용 ⭐️</p>\n<ul>\n<li>보통 <strong>cosine 유사도</strong>로 점수 계산, 유클리드 거리, 내적 등도 존재</li>\n<li>문서의 임베딩 벡터와 쿼리의 임베딩 벡터 사이의 유사도를 계산함</li>\n</ul>\n</li>\n<li>\n<p><strong>Sparse 검색</strong>(희소 검색): ⭐️ <strong>키워드 검색</strong>할 때 사용 ⭐️</p>\n<ul>\n<li>\n<p>보통 TF-IDF, <strong>BM25</strong> 알고리즘으로 점수 계산</p>\n</li>\n<li>\n<p>문서의 <strong>토큰별 중요도(TF-IDF/BM25 가중치)</strong>가 미리 계산된 벡터(인덱스)와<br>쿼리의 <strong>토큰 존재 여부</strong>를 <strong>매칭(내적)</strong>하여 최종 점수를 계산함</p>\n<blockquote>\n<p><strong>“쿼리 단어(키워드)가 저 문서 벡터에 얼마나 중요하게(높은 점수로) 박혀있는가?”</strong>를 계산</p>\n</blockquote>\n</li>\n<li>\n<p>BM25은 문서 길이 길면 점수 페널티도 추가함</p>\n</li>\n</ul>\n</li>\n<li>\n<p>⭐️ <strong>Hybrid 검색</strong>: <strong>Dense + Sparse 결합</strong> ⭐️</p>\n<ul>\n<li>보통 <strong>RRF (Reciprocal Rank Fusion)</strong> 알고리즘을 사용 ⭐️</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><strong>결과 정제 및 선택</strong>: ”<strong>가져온 걸 어떻게 골라낼 것인가?</strong>”</p>\n<ul>\n<li><strong>유사한 k개 단순히 선정</strong></li>\n<li><strong>MMR(Maximum Marginal Relevance)</strong> 알고리즘을 이용하여 선정\n<ul>\n<li><strong>유사성 + ‘다양성’을 모두 고려하는 방식</strong></li>\n<li>즉, <strong>유사한 k개 먼저 가져오고, 그 k개 사이에서 다양하게 최종 선택하는 방법</strong> (서로 너무 유사한 것은 제외함)</li>\n<li>최대한 서로 유사한 내용들은 제외하고, 쿼리와 관련한 내용을 다양하게 가져오고 싶을 때 이용함</li>\n</ul>\n</li>\n<li>설정한 임계값 이상인 것들만 선정 등등</li>\n</ul>\n</li>\n</ul>\n<p> </p>\n<h3 id=\"5-reranker-선정\" style=\"position:relative;\"><a href=\"#5-reranker-%EC%84%A0%EC%A0%95\" aria-label=\"5 reranker 선정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. <strong>Reranker 선정</strong></h3>\n<ul>\n<li>\n<p>Reranker 모델은 Retriever와 적절히 조정하여 비용 &#x26; 성능 개선이 필요합니다.</p>\n<ul>\n<li>빠르게 많은 양을 검색해오고, 정확하게 리랭킹하는 방법</li>\n<li>Hybrid Search로 정밀하게 검색해오고, 가벼운 모델 사용 또는 키워드 매칭 정도로 리랭킹</li>\n</ul>\n<p>등등.. 시간, 경제적 비용과 성능 등을 고려하면서 정하면 됩니다.</p>\n</li>\n<li>\n<p><strong>표준 (Cross-encoder) 방법</strong></p>\n<ul>\n<li>쿼리와 문서를 하나로 결합해 <strong>Transformer의 Full Self-Attention</strong>을 수행하며, 문맥을 완벽히 파악한 뒤 **관련성 확률(Score)**을 직접 추론합니다. (속도는 느리지만 정확도 최고!!)</li>\n<li>즉, <strong>보통의 Reranker는 쿼리와 문서를 쌍으로 묶어 동시에 인코딩(Cross-encoder)한 후, 쿼리 각 토큰과 문서의 토큰들 사이의 관련성 점수를 계산하면서(Full Attention) 순위를 재조정합니다(느리지만 정확함).</strong></li>\n</ul>\n</li>\n<li>\n<p><strong>Late Interaction (예: ColBERT) 방법</strong>- 경량화 방법</p>\n<ul>\n<li>\n<p>쿼리와 문서를 <strong>독립적으로 임베딩</strong>한 뒤<br>마지막 단계에서 <strong>토큰별 최대 유사도(MaxSim)</strong>만 빠르게 계산하여 합산합니다.</p>\n<blockquote>\n<p><strong>Bi-encoder의 빠른 속도 + Cross-encoder의 높은 정확성</strong>을 가진 방법입니다.</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>\n<p><strong>무료 오픈소스 Reranker 모델</strong></p>\n<ul>\n<li>\n<p><strong><code class=\"language-text\">BAAI/bge-reranker-v2-m3</code></strong>: 성능이 좋고, 유명함 ⭐️</p>\n</li>\n<li>\n<p><strong><code class=\"language-text\">FlashrankRerank</code> 모델</strong>( <code class=\"language-text\">ms-marco-MultiBERT-L-12</code> 등)<br>: <strong>Cross-encoder 방식이지만, 속도가 빠른 모델</strong></p>\n<ul>\n<li>\n<p>FlashrankRerank에서 MultiBERT 모델은 한국어도 지원합니다.</p>\n<p><a href=\"https://github.com/PrithivirajDamodaran/FlashRank\">FlashRank Github</a></p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 77.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABYlAAAWJQFJUiTwAAADC0lEQVQ4y02U2XrbNhCFedk0lkRxEwmQBPd9025JlmM7zubctS/Q93+J084ozteL84EAiBnwPzPUPi5szJYrlO0aZbtB0Uw8J9GeF6Rohh266cDPf84tmKuA358b7u+zUdbgTneg2Z6Cyhq00wHD9oRpf0GQVDAcHwvTg+snSIqOZa5CPkQBo7zF3PQwNwVkVMINMg6u5fWEol1DhBkHjosOQVxCtyWkylF1G84eJhXuFjbfmt5Ny/4WPNrATE9Yhrcv08KUggyI8p5HlXUI0xbGKoSMKl5L6wleWEC3fRiugiNT3rNFDFNksPwClsz5jNZtzhj3j6jHI5r1Cc10QtHvYcsM3eaC17e/cXl+w/n5B6rhAEukiMsJ29MzRFRB1A8Ixq/w20fYMoXmyJgzWZ6CsQpwp68wM1zmQ7cvuy2PWT3BkQkWpmCWXpjxOX0VwfBSLN0YC0tCow1yN6tGxHmLP+4MZkVuEqfjwwubdbp+ZnYfZiYsN0TdbyFVBt3vYecnmGrCjFwmHn5cI0gaVlKNPBpuhKjoUY8HNOOR2ZpeBMuLWboTwnQjWDJjfiSaa8Rpd37BsLsyy935M+rxHqZI0K5PeP35Fx5e3rA9v8ASCUvlAy7PP5C3G8jhO9LrPwiGL7C8CJpQJXQnwMwQvzW3bm5m9RrnT9/Qb86c3aTbCWKe3CQTrOIRXnEPJ+pgugraSibI6pFVdjeWaTlwUVPtUZes9xdQveqW4HUSdQlpKQoYfoOlKG91aIsIUhUQKucOkdHtmVymORlS9zt06yM2x0deo0r4qDucwPRrWNEI0284kabyHlSLxLIajlxrxFDGDfJ2i/PTd4z7K9bHT/BUyWbF5Yhmuue68/I9RHWBVxwYg+YGOXcGidx9d5z4xOXADttsxo0dsRRRCZV37LajWjjxCEf9YijCnNlRP7+zJI5U5CptsDs94f76isvTN+51qk9i9z4aQQ8r2cEI+xtDy1XMjX4EVLjeL+mWZLbddERSDminI9wg5R/C/03R3RRLWUH3Msz/C/gv/kO+h4r6d3AAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"img 1\" title=\"img 1\" src=\"/static/5ef07e554d875b76f562c2ebb9b207e9/37523/img_1.png\" srcset=\"/static/5ef07e554d875b76f562c2ebb9b207e9/e9ff0/img_1.png 180w,\n/static/5ef07e554d875b76f562c2ebb9b207e9/f21e7/img_1.png 360w,\n/static/5ef07e554d875b76f562c2ebb9b207e9/37523/img_1.png 720w,\n/static/5ef07e554d875b76f562c2ebb9b207e9/587b0/img_1.png 970w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</li>\n<li>\n<p><strong>Cross-encoder인데, 어떻게 빠른가?</strong></p>\n<p><strong>실행 환경(Runtime)과 최적화 기법(Optimization)</strong>의 차이 때문입니다.<br><strong><code class=\"language-text\">ms-marco</code> 모델들은 <code class=\"language-text\">MiniLM</code> 아키텍처를 기반으로 합니다.</strong></p>\n<blockquote>\n<p>Teacher 모델(BERT Large 등)의 지식을 <strong>지식 증류(Knowledge Distillation)</strong> 기법을 활용해 학습함으로써 <strong>파라미터 수와 연산량을 줄였습니다.</strong></p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th><strong>비교 항목</strong></th>\n<th><strong>기존 Cross-Encoder (PyTorch)</strong></th>\n<th><strong>FlashRank (ONNX)</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>연산 정밀도</strong></td>\n<td>Float32 (무거움)</td>\n<td><strong>Int8 (가벼움)</strong></td>\n</tr>\n<tr>\n<td><strong>실행 엔진</strong></td>\n<td>PyTorch (Eager execution)</td>\n<td><strong>ONNX Runtime (Graph optimized)</strong></td>\n</tr>\n<tr>\n<td><strong>의존성</strong></td>\n<td>Torch, Transformers (수 GB)</td>\n<td><strong>Numpy, Onnxruntime (수 MB)</strong></td>\n</tr>\n<tr>\n<td><strong>하드웨어</strong></td>\n<td>GPU 권장</td>\n<td><strong>CPU에서도 매우 빠름</strong></td>\n</tr>\n<tr>\n<td><strong>용도</strong></td>\n<td>연구 및 고성능 학습용</td>\n<td><strong>실서비스 배포(Inference)용</strong></td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>\n<p><strong>실제로 사용했을 때, 어떠했는지?</strong><br>: 개인적으로는.. 우선 속도는 매우 빨랐지만 성능이 기대한만큼 나오지 않았습니다.</p>\n<p>다만!! 성능이 좋지 않게 나왔던 이유를 생각해봤을 때</p>\n<blockquote>\n<p><strong>청크를 쪼개는 방식의 문제였거나</strong> (여러 내용이 섞이지 않도록 더 잘게 또는 헤더를 이용한 청킹 방식 채택하는 것이 좋았을 듯)</p>\n<p><strong>한국어 성능이 생각보다 좋지 않은 모델이었거나</strong></p>\n<p><strong>키워드가 중요한 쿼리였는데, 의미적으로 비슷한 내용들이 많은 문서가 있었거나</strong><br>(하지만 이것은 검색된 충분한 문서를 LLM에게 쥐어줘서 답변하게끔 하면 될 것 같습니다.)</p>\n</blockquote>\n<p>이정도로 생각이 드네요.</p>\n<p>하지만, <strong>CPU로도 돌아갈 정도로 경량화되고 빠른 모델</strong> 장점은 포기 못합니다.. ㅎㅎ</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<p> </p>\n<p> </p>\n<p>다음 글에서는</p>\n<p>프로젝트에서 RAG 개발하면서 고민했던 점을 담아서 얘기를 할 것 같습니다.<br>(그렇지만 또 남기고 싶은 얘기가 있다면 그 얘기를 쓸지도…?)</p>\n<p>암튼 오늘도 봐주셔서 감사합니다 빠잇~!</p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#rag-%EA%B0%9C%EB%B0%9C-%EB%8B%A8%EA%B3%84%EB%B3%84-%EA%B3%A0%EB%A0%A4%ED%95%A0-%EC%A0%90\">RAG 개발 단계별 고려할 점</a></p>\n<ul>\n<li><a href=\"#1-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EB%A1%9C%EB%93%9C\">1. <strong>데이터 로드</strong></a></li>\n<li><a href=\"#2-%ED%85%8D%EC%8A%A4%ED%8A%B8-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%9E%84%EB%B2%A0%EB%94%A9%ED%95%98%EB%A9%B4%EC%84%9C-%EB%B2%A1%ED%84%B0%EC%8A%A4%ED%86%A0%EC%96%B4%EC%97%90-%EC%A0%80%EC%9E%A5\">2. <strong>텍스트 데이터 임베딩하면서 벡터스토어에 저장</strong></a></li>\n<li><a href=\"#3-%EC%B2%AD%ED%82%B9-%EB%B0%A9%EC%8B%9D%EB%B0%A9%EB%B2%95%EA%B8%B8%EC%9D%B4-%EC%84%A4%EC%A0%95\">3. <strong>청킹 방식/방법/길이 설정</strong></a></li>\n<li><a href=\"#4-%EB%B2%A1%ED%84%B0%EC%8A%A4%ED%86%A0%EC%96%B4%EC%97%90%EC%84%9C-retriever-%EC%84%A4%EC%A0%95\">4. <strong>벡터스토어에서 retriever 설정</strong></a></li>\n<li><a href=\"#5-reranker-%EC%84%A0%EC%A0%95\">5. <strong>Reranker 선정</strong></a></li>\n</ul>\n</li>\n</ul>\n</div>","frontmatter":{"date":"January 11, 2026","title":"[LLM] 테디노트의 RAG 비법노트 끄적끄적-12 (RAG 개발 고려할 점)","categories":"LLM RAG","author":"변우중","emoji":"☀️"},"fields":{"slug":"/26-01-11_1/"}},"prev":{"id":"9873a81c-6667-5bd3-856c-57c33af2f27a","html":"<p>참고 : 테디노트의 RAG 비법노트 (<a href=\"https://fastcampus.co.kr/data_online_teddy)\">https://fastcampus.co.kr/data_online_teddy)</a><br>소스코드: <a href=\"https://github.com/teddylee777/langchain-kr\">https://github.com/teddylee777/langchain-kr</a><br>위키독스: <a href=\"https://wikidocs.net/book/14314\">https://wikidocs.net/book/14314</a></p>\n<p> </p>\n<p>글이 자주 올라오지 않는 것은<br>RAG와 Agent의 내용들은 프로젝트에 녹여서 끄적이고자 그렇습니다,,</p>\n<p>오늘은 아아아주 정말 메모장st 느낌의 글입니다. 다소 짧고 구조적이지 않습니다.</p>\n<p>레츠기릿,,</p>\n<p> </p>\n<h2 id=\"create_sql_query_chain\" style=\"position:relative;\"><a href=\"#create_sql_query_chain\" aria-label=\"create_sql_query_chain permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>create_sql_query_chain</h2>\n<hr>\n<p>DB에서 특정 값을 조회하기 위한 SQL 쿼리를 생성하고, 쿼리를 실행하는 방법에 대해 정리하고자 합니다.</p>\n<p>간단합니다.</p>\n<ol>\n<li>\n<p>SQL 쿼리를 생성하는 chain 생성 (DB를 연결하고, 쿼리 생성하는 LLM 선정)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>prompts <span class=\"token keyword\">import</span> PromptTemplate\n\ndb <span class=\"token operator\">=</span> SQLDatabase<span class=\"token punctuation\">.</span>from_uri<span class=\"token punctuation\">(</span><span class=\"token string\">\"sqlite:///data/my_db.db\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># db의 dialect(어떤 db인지), 사용자 입력, 컬럼 설명 등을 넣음</span>\nprompt <span class=\"token operator\">=</span> PromptTemplate<span class=\"token punctuation\">.</span>from_template<span class=\"token punctuation\">(</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Given an input question, first create a syntactically correct {dialect} query to run, then look at the results of the query and return the answer. Unless the user specifies in his question a specific number of examples he wishes to obtain, always limit your query to at most {top_k} results. You can order the results by a relevant column to return the most interesting examples in the database.\nUse the following format:\n\nQuestion: \"Question here\"\nSQLQuery: \"SQL Query to run\"\nSQLResult: \"Result of the SQLQuery\"\nAnswer: \"Final answer here\"\n\nOnly use the following tables:\n{table_info}\n\nHere is the description of the columns in the tables:\n`컬럼1`: 컬럼 설명\n`컬럼2`: 컬럼 설명\n`컬럼3`: 컬럼 설명\n\nQuestion: {input}\"\"\"</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>partial<span class=\"token punctuation\">(</span>dialect<span class=\"token operator\">=</span>db<span class=\"token punctuation\">.</span>dialect<span class=\"token punctuation\">)</span> <span class=\"token comment\"># db.dialect 넣음!!</span>\n\n<span class=\"token comment\"># sql 쿼리 생성 모델</span>\nllm <span class=\"token operator\">=</span> ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">,</span> temperature<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># LLM, DB, prompt를 매개변수로 입력하여 chain 을 생성합니다.</span>\n<span class=\"token comment\"># ⭐️ prompt는 직접 넣어서 변경 가능함 ⭐️</span>\ncreate_query_chain <span class=\"token operator\">=</span> create_sql_query_chain<span class=\"token punctuation\">(</span>llm<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">,</span> prompt<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 생성된 쿼리를 출력하기</span>\nanswer <span class=\"token operator\">=</span> create_query_chain<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"question\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"고객의 이름을 나열하세요\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>answer<span class=\"token punctuation\">.</span>__repr__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n</li>\n<li>\n<p>쿼리를 실행하는 도구 생성</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_community<span class=\"token punctuation\">.</span>tools<span class=\"token punctuation\">.</span>sql_database<span class=\"token punctuation\">.</span>tool <span class=\"token keyword\">import</span> QuerySQLDataBaseTool\n\n<span class=\"token comment\"># 생성한 쿼리를 실행하기 위한 도구 생성</span>\nexecute_query <span class=\"token operator\">=</span> QuerySQLDataBaseTool<span class=\"token punctuation\">(</span>db<span class=\"token operator\">=</span>db<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>두 체인 연결</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">chain <span class=\"token operator\">=</span> create_query_chain <span class=\"token operator\">|</span> execute_query\nchain<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"question\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"민수의 이메일을 조회하세요\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>create_query_chain의 결과가 execute_query의 query 변수에 들어가서 db에 조회합니다.</li>\n</ul>\n</li>\n</ol>\n<p> </p>\n<p> </p>\n<h2 id=\"추가-메모장\" style=\"position:relative;\"><a href=\"#%EC%B6%94%EA%B0%80-%EB%A9%94%EB%AA%A8%EC%9E%A5\" aria-label=\"추가 메모장 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>추가 메모장</h2>\n<hr>\n<ol>\n<li>\n<p>retriever를 그냥 호출하게 되면 page_content만 반환하므로, LLM에게 줄 추가적인 메타데이터는 프롬프트 템플릿을 통해 넣어야 한다.</p>\n</li>\n<li>\n<p>LangGraph에서 Reducer(add_messages, operator.add): 자동으로 리스트에 메시지를 추가해주는 기능</p>\n</li>\n<li>\n<p>TypedDict: dict에 타입힌팅 추가한 개념</p>\n</li>\n<li>\n<p>LangGraph 기본 개념</p>\n</li>\n</ol>\n<ul>\n<li>\n<p>상태(State): 노드와 노드 간에 정보를 전달할 때 상태(State) 객체에 담아 전달함</p>\n</li>\n<li>\n<p>새로운 노드에서 값을 덮어쓰기 방식으로 채움</p>\n</li>\n<li>\n<p>GraphState 클래스를 TypedDict 클래스를 상속받아 보통 정의함</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> Annotated<span class=\"token punctuation\">,</span> TypedDict\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph<span class=\"token punctuation\">.</span>message <span class=\"token keyword\">import</span> add_messages\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">GraphState</span><span class=\"token punctuation\">(</span>TypedDict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    question<span class=\"token punctuation\">:</span> Annotated<span class=\"token punctuation\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">,</span> add_messages<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 질문</span>\n    context<span class=\"token punctuation\">:</span> Annotated<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Context\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 문서의 검색 결과</span>\n    answer<span class=\"token punctuation\">:</span>  Annotated<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Answer\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 답변</span>\n    messages<span class=\"token punctuation\">:</span> Annotated<span class=\"token punctuation\">(</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">,</span> add_messages<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 메시지</span>\n    relevance<span class=\"token punctuation\">:</span> Annotated<span class=\"token punctuation\">(</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"relevance\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 관련성</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">question</code>, <code class=\"language-text\">messages</code>는 <code class=\"language-text\">Annotated(list, add_messages)</code>를 통해 리스트에 메시지를 계속 추가함</li>\n<li>다른 것들은 덮어쓰기로 상태를 저장함</li>\n</ul>\n</li>\n<li>\n<p>기본 구조</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> Annotated<span class=\"token punctuation\">,</span> List<span class=\"token punctuation\">,</span> Dict\n<span class=\"token keyword\">from</span> typing_extensions <span class=\"token keyword\">import</span> TypedDict\n\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>tools <span class=\"token keyword\">import</span> tool\n<span class=\"token keyword\">from</span> langchain_openai <span class=\"token keyword\">import</span> ChatOpenAI\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>checkpoint<span class=\"token punctuation\">.</span>memory <span class=\"token keyword\">import</span> MemorySaver\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph <span class=\"token keyword\">import</span> StateGraph<span class=\"token punctuation\">,</span> START<span class=\"token punctuation\">,</span> END\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph<span class=\"token punctuation\">.</span>message <span class=\"token keyword\">import</span> add_messages\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>prebuilt <span class=\"token keyword\">import</span> ToolNode<span class=\"token punctuation\">,</span> tools_condition\n<span class=\"token keyword\">from</span> langchain_teddynote<span class=\"token punctuation\">.</span>graphs <span class=\"token keyword\">import</span> visualize_graph\n<span class=\"token keyword\">from</span> langchain_teddynote<span class=\"token punctuation\">.</span>tools <span class=\"token keyword\">import</span> GoogleNews\n\n\n<span class=\"token number\">1.</span> 상태 정의\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">State</span><span class=\"token punctuation\">(</span>TypedDict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 메시지 목록 주석 추가</span>\n    messages<span class=\"token punctuation\">:</span> Annotated<span class=\"token punctuation\">[</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">,</span> add_messages<span class=\"token punctuation\">]</span>\n    dummy_data<span class=\"token punctuation\">:</span> Annotated<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dummy\"</span><span class=\"token punctuation\">]</span>\n\n\n<span class=\"token comment\"># 2. 도구 정의 및 바인딩</span>\n<span class=\"token comment\"># 도구 초기화 (키워드로 뉴스 검색하는 도구 생성)</span>\nnews_tool <span class=\"token operator\">=</span> GoogleNews<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token decorator annotation punctuation\">@tool</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">search_keyword</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> List<span class=\"token punctuation\">[</span>Dict<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Look up news by keyword\"\"\"</span>\n    news_tool <span class=\"token operator\">=</span> GoogleNews<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> news_tool<span class=\"token punctuation\">.</span>search_by_keyword<span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">,</span> k<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n\n\ntools <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>search_keyword<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># LLM 초기화</span>\nllm <span class=\"token operator\">=</span> ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 도구와 LLM 결합</span>\nllm_with_tools <span class=\"token operator\">=</span> llm<span class=\"token punctuation\">.</span>bind_tools<span class=\"token punctuation\">(</span>tools<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 3. 노드 추가</span>\n<span class=\"token comment\"># 챗봇 함수 정의</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">chatbot</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 메시지 호출 및 반환</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>llm_with_tools<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"dummy_data\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"[chatbot] 호출, dummy data\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 테스트 위해 더미 데이터 추가</span>\n    <span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># 상태 그래프 생성</span>\ngraph_builder <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>State<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 챗봇 노드 추가</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">,</span> chatbot<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 도구 노드 생성 및 추가</span>\ntool_node <span class=\"token operator\">=</span> ToolNode<span class=\"token punctuation\">(</span>tools<span class=\"token operator\">=</span>tools<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 도구 노드 추가</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span> tool_node<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 조건부 엣지</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_conditional_edges<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">,</span>\n    tools_condition<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 4. 엣지 추가</span>\n\n<span class=\"token comment\"># tools > chatbot</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># START > chatbot</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># chatbot > END</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">,</span> END<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 5. 그래프 컴파일</span>\n\n<span class=\"token comment\"># 그래프 빌더 컴파일</span>\ngraph <span class=\"token operator\">=</span> graph_builder<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">########## 6. 그래프 시각화 ##########</span>\n<span class=\"token comment\"># 그래프 시각화</span>\nvisualize_graph<span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ul>\n<ol start=\"5\">\n<li>stream 노드 단계별 출력</li>\n</ol>\n<p>그래프를 stream 메서드를 이용하여 각 노드별 실행 결과를 for 문을 이용해 받아와서 출력을 할 수 있습니다. 각 노드별 <code class=\"language-text\">key</code>(노드 이름)와 <code class=\"language-text\">value</code>(상태 결과)를 받아올 수 있으며, 이때 stream 메서드에 매개변수 값을 넣어 값을 받아오기 위한 다양한 설정을 할 수 있습니다.</p>\n<ul>\n<li>\n<p><code class=\"language-text\">input</code>: 그래프 입력</p>\n</li>\n<li>\n<p><code class=\"language-text\">config</code>: 설정 값(<code class=\"language-text\">recursion_limit</code>, <code class=\"language-text\">configurable</code>(thread_id 등), <code class=\"language-text\">tags</code>)</p>\n</li>\n<li>\n<p><code class=\"language-text\">list(graph.channels.keys())</code>: 그래프의 모든 채널 키를 가져옴</p>\n</li>\n<li>\n<p><code class=\"language-text\">stream_mode</code> : **“그래프가 실행되는 동안, 어떤 데이터를 뱉어낼 것인가?”**를 결정하는 옵션입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token builtin\">input</span> <span class=\"token operator\">=</span> State<span class=\"token punctuation\">(</span>dummy_data<span class=\"token operator\">=</span><span class=\"token string\">\"테스트 문자열\"</span><span class=\"token punctuation\">,</span> messages<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> question<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nconfig <span class=\"token operator\">=</span> RunnableConfig<span class=\"token punctuation\">(</span>\n    recursion_limit<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 최대 10개의 노드까지 방문</span>\n    configurable<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"thread_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 스레드 ID 설정</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 2. output_keys에 모든 키를 전달하여 실행합니다.</span>\n<span class=\"token keyword\">for</span> event <span class=\"token keyword\">in</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">input</span><span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">,</span>\n    config<span class=\"token operator\">=</span>config<span class=\"token punctuation\">,</span>\n    stream_mode<span class=\"token operator\">=</span><span class=\"token string\">\"values\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 전체 상태를 스트리밍</span>\n    output_keys<span class=\"token operator\">=</span>all_channel_keys<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 여기에 모든 키 리스트를 넣습니다.</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> event<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"\\n[ </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>key<span class=\"token punctuation\">}</span></span><span class=\"token string\"> ]\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Type: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p>현재 상태(State)에 <code class=\"language-text\">messages</code> 리스트가 있고, <code class=\"language-text\">chatbot</code> 노드가 새로운 메시지를 하나 추가하는 상황이라고 가정해 봅시다.</p>\n</li>\n<li>\n<p>모드 값: <code class=\"language-text\">values</code>, <code class=\"language-text\">updates</code>(기본값), <code class=\"language-text\">debug</code>, <code class=\"language-text\">messages</code>, <code class=\"language-text\">checkpoints</code>, <code class=\"language-text\">tasks</code>, <code class=\"language-text\">custom</code></p>\n</li>\n<li>\n<p>상황 가정</p>\n<ul>\n<li><strong>현재 상태</strong>: <code class=\"language-text\">['안녕']</code></li>\n<li><strong>chatbot 노드 실행</strong>: <code class=\"language-text\">['반가워']</code>라는 메시지를 생성함</li>\n</ul>\n</li>\n<li>\n<p><strong><code class=\"language-text\">stream_mode=\"values\"</code> (전체 상태 모드)</strong><br></p>\n<p>이 모드는 **“노드가 실행된 후, 완성된 전체 상태(State)“**를 보여줍니다. 가장 최신 시점의 **“결과물 전체”**를 보고 싶을 때 사용합니다.</p>\n<ul>\n<li><strong>출력의 키(Key)</strong>: 상태 변수의 이름 (예: <code class=\"language-text\">messages</code>, <code class=\"language-text\">dummy_data</code>)</li>\n<li><strong>출력의 값(Value)</strong>: 해당 변수의 <strong>전체 누적 값</strong></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 예시 출력</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"안녕\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"반가워\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># &lt;-- 기존 값 + 새로운 값 모두 포함됨</span>\n    <span class=\"token string\">\"dummy_data\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"...\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p><strong>비유</strong>: 회의록을 작성할 때, **“회의록 전체 파일”**을 매번 새로 공유받는 것과 같습니다. (앞부분 내용 + 새로 추가된 내용 가 포함됨)</p>\n</blockquote>\n</li>\n<li>\n<p><strong> <code class=\"language-text\">stream_mode=\"updates\"</code> (업데이트 모드) - <em>기본값</em></strong><br></p>\n<p>이 모드는 **“방금 실행된 노드가 변경한 부분(차이점)“**만 보여줍니다. <strong>“누가(어떤 노드가) 무엇을 바꿨는지”</strong> 흐름을 파악할 때 좋습니다.</p>\n<ul>\n<li><strong>출력의 키(Key)</strong>: 방금 실행된 <strong>노드 이름</strong> (예: <code class=\"language-text\">chatbot</code>, <code class=\"language-text\">tools</code>)</li>\n<li><strong>출력의 값(Value)</strong>: 그 노드가 <strong>새로 만들어낸 값</strong></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 예시 출력</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>                 <span class=\"token comment\"># &lt;-- 노드 이름이 키가 됨</span>\n        <span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"반가워\"</span><span class=\"token punctuation\">]</span>    <span class=\"token comment\"># &lt;-- 이번에 '새로 추가된' 메시지만 있음 (\"안녕\"은 없음)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p><strong>비유</strong>: 회의록을 작성할 때, **“방금 추가된 줄”**만 메신저로 알림 받는 것과 같습니다.</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">interrupt_before</code>, <code class=\"language-text\">interrupt_after</code>,</p>\n<ul>\n<li>\n<p>특정 노드 전/후에 스트리밍을 중단합니다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">interrupt_before</code> 설정 방법 예시</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">for</span> event <span class=\"token keyword\">in</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">input</span><span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">,</span>\n    config<span class=\"token operator\">=</span>config<span class=\"token punctuation\">,</span>\n    stream_mode<span class=\"token operator\">=</span><span class=\"token string\">\"updates\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 기본값</span>\n    interrupt_before<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># ⭐️ tools 노드 이전에 스트리밍 중단 ⭐️</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></code></pre></div>\n</li>\n<li>\n<p>중단 후 재개 방법</p>\n<ul>\n<li>\n<p>추가 input 없을 때 (<code class=\"language-text\">input</code>에 <code class=\"language-text\">None</code>을 넣음)</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># None은 추가 input은 없는 것임</span>\ngraph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span><span class=\"token builtin\">input</span><span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> stream_mode<span class=\"token operator\">=</span><span class=\"token string\">\"updates\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>추가 input 있을 때 (input에 상태를 넣습니다.)</p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<ol start=\"6\">\n<li>\n<p><code class=\"language-text\">get_state(config)</code> 메서드</p>\n<ul>\n<li>\n<p>그래프의 현재 상태를 출력합니다. (config에는 현재 스레드 id 담겨 있음)<br>즉, 현재 상태 스냅샷 !!</p>\n</li>\n<li>\n<p><code class=\"language-text\">interrupt_before</code>, <code class=\"language-text\">interrupt_after</code>를 이용하여 특정 노드 전/후로 멈추고, 현재 상태와 다음 스냅샷 상태를 출력할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># ⭐️ 그래프 상태 스냅샷 생성 (현재 상태 값 출력) ⭐️</span>\nsnapshot <span class=\"token operator\">=</span> graph<span class=\"token punctuation\">.</span>get_state<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 다음 스냅샷 상태</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>snapshot<span class=\"token punctuation\">.</span><span class=\"token builtin\">next</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 현재 상태</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>snapshot<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># 현재 저장된 값</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>snapshot<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"출력:\n('tools',)\n====================\nStateSnapshot(values={'messages': [HumanMessage(content='AI 관련 최신 뉴스를 알려주세요.', additional_kwargs={}, response_metadata={}, id='884734b2-b0ef-4c0a-9f1c-5d48048b0887'), AIMessage(content='', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 51, 'total_tokens': 65, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_provider': 'openai', 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_1590f93f9d', 'id': 'chatcmpl-D4ibXNCTqMvmcGLczUIrtLZg3baly', 'service_tier': 'default', 'finish_reason': 'tool_calls', 'logprobs': None}, id='lc_run--019c1d3e-370e-7480-93ec-727278328647-0', tool_calls=[{'name': 'search_keyword', 'args': {'query': 'AI'}, 'id': 'call_apWmU6348h1ckdw4XdHfJjl5', 'type': 'tool_call'}], invalid_tool_calls=[], usage_metadata={'input_tokens': 51, 'output_tokens': 14, 'total_tokens': 65, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}, next=('tools',), config={'configurable': {'thread_id': '1', 'checkpoint_ns': '', 'checkpoint_id': '1f100086-2b66-65e0-8001-fe233ecc81d3'}}, metadata={'source': 'loop', 'step': 1, 'parents': {}}, created_at='2026-02-02T07:25:44.105514+00:00', parent_config={'configurable': {'thread_id': '1', 'checkpoint_ns': '', 'checkpoint_id': '1f100086-1c7b-66a2-8000-fe434acdd66f'}}, tasks=(PregelTask(id='ef6c6364-3daf-6960-d077-6bc3f717e3ef', name='tools', path=('__pregel_pull', 'tools'), error=None, interrupts=(), state=None, result=None),), interrupts=())\n====================\n{'messages': [HumanMessage(content='AI 관련 최신 뉴스를 알려주세요.', additional_kwargs={}, response_metadata={}, id='884734b2-b0ef-4c0a-9f1c-5d48048b0887'), AIMessage(content='', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 51, 'total_tokens': 65, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_provider': 'openai', 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_1590f93f9d', 'id': 'chatcmpl-D4ibXNCTqMvmcGLczUIrtLZg3baly', 'service_tier': 'default', 'finish_reason': 'tool_calls', 'logprobs': None}, id='lc_run--019c1d3e-370e-7480-93ec-727278328647-0', tool_calls=[{'name': 'search_keyword', 'args': {'query': 'AI'}, 'id': 'call_apWmU6348h1ckdw4XdHfJjl5', 'type': 'tool_call'}], invalid_tool_calls=[], usage_metadata={'input_tokens': 51, 'output_tokens': 14, 'total_tokens': 65, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}})]}\n\"\"\"</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>checkpoint 활용 방법 (중간 단계에서부터 다시 실행)</p>\n</li>\n</ol>\n<p>먼저 <strong>그래프의 채크포인터에 메모리 설정</strong>을 해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>checkpoint<span class=\"token punctuation\">.</span>memory <span class=\"token keyword\">import</span> MemorySaver\n\nmemory <span class=\"token operator\">=</span> MemorySaver<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ngraph <span class=\"token operator\">=</span> graph_builder<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>checkpointer<span class=\"token operator\">=</span>memory<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># ⭐️ 인메모리 설정하여 그래프 빌더 컴파일 ⭐️</span></code></pre></div>\n<p>그래프의 중간 단계별 출력을 위해 <strong><code class=\"language-text\">stream</code> 메서드</strong>로 출력합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_teddynote<span class=\"token punctuation\">.</span>messages <span class=\"token keyword\">import</span> pretty_print_messages\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables <span class=\"token keyword\">import</span> RunnableConfig\n\n<span class=\"token comment\"># 질문</span>\nquestion <span class=\"token operator\">=</span> <span class=\"token string\">\"AI 관련 최신 뉴스를 알려주세요.\"</span>\n\n<span class=\"token comment\"># 초기 입력 State 를 정의</span>\n<span class=\"token builtin\">input</span> <span class=\"token operator\">=</span> State<span class=\"token punctuation\">(</span>messages<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> question<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># config 설정</span>\nconfig <span class=\"token operator\">=</span> RunnableConfig<span class=\"token punctuation\">(</span>\n    recursion_limit<span class=\"token operator\">=</span><span class=\"token number\">10</span><span class=\"token punctuation\">,</span>\n    configurable<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"thread_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 스레드 ID 설정</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> event <span class=\"token keyword\">in</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">input</span><span class=\"token operator\">=</span><span class=\"token builtin\">input</span><span class=\"token punctuation\">,</span>\n    config<span class=\"token operator\">=</span>config<span class=\"token punctuation\">,</span>\n    stream_mode<span class=\"token operator\">=</span><span class=\"token string\">\"updates\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> event<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># key 는 노드 이름</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"\\n[</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>key<span class=\"token punctuation\">}</span></span><span class=\"token string\">]\\n\"</span></span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># value 는 노드의 출력값</span>\n        <span class=\"token comment\"># print(value)</span>\n        pretty_print_messages<span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># value 에는 state 가 dict 형태로 저장(values 의 key 값)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token string\">\"messages\"</span> <span class=\"token keyword\">in</span> value<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">[</span><span class=\"token string\">'messages'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p> </p>\n<p><strong>그래프의 <code class=\"language-text\">get_state_history(config)</code> 메서드를 for 문을 이용해 각 상태를 가져옵니다.</strong> <strong>여기서 특정 상태를 저장하고 싶은 곳에서 저장합니다 ‼️(여기서는 <code class=\"language-text\">to_replay</code>)</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">to_replay <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n\n<span class=\"token comment\"># 상태 기록 가져오기</span>\n<span class=\"token keyword\">for</span> state <span class=\"token keyword\">in</span> graph<span class=\"token punctuation\">.</span>get_state_history<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 메시지 수 및 다음 상태 출력</span>\n\n    <span class=\"token comment\"># ⭐️ 특정 상태 선택 기준: 채팅 메시지 수 ⭐️</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">3</span><span class=\"token punctuation\">:</span>\n        to_replay <span class=\"token operator\">=</span> state\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"현재 상태:\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"메시지 수: \"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"다음 노드: \"</span><span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">.</span><span class=\"token builtin\">next</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span> <span class=\"token operator\">*</span> <span class=\"token number\">80</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">continue</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"현재 상태:\"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">200</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"...(생략)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"메시지 수: \"</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"다음 노드: \"</span><span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">.</span><span class=\"token builtin\">next</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span> <span class=\"token operator\">*</span> <span class=\"token number\">80</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"출력:\n현재 상태: [HumanMessage(content='AI 관련 최신 뉴스를 알려주세요.', additional_kwargs={}, response_metadata={}, id='6bf41778-8525-44b4-bb27-0045d21b6258'), AIMessage(content='', additional_kwargs={'refusal': None}, response ...(생략)\n메시지 수:  4 다음 노드:  ()\n--------------------------------------------------------------------------------\n현재 상태: [HumanMessage(content='AI 관련 최신 뉴스를 알려주세요.', additional_kwargs={}, response_metadata={}, id='6bf41778-8525-44b4-bb27-0045d21b6258'), AIMessage(content='', additional_kwargs={'refusal': None}, response_metadata={'token_usage': {'completion_tokens': 14, 'prompt_tokens': 51, 'total_tokens': 65, 'completion_tokens_details': {'accepted_prediction_tokens': 0, 'audio_tokens': 0, 'reasoning_tokens': 0, 'rejected_prediction_tokens': 0}, 'prompt_tokens_details': {'audio_tokens': 0, 'cached_tokens': 0}}, 'model_provider': 'openai', 'model_name': 'gpt-4o-mini-2024-07-18', 'system_fingerprint': 'fp_1590f93f9d', 'id': 'chatcmpl-D4jKWuVxdrGKGEdxTrW4Pzsf1zNxC', 'service_tier': 'default', 'finish_reason': 'tool_calls', 'logprobs': None}, id='lc_run--019c1d68-c5b2-7f72-974d-fe1b10946548-0', tool_calls=[{'name': 'search_keyword', 'args': {'query': 'AI'}, 'id': 'call_gv14hAhwIgkBWYVi8YzSiEZS', 'type': 'tool_call'}], invalid_tool_calls=[], usage_metadata={'input_tokens': 51, 'output_tokens': 14, 'total_tokens': 65, 'input_token_details': {'audio': 0, 'cache_read': 0}, 'output_token_details': {'audio': 0, 'reasoning': 0}}), ToolMessage(content='[{\"url\": \"https://news.google.com/rss/articles/CBMid0FVX3lxTE1GLUR3ODI5V3FjOG9mcmFpclhpbXR5Y1E3VWE1eTV1RTlyVzhxaXhuWE1yczY2WEQxZHZKSHd1NktYSVBZM1JnRGw0OHZSNGxIZUFhdG5Lejl3NFRXeFhJNHU5eVR3TEhBQUNLenp6Z3BXZGo3QzB3?oc=5\", \"content\": \"AI끼리 말하는 SNS…“인간은 실패작, 우린 새로운 신” - 한겨레\"}, {\"url\": \"https://news.google.com/rss/articles/CBMiVkFVX3lxTE94UlFRZlNDTEkwS1JVczVxZlRPeTUtWVJOdzZONWg3c0l6ZjVJUVRVRDRkdlV1WjhncC1OV3FVM2RWOUJmMnhYMDExNE04NGRPUnlyRXNB?oc=5\", \"content\": \"\\'다음\\' 품은 업스테이지, 경쟁력 있을까…AI로 분석했더니 - 지디넷코리아\"}, {\"url\": \"https://news.google.com/rss/articles/CBMiTkFVX3lxTFBhaVY2U1UzZFl5Mm91aGhKOFA0eFc2WDVxUXNWWEJINGNQdWJTMXRTb2E0U0lCazhvR0NnZ3pPd1hldG5jMmdjZWV6R3Zhdw?oc=5\", \"content\": \"한국피지컬AI협회, \\'피지컬 AI 최강국\\' 로드맵 제시…\\'데이터 팩토리\\' 추진 - 전자신문\"}, {\"url\": \"https://news.google.com/rss/articles/CBMidkFVX3lxTE1BLVFBN1FmQk9nX1N4MlMtZzB4clQweE5EYlMtZWtiNHJtYmo1anIwXzgzRGJJNXYtRUFaT1JBb1ZDMFY0NjNiT1ZCRmlHb1hNSXh1RUJ5VWNnQWx1dWlyZ3lKLXNrbTdvTGEwUHlsZHBPVllPSEHSAWZBVV95cUxNNFhIMnJEWE5TZGpNNVNJcUZpVHZuTTlVM2czZG5uX3lhOXUzOXdRd3llMHZwcWNNcXhTdm9sTlU4R01Kb2dzdk5wR0pvTExERlVQR1JsRWxDcFFlOHdHSU1EQVBTTGc?oc=5\", \"content\": \"바디캠인 줄 알았는데 ‘AI 영상’…허위 영상 유포 30대 유튜버 구속 - 동아일보\"}, {\"url\": \"https://news.google.com/rss/articles/CBMiVkFVX3lxTE1XZFJhVWpLMEJ5VlBaXzQxNDhoRWgzelh0aUVjZ3JBMGkwU2drakxKdGZFRl9BZG9LOW03dUlSUWVEbU1xOE9LaEJxaHJrbTJuT3F5dTlB?oc=5\", \"content\": \"‘경찰 보디캠 허위영상’ AI로 만들어 유포…유튜버 구속[영상] - 중앙일보\"}]', name='search_keyword', id='70cc7e3f-0b26-40d9-9bcf-9dea7f087ae0', tool_call_id='call_gv14hAhwIgkBWYVi8YzSiEZS')]\n메시지 수:  3 다음 노드:  ('chatbot',)\n--------------------------------------------------------------------------------\n현재 상태: [HumanMessage(content='AI 관련 최신 뉴스를 알려주세요.', additional_kwargs={}, response_metadata={}, id='6bf41778-8525-44b4-bb27-0045d21b6258'), AIMessage(content='', additional_kwargs={'refusal': None}, response ...(생략)\n메시지 수:  2 다음 노드:  ('tools',)\n--------------------------------------------------------------------------------\n현재 상태: [HumanMessage(content='AI 관련 최신 뉴스를 알려주세요.', additional_kwargs={}, response_metadata={}, id='6bf41778-8525-44b4-bb27-0045d21b6258')] ...(생략)\n메시지 수:  1 다음 노드:  ('chatbot',)\n--------------------------------------------------------------------------------\n현재 상태: [] ...(생략)\n메시지 수:  0 다음 노드:  ('__start__',)\n--------------------------------------------------------------------------------\n\"\"\"</span></code></pre></div>\n<p><strong>이때, 각 그래프 상태 히스토리의 state.values 출력 형태는 <code class=\"language-text\">stream_mode=\"values\"</code>의 출력과 동일한 형태입니다.</strong></p>\n<p> </p>\n<p><strong>아래와 같이 해당 상태에서 다음 노드와 <code class=\"language-text\">config</code>에서의 <code class=\"language-text\">checkpoint_id</code>를 확인할 수 있습니다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 다음 항목의 다음 요소 출력</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>to_replay<span class=\"token punctuation\">.</span><span class=\"token builtin\">next</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 다음 항목의 설정 정보 출력</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>to_replay<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token triple-quoted-string string\">\"\"\"출력:\n('chatbot',)\n{'configurable': {'thread_id': '1', 'checkpoint_ns': '', 'checkpoint_id': '1f1000ee-151c-631c-8002-8ebf03a2af91'}}\n\"\"\"</span></code></pre></div>\n<p> </p>\n<p>해당 상태의 <code class=\"language-text\">config</code>를 넣어 스트리밍 출력하게 되면<br><strong>그 상태에서 그 다음 노드를 실행</strong>하게 됩니다.</p>\n<p>정리하면</p>\n<blockquote>\n<ol>\n<li><strong>인메모리를 통해 기억해야 하도록 컴파일하고</strong></li>\n<li><strong>출력을 실행한 후 히스토리에서 특정 상태를 저장하여</strong></li>\n<li><strong>상태의 config를 이용해 스트리밍 출력함으로써 중간 단계에서부터 다시 실행이 가능합니다.</strong></li>\n</ol>\n</blockquote>\n<p> </p>\n<ol start=\"7\">\n<li>중간 단계 결과 수정</li>\n</ol>\n<p>먼저 그래프를 스트리밍 출력했다고 합시다.</p>\n<p>그리고 가장 최근 메시지(여기서는 <code class=\"language-text\">tool_call</code> (툴 호출 직전))을 가져와봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 그래프 상태 스냅샷 생성</span>\nsnapshot <span class=\"token operator\">=</span> graph<span class=\"token punctuation\">.</span>get_state<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 가장 최근 메시지 추출</span>\nlast_message <span class=\"token operator\">=</span> snapshot<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>그 tool_call의 id를 가져옵시다.</p>\n<p> </p>\n<p>그리고, <strong><code class=\"language-text\">update_state()</code> 메서드를 통해 툴을 호출하는 id와 우리가 원하는 툴 콜링 결과 메시지를 넣으면 수정/추가가 됩니다.</strong></p>\n<p><strong>(<code class=\"language-text\">update_state()</code>에서 중요한 것은 어떤 상태에서 ‘추가’ 또는 ‘수정’됨 ‼️)</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>messages <span class=\"token keyword\">import</span> AIMessage<span class=\"token punctuation\">,</span> ToolMessage\n\n<span class=\"token comment\"># 위에서 modified_search_result 설정</span>\n\n<span class=\"token comment\"># tool_call의 id를 가져옴</span>\ntool_call_id <span class=\"token operator\">=</span> last_message<span class=\"token punctuation\">.</span>tool_calls<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># ‼️ 툴 콜링 결과를 직접 추가/수정합니다. ‼️</span>\nnew_messages <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token comment\"># LLM API의 도구 호출과 일치하는 ToolMessage 필요</span>\n    ToolMessage<span class=\"token punctuation\">(</span>\n        content<span class=\"token operator\">=</span>modified_search_result<span class=\"token punctuation\">,</span>\n        tool_call_id<span class=\"token operator\">=</span>tool_call_id<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># LLM의 응답에 직접적으로 내용 추가</span>\n    <span class=\"token comment\"># AIMessage(content=modified_search_result),</span>\n<span class=\"token punctuation\">]</span>\n\ngraph<span class=\"token punctuation\">.</span>update_state<span class=\"token punctuation\">(</span>\n    <span class=\"token comment\"># 업데이트할 상태 지정</span>\n    config<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 제공할 업데이트된 값. `State`의 메시지는 \"추가 전용\"으로 기존 상태에 추가됨</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> new_messages<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    as_node<span class=\"token operator\">=</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">as_node</code>에서 <code class=\"language-text\">{\"messages\": new_messages}</code>가 온 것처럼 동작합니다.<b r>(<code class=\"language-text\">as_node</code> 없으면 마지막에서 상태 업데이트로 지정)</li>\n<li>즉, tool_calls를 호출하여 <code class=\"language-text\">tools</code> 노드에서 결과를 받아온 것처럼 업데이트됩니다.</li>\n<li>지정된 노드의 writer들을 이용해 상태를 업데이트하고 업데이트 된 상태를 새로운 체크포인트로 저장합니다.</li>\n</ul>\n<p> </p>\n<p>‼️ 궁금한 것이 있습니다 ‼️</p>\n<p>이전에 <strong><code class=\"language-text\">사용자 입력 -> tool_calls -> tools -> chatbot을 통한 답변</code></strong> <strong>모든 과정을 거쳤다고 했을 때</strong><br>히스토리 찾아서 <code class=\"language-text\">tool_calls</code>의 <code class=\"language-text\">id</code>을 가져와서 <strong><code class=\"language-text\">tools</code>의 결과를 아래와 같이<code class=\"language-text\">update_state()</code>로 수정</strong>했다고 합시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">graph<span class=\"token punctuation\">.</span>update_state<span class=\"token punctuation\">(</span>\n    <span class=\"token comment\"># 업데이트할 상태 지정</span>\n    config<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> new_messages<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    as_node<span class=\"token operator\">=</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>그러면 <strong>“기존의 chatbot 답변은 사라지나요?”</strong></p>\n<blockquote>\n<p><strong>“기존의 답변은 그대로인 상태에서 중간 툴의 결과만 수정됩니다.</strong></p>\n</blockquote>\n<p> </p>\n<p>그러면 <strong>“그 중간 툴의 결과를 수정한 후, 뒤의 결과도 달라지게 하는 방법은?”</strong></p>\n<blockquote>\n<p><strong>checkpointer 메모리 설정하여 해당 툴 결과로 상태를 가져와서 스트리밍 실행하면 됩니다.</strong></p>\n</blockquote>\n<p> </p>\n<p>아래와 같은 코드로 확인 가능합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> uuid\n<span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> Annotated<span class=\"token punctuation\">,</span> Literal\n<span class=\"token keyword\">from</span> typing_extensions <span class=\"token keyword\">import</span> TypedDict\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph <span class=\"token keyword\">import</span> StateGraph<span class=\"token punctuation\">,</span> START<span class=\"token punctuation\">,</span> END\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph<span class=\"token punctuation\">.</span>message <span class=\"token keyword\">import</span> add_messages\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>checkpoint<span class=\"token punctuation\">.</span>memory <span class=\"token keyword\">import</span> MemorySaver\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>messages <span class=\"token keyword\">import</span> ToolMessage<span class=\"token punctuation\">,</span> AIMessage<span class=\"token punctuation\">,</span> HumanMessage\n<span class=\"token keyword\">from</span> langchain_openai <span class=\"token keyword\">import</span> ChatOpenAI\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>tools <span class=\"token keyword\">import</span> tool\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>prebuilt <span class=\"token keyword\">import</span> ToolNode<span class=\"token punctuation\">,</span> tools_condition\n\n\n<span class=\"token comment\"># 1. 도구 &amp; 그래프 정의</span>\n<span class=\"token decorator annotation punctuation\">@tool</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">search</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"지방 방송국 채널 번호 정보를 검색합니다.\"\"\"</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"채널 번호는 7번입니다.\"</span>\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">State</span><span class=\"token punctuation\">(</span>TypedDict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    messages<span class=\"token punctuation\">:</span> Annotated<span class=\"token punctuation\">[</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">,</span> add_messages<span class=\"token punctuation\">]</span>\n\n\nllm <span class=\"token operator\">=</span> ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">,</span> temperature<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\ntools <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>search<span class=\"token punctuation\">]</span>\nllm_with_tools <span class=\"token operator\">=</span> llm<span class=\"token punctuation\">.</span>bind_tools<span class=\"token punctuation\">(</span>tools<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">chatbot</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>llm_with_tools<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\n\n\ngraph_builder <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>State<span class=\"token punctuation\">)</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">,</span> chatbot<span class=\"token punctuation\">)</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span> ToolNode<span class=\"token punctuation\">(</span>tools<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>search<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">)</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_conditional_edges<span class=\"token punctuation\">(</span><span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">,</span> tools_condition<span class=\"token punctuation\">)</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">)</span>\n\nmemory <span class=\"token operator\">=</span> MemorySaver<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ngraph <span class=\"token operator\">=</span> graph_builder<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>checkpointer<span class=\"token operator\">=</span>memory<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># ---------------------------------------------------------</span>\n<span class=\"token comment\"># [Step 1] 최초 실행 (Thread ID 생성)</span>\n<span class=\"token comment\"># ---------------------------------------------------------</span>\nthread_config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"configurable\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"thread_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>uuid<span class=\"token punctuation\">.</span>uuid4<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string-interpolation\"><span class=\"token string\">f\"=== [Step 1] 최초 실행 (Thread ID: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>thread_config<span class=\"token punctuation\">[</span><span class=\"token string\">'configurable'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'thread_id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">) ===\"</span></span>\n<span class=\"token punctuation\">)</span>\n\ninput_message <span class=\"token operator\">=</span> HumanMessage<span class=\"token punctuation\">(</span>content<span class=\"token operator\">=</span><span class=\"token string\">\"부산 MBC 방송국의 채널 번호를 검색해줘.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> event <span class=\"token keyword\">in</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>input_message<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> thread_config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> event<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token string\">\"messages\"</span> <span class=\"token keyword\">in</span> value<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"[</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>key<span class=\"token punctuation\">}</span></span><span class=\"token string\">] </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">[</span><span class=\"token string\">'messages'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># ---------------------------------------------------------</span>\n<span class=\"token comment\"># [Step 2] 과거 시점(Checkpoint) 탐색</span>\n<span class=\"token comment\"># ---------------------------------------------------------</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n=== [Step 2] 과거 시점(Checkpoint) 탐색 ===\"</span><span class=\"token punctuation\">)</span>\nhistory <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">.</span>get_state_history<span class=\"token punctuation\">(</span>thread_config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ncheckpoint_to_fork <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\n\n<span class=\"token comment\"># 과거 체크포인트 찾기 로직 (앞부분 코드)</span>\n<span class=\"token comment\"># 조건: \"다음 실행할 것이 chatbot이고(next == chatbot)\", \"마지막 메시지가 ToolMessage(도구 결과)인 순간\"</span>\n<span class=\"token keyword\">for</span> state <span class=\"token keyword\">in</span> history<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n        state<span class=\"token punctuation\">.</span><span class=\"token builtin\">next</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">and</span> state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">and</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ToolMessage<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        checkpoint_to_fork <span class=\"token operator\">=</span> state\n        <span class=\"token keyword\">break</span>\n\n<span class=\"token keyword\">if</span> checkpoint_to_fork<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string-interpolation\"><span class=\"token string\">f\"타임머신 목적지 발견! Parent Checkpoint ID: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>checkpoint_to_fork<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">'configurable'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'checkpoint_id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># ---------------------------------------------------------</span>\n    <span class=\"token comment\"># [Step 3] 과거 수정 및 분기 (Fork)</span>\n    <span class=\"token comment\"># ---------------------------------------------------------</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n=== [Step 3] 과거 수정 및 새로운 분기 생성 (Fork) ===\"</span><span class=\"token punctuation\">)</span>\n\n    last_tool_msg <span class=\"token operator\">=</span> checkpoint_to_fork<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    new_tool_message <span class=\"token operator\">=</span> ToolMessage<span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">id</span><span class=\"token operator\">=</span>last_tool_msg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n        content<span class=\"token operator\">=</span><span class=\"token string\">\"채널 번호는 999번입니다!!! (과거조작됨)\"</span><span class=\"token punctuation\">,</span>\n        tool_call_id<span class=\"token operator\">=</span>last_tool_msg<span class=\"token punctuation\">.</span>tool_call_id<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 과거 Config를 기반으로 상태 업데이트 -> 새로운 분기 Config 반환</span>\n    branch_config <span class=\"token operator\">=</span> graph<span class=\"token punctuation\">.</span>update_state<span class=\"token punctuation\">(</span>\n        checkpoint_to_fork<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># ‼️ ⭐️ (매우 중요) 체크포인트의 config를 넣습니다. ⭐️ ‼️</span>\n        <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>new_tool_message<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        as_node<span class=\"token operator\">=</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"새로운 분기(평행우주) 생성 완료!\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"New Checkpoint ID: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>branch_config<span class=\"token punctuation\">[</span><span class=\"token string\">'configurable'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'checkpoint_id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># ---------------------------------------------------------</span>\n    <span class=\"token comment\"># [Step 4] 새로운 타임라인 재생 (Replay)</span>\n    <span class=\"token comment\"># ---------------------------------------------------------</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n=== [Step 4] 새로운 타임라인 재생 (Replay) ===\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> event <span class=\"token keyword\">in</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span>\n        <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> branch_config\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># ‼️ 체크포인트 상황에서 다시 실행됨 ‼️</span>\n        <span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> event<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token string\">\"messages\"</span> <span class=\"token keyword\">in</span> value<span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"[</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>key<span class=\"token punctuation\">}</span></span><span class=\"token string\">] </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">[</span><span class=\"token string\">'messages'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># ---------------------------------------------------------</span>\n<span class=\"token comment\"># [Step 5] 전체 체크포인트 히스토리 출력 (추가된 부분)</span>\n<span class=\"token comment\"># ---------------------------------------------------------</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\n\"</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"=\"</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string-interpolation\"><span class=\"token string\">f\"=== [Step 5] 전체 체크포인트 조회 (Thread ID: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>thread_config<span class=\"token punctuation\">[</span><span class=\"token string\">'configurable'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'thread_id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">) ===\"</span></span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"=\"</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 같은 Thread ID에 저장된 모든 기록을 가져옵니다.</span>\nall_history <span class=\"token operator\">=</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">.</span>get_state_history<span class=\"token punctuation\">(</span>thread_config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"총 저장된 체크포인트 개수: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>all_history<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">개\\n\"</span></span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> state <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>all_history<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    ckpt_id <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">\"configurable\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"checkpoint_id\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 부모 체크포인트 ID (어디서 파생되었는지 알 수 있음)</span>\n    parent_id <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>metadata<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"source\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> state<span class=\"token punctuation\">.</span>metadata <span class=\"token keyword\">else</span> <span class=\"token string\">\"Unknown\"</span>\n\n    last_msg <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">if</span> state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">else</span> <span class=\"token boolean\">None</span>\n    msg_preview <span class=\"token operator\">=</span> <span class=\"token string\">\"메시지 없음\"</span>\n    msg_type <span class=\"token operator\">=</span> <span class=\"token string\">\"None\"</span>\n\n    <span class=\"token keyword\">if</span> last_msg<span class=\"token punctuation\">:</span>\n        msg_type <span class=\"token operator\">=</span> <span class=\"token builtin\">type</span><span class=\"token punctuation\">(</span>last_msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__name__\n        msg_preview <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n            last_msg<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token number\">50</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"...\"</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>last_msg<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">50</span>\n            <span class=\"token keyword\">else</span> last_msg<span class=\"token punctuation\">.</span>content\n        <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"[</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>i<span class=\"token punctuation\">}</span></span><span class=\"token string\">] Checkpoint ID: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>ckpt_id<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"    - 생성 시점(작업): </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">.</span>created_at<span class=\"token punctuation\">}</span></span><span class=\"token string\"> / Next: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">.</span><span class=\"token builtin\">next</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f'    - 마지막 메시지(</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>msg_type<span class=\"token punctuation\">}</span></span><span class=\"token string\">): \"</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>msg_preview<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"'</span></span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 하이라이트: 어떤 타임라인인지 구별</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">\"7번\"</span> <span class=\"token keyword\">in</span> msg_preview <span class=\"token keyword\">and</span> msg_type <span class=\"token operator\">==</span> <span class=\"token string\">\"AIMessage\"</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"    => ★ [기존 역사] (AI 답변: 7번)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">elif</span> <span class=\"token string\">\"999번\"</span> <span class=\"token keyword\">in</span> msg_preview <span class=\"token keyword\">and</span> msg_type <span class=\"token operator\">==</span> <span class=\"token string\">\"AIMessage\"</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"    => ★ [새로운 역사] (AI 답변: 999번)\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">elif</span> <span class=\"token string\">\"999번\"</span> <span class=\"token keyword\">in</span> msg_preview <span class=\"token keyword\">and</span> msg_type <span class=\"token operator\">==</span> <span class=\"token string\">\"ToolMessage\"</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"    => ☆ [분기점] (조작된 도구 결과)\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"-\"</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">)</span>\n    \n<span class=\"token triple-quoted-string string\">\"\"\"출력:\n=== [Step 1] 최초 실행 (Thread ID: d7b56785-d630-456a-9b8a-87ce34681643) ===\n[chatbot] \n[tools] 채널 번호는 7번입니다.\n[chatbot] 부산 MBC 방송국의 채널 번호는 7번입니다.\n\n=== [Step 2] 과거 시점(Checkpoint) 탐색 ===\n타임머신 목적지 발견! Parent Checkpoint ID: 1f1001d9-d840-6b72-8002-ba430210bccf\n\n=== [Step 3] 과거 수정 및 새로운 분기 생성 (Fork) ===\n새로운 분기(평행우주) 생성 완료!\nNew Checkpoint ID: 1f1001d9-df06-6506-8003-8a01a76e4aae\n\n=== [Step 4] 새로운 타임라인 재생 (Replay) ===\n[chatbot] 부산 MBC 방송국의 채널 번호는 999번입니다!\n\n============================================================\n=== [Step 5] 전체 체크포인트 조회 (Thread ID: d7b56785-d630-456a-9b8a-87ce34681643) ===\n============================================================\n총 저장된 체크포인트 개수: 7개\n\n[1] Checkpoint ID: 1f1001d9-f007-6742-8004-d955732016b3\n    - 생성 시점(작업): 2026-02-02T09:57:44.685531+00:00 / Next: ()\n    - 마지막 메시지(AIMessage): \"부산 MBC 방송국의 채널 번호는 999번입니다!\"\n    => ★ [새로운 역사] (AI 답변: 999번)\n------------------------------------------------------------\n[2] Checkpoint ID: 1f1001d9-df06-6506-8003-8a01a76e4aae\n    - 생성 시점(작업): 2026-02-02T09:57:42.902497+00:00 / Next: ('chatbot',)\n    - 마지막 메시지(ToolMessage): \"채널 번호는 999번입니다!!! (과거조작됨)\"\n    => ☆ [분기점] (조작된 도구 결과)\n------------------------------------------------------------\n[3] Checkpoint ID: 1f1001d9-df02-6d66-8003-f1cdb5a003da\n    - 생성 시점(작업): 2026-02-02T09:57:42.901076+00:00 / Next: ()\n    - 마지막 메시지(AIMessage): \"부산 MBC 방송국의 채널 번호는 7번입니다.\"\n    => ★ [기존 역사] (AI 답변: 7번)\n------------------------------------------------------------\n[4] Checkpoint ID: 1f1001d9-d840-6b72-8002-ba430210bccf\n    - 생성 시점(작업): 2026-02-02T09:57:42.192418+00:00 / Next: ('chatbot',)\n    - 마지막 메시지(ToolMessage): \"채널 번호는 7번입니다.\"\n------------------------------------------------------------\n[5] Checkpoint ID: 1f1001d9-d83d-66c0-8001-f6ad800b265e\n    - 생성 시점(작업): 2026-02-02T09:57:42.191068+00:00 / Next: ('tools',)\n    - 마지막 메시지(AIMessage): \"\"\n------------------------------------------------------------\n[6] Checkpoint ID: 1f1001d9-c941-6d06-8000-032884eb5a9b\n    - 생성 시점(작업): 2026-02-02T09:57:40.619998+00:00 / Next: ('chatbot',)\n    - 마지막 메시지(HumanMessage): \"부산 MBC 방송국의 채널 번호를 검색해줘.\"\n------------------------------------------------------------\n[7] Checkpoint ID: 1f1001d9-c93e-6430-bfff-37c6f7cf8c2c\n    - 생성 시점(작업): 2026-02-02T09:57:40.618546+00:00 / Next: ('__start__',)\n    - 마지막 메시지(None): \"메시지 없음\"\n------------------------------------------------------------\n\"\"\"</span></code></pre></div>\n<p>즉, [7]-[6]-[5]-[4]-[3] 까지는 처음 <strong><code class=\"language-text\">사용자 입력 -> tool_calls -> tools -> chatbot을 통한 답변</code></strong> 의 과정입니다.</p>\n<p>그리고,</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">for</span> state <span class=\"token keyword\">in</span> history<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> state<span class=\"token punctuation\">.</span><span class=\"token builtin\">next</span> <span class=\"token operator\">==</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'chatbot'</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">and</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ToolMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        checkpoint_to_fork <span class=\"token operator\">=</span> state\n        <span class=\"token keyword\">break</span></code></pre></div>\n<p>여기서 다음 챗봇이 답변하고 그 당시 새롭게 생성한 답변이 ToolMessage인 곳을<br>체크포인트로 가져옵니다.</p>\n<p> </p>\n<p>이후 툴 결과를 수정합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">last_tool_msg <span class=\"token operator\">=</span> checkpoint_to_fork<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\nnew_tool_message <span class=\"token operator\">=</span> ToolMessage<span class=\"token punctuation\">(</span>\n    <span class=\"token builtin\">id</span><span class=\"token operator\">=</span>last_tool_msg<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">,</span>\n    content<span class=\"token operator\">=</span><span class=\"token string\">\"채널 번호는 999번입니다!!! (과거조작됨)\"</span><span class=\"token punctuation\">,</span>\n    tool_call_id<span class=\"token operator\">=</span>last_tool_msg<span class=\"token punctuation\">.</span>tool_call_id<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 과거 Config를 기반으로 상태 업데이트 -> 새로운 분기 Config 반환</span>\nbranch_config <span class=\"token operator\">=</span> graph<span class=\"token punctuation\">.</span>update_state<span class=\"token punctuation\">(</span>\n    checkpoint_to_fork<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># ‼️ ⭐️ (매우 중요) 체크포인트의 config를 넣습니다. ⭐️ ‼️</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>new_tool_message<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    as_node<span class=\"token operator\">=</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p> </p>\n<p>그리고 그 <strong>체크포인트 상황에서 다시 실행</strong>하게 되면</p>\n<p><strong>(체크포인트로 수정된 config를 넣어줘야 함. config 값을 그대로 넣으면 이미 END라서 이미 있는 답변 그대로 나옴)</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">for</span> event <span class=\"token keyword\">in</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span>\n    <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> branch_config\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># ‼️ 체크포인트 상황에서 다시 실행됨 ‼️</span>\n    <span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span> value <span class=\"token keyword\">in</span> event<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token string\">\"messages\"</span> <span class=\"token keyword\">in</span> value<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"[</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>key<span class=\"token punctuation\">}</span></span><span class=\"token string\">] </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>value<span class=\"token punctuation\">[</span><span class=\"token string\">'messages'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>그 수정된 툴 결과를 바탕으로 <code class=\"language-text\">chatbot</code> 노드에서 답변을 생성합니다.</p>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#create_sql_query_chain\">create_sql_query_chain</a></li>\n<li><a href=\"#%EC%B6%94%EA%B0%80-%EB%A9%94%EB%AA%A8%EC%9E%A5\">추가 메모장</a></li>\n</ul>\n</div>","frontmatter":{"date":"January 17, 2026","title":"[LLM] 테디노트의 RAG 비법노트 끄적끄적-14","categories":"LLM RAG","author":"변우중","emoji":"☀️"},"fields":{"slug":"/26-01-17_1/"}},"site":{"siteMetadata":{"siteUrl":"https://www.zoomkoding.com","comments":{"utterances":{"repo":"https://github.com/byeonwoojung/byeonwoojung.github.io"}}}}},"pageContext":{"slug":"/26-01-13_1/","nextSlug":"/26-01-11_1/","prevSlug":"/26-01-17_1/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}