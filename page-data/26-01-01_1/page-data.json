{"componentChunkName":"component---src-templates-blog-template-js","path":"/26-01-01_1/","result":{"data":{"cur":{"id":"69725161-4cf6-5273-b75f-c77780d8edb4","html":"<p>참고 : 테디노트의 RAG 비법노트 (<a href=\"https://fastcampus.co.kr/data_online_teddy)\">https://fastcampus.co.kr/data_online_teddy)</a><br>소스코드: <a href=\"https://github.com/teddylee777/langchain-kr\">https://github.com/teddylee777/langchain-kr</a><br>위키독스: <a href=\"https://wikidocs.net/book/14314\">https://wikidocs.net/book/14314</a></p>\n<p> </p>\n<p>이번에는 ’<strong>LCEL에서 메모리 사용하는 방법</strong>‘을 간단히 정리하고,<br>’<strong>SQLite DB를 이용한 메모리 저장하는 방법</strong>‘을 정리해보고자 합니다.</p>\n<p>상당히 복잡해보여서 연습이 중요할 것 같습니다.</p>\n<p>(<strong>주의‼️ 마음의 준비를 하고, 심호흡 한번 크게 하고 들어가야 합니다.</strong>)</p>\n<p>레츠기릿~!</p>\n<p> </p>\n<h2 id=\"lcel에서-메모리-사용하는-방법\" style=\"position:relative;\"><a href=\"#lcel%EC%97%90%EC%84%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\" aria-label=\"lcel에서 메모리 사용하는 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>LCEL에서 메모리 사용하는 방법</h2>\n<hr>\n<ol>\n<li>\n<p><strong>프롬프트 템플릿에 <code class=\"language-text\">MessagesPlaceholder(variable_name=\"chat_history\")</code> 박아두기</strong>!</p>\n</li>\n<li>\n<p><strong><code class=\"language-text\">memory = ConversationBufferMemory(return_messages=True, memory_key=\"chat_history\")</code> 메모리 생성하면서<br><code class=\"language-text\">memory_key</code>의 값과 <code class=\"language-text\">MessagesPlaceholder</code>에 들어가는 <code class=\"language-text\">variable_name</code> 값을 동일하게 하기</strong></p>\n<ul>\n<li><strong>메모리에서 지정한 <code class=\"language-text\">memory_key</code>는 프롬프트 템플릿에서 이전 대화 자리에 박아두는 변수명과 같아야 함</strong></li>\n</ul>\n</li>\n<li>\n<p><strong><code class=\"language-text\">RunnablePassthrough.assign()</code>에서 <code class=\"language-text\">RunnableLambda(memory.load_memory_variables) | itemgetter(memory.memory_key)</code>을 <code class=\"language-text\">chat_history</code>에 지정한 <code class=\"language-text\">runnable</code>을 만들어 chain에서 이용함</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables <span class=\"token keyword\">import</span> RunnableLambda<span class=\"token punctuation\">,</span> RunnablePassthrough\n\nrunnable <span class=\"token operator\">=</span> RunnablePassthrough<span class=\"token punctuation\">.</span>assign<span class=\"token punctuation\">(</span>  chat_history<span class=\"token operator\">=</span>RunnableLambda<span class=\"token punctuation\">(</span>memory<span class=\"token punctuation\">.</span>load_memory_variables<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|</span> itemgetter<span class=\"token punctuation\">(</span><span class=\"token string\">\"chat_history\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># RunnableLambda(memory.load_memory_variables)의 반환값에서 chat_history만 추출</span>\n    <span class=\"token comment\"># | itemgetter(memory.memory_key) # 위와 똑같음</span>\n<span class=\"token punctuation\">)</span>\n\nrunnable<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"input\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"hi\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># {'input': 'hi'}과 chat_history 값이 합쳐져 아래의 프롬프트 템플릿의 변수값에 들어갈 것임 ({'input': 'hi', 'chat_history': [대화들]} 꼴)</span></code></pre></div>\n<ul>\n<li><strong><code class=\"language-text\">RunnableLambda(memory.load_memory_variables)</code>는 <code class=\"language-text\">memory.load_memory_variables({})</code>와 같은 것임</strong>\n<ul>\n<li>즉, <code class=\"language-text\">chat_history</code> 키의 값에 <strong>대화들 리스트</strong>를 담은 딕셔너리일 것임</li>\n</ul>\n</li>\n<li>그리고, ⭐️ <strong><code class=\"language-text\">memory.load_memory_variables({})</code>의 결과값(대화들 담긴 딕셔너리)에서 <code class=\"language-text\">memory.memory_key</code>값(‘chat_history’ 키의 값, 즉 대화들)만 추출해서 <code class=\"language-text\">chat_history</code> 변수에 전달함</strong> ⭐️\n<ul>\n<li><code class=\"language-text\">memory.load_memory_variables({})</code><br>: {‘chat_history’: [대화들]} 꼴</li>\n<li><code class=\"language-text\">memory.memory_key</code>값(‘chat_history’ 키의 값)만 추출<br>: [대화들] 꼴</li>\n<li><code class=\"language-text\">chat_history</code> 변수에 전달한 후의 최종 <code class=\"language-text\">RunnablePassthrough.assign()</code> 값<br>: {‘chat_history’: [대화들]}</li>\n<li><code class=\"language-text\">runnable.invoke({\"input\": \"hi\"})</code> 값<br>: <code class=\"language-text\">{'input': 'hi'}</code>과 <code class=\"language-text\">chat_history</code> 값이 합쳐져 <code class=\"language-text\">{'input': 'hi', 'chat_history': [대화들]}</code> 꼴이 됨</li>\n</ul>\n</li>\n</ul>\n<p> </p>\n<p>⭐️ **결국, runnable를 invoke 호출했을 때<br><code class=\"language-text\">{'input': 'hi', 'chat_history': [대화들]}</code>이 되므로 각각 사용자 입력값과 이전 대화로 프롬프트 템플릿에서 이용할 수 있습니다!!**⭐️</p>\n<p>(좀 복잡하지만 그 과정을 명확히 알고 있어야 본격적으로 chain에 연결할 때 헷갈리지 않을 것 같습니다..)</p>\n</li>\n</ol>\n<p> </p>\n<p>방금 만들었던 **이전 대화와 새로운 질문을 반환하는 <code class=\"language-text\">runnable</code>**을 가장 맨 앞에 붙여<br>그 결과를 프롬프트에 전달하는 ‘runnable-프롬프트-LLM-파서’ 이렇게 chain을 구성하면 될 듯 합니다.</p>\n<p> </p>\n<p> </p>\n<h2 id=\"sqlite-db를-이용한-메모리-저장-방법\" style=\"position:relative;\"><a href=\"#sqlite-db%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%A0%80%EC%9E%A5-%EB%B0%A9%EB%B2%95\" aria-label=\"sqlite db를 이용한 메모리 저장 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQLite DB를 이용한 메모리 저장 방법</h2>\n<hr>\n<p>이전까지는 인메모리에 캐시를 저장하는 방법을 정리해봤는데<br>사실, 대화 세션을 일회성으로 이용하는 것이면 데이터베이스에 저장하지 않아도 되긴 합니다.</p>\n<p>하지만, 이전 대화를 나중에 다시 사용해야 한다면 데이터베이스에 유저별 테이블 형식으로 저장해두고, 그 기반으로 답변을 할 수 있도록 하는 것이 좋습니다.</p>\n<p> </p>\n<p>흐름부터 정리하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">invoke() 호출\n    ↓\nconfig에서 user_id, session_id 추출 (history_factory_config 참조)\n    ↓\nget_chat_history(user_id, session_id) 호출 → ChatMessageHistory 반환\n    ↓\nchat_history를 프롬프트에 주입 (history_messages_key 사용)\n    ↓\nquestion을 프롬프트에 주입 (input_messages_key 사용)\n    ↓\nLLM 실행 → 응답 반환\n    ↓\n새 대화(질문+응답)를 ChatMessageHistory에 자동 저장</code></pre></div>\n<p>처음에 질문을 했을 때 config에서 어떠한 데이터베이스에서 어떠한 테이블에서 어떠한 컬럼값을 참고할지를 정합니다.</p>\n<p>이후, 해당 config를 참고하여 이전 대화를 가져온 후 프롬프트에 넣습니다.</p>\n<p>그리고, 처음 입력한 질문을 프롬프트에 넣으면서 LLM이 실행하고 응답을 받습니다.</p>\n<p>마지막에 그 새로운 대화를 해당 데이터베이스의 테이블에 데이터로 저장합니다.</p>\n<p> </p>\n<p>코드로 자세하게 봅시다.</p>\n<ol>\n<li>\n<p>**<code class=\"language-text\">ConfigurableFieldSpec</code>**을 이용해 <strong>DB 조회할 파라미터(컬럼명 등)를 설정</strong>해두어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables<span class=\"token punctuation\">.</span>utils <span class=\"token keyword\">import</span> ConfigurableFieldSpec\n\nconfig_fields <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    ConfigurableFieldSpec<span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">id</span><span class=\"token operator\">=</span><span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># ⭐️ get_chat_history 함수에서 사용할 파라미터 ⭐️</span>\n        annotation<span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"User ID\"</span><span class=\"token punctuation\">,</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Unique identifier for a user.\"</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n        is_shared<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    ConfigurableFieldSpec<span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">id</span><span class=\"token operator\">=</span><span class=\"token string\">\"conversation_id\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># ⭐️ get_chat_history 함수에서 사용할 파라미터 ⭐️</span>\n        annotation<span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"Conversation ID\"</span><span class=\"token punctuation\">,</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Unique identifier for a conversation.\"</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n        is_shared<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n</li>\n<li>\n<p><strong><code class=\"language-text\">get_chat_history</code></strong> 함수에서 <strong>DB에서 사용할 파라미터명을 인자로 받아</strong>, **<code class=\"language-text\">SQLChatMessageHistory</code>**을 이용해 <strong>DB 메시지 히스토리를 관리</strong>하도록 정의합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">get_chat_history</span><span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">,</span> conversation_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> SQLChatMessageHistory<span class=\"token punctuation\">(</span>\n        table_name<span class=\"token operator\">=</span>user_id<span class=\"token punctuation\">,</span>          <span class=\"token comment\"># (유저 ID별) 테이블</span>\n        session_id<span class=\"token operator\">=</span>conversation_id<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 대화 ID 컬럼</span>\n        connection<span class=\"token operator\">=</span><span class=\"token string\">\"sqlite:///sqlite.db\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 데이터베이스 파일명</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">table_name</code>: (보통 유저 ID별) 테이블명 설정</p>\n</li>\n<li>\n<p><code class=\"language-text\">session_id</code>: 테이블에서 session_id 값에 넣는 대화 세션 ID 값 설정</p>\n</li>\n<li>\n<p><code class=\"language-text\">connection</code>: 데이터베이스 파일명 설정</p>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">RunnableWithMessageHistory()</code> 객체 생성하면서 <strong>대화 내용을 기록해주는 함수를 기존 체인에 연결</strong>해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables<span class=\"token punctuation\">.</span>history <span class=\"token keyword\">import</span> RunnableWithMessageHistory\n\nchain_with_history <span class=\"token operator\">=</span> RunnableWithMessageHistory<span class=\"token punctuation\">(</span>\n    chain<span class=\"token punctuation\">,</span>\n    get_chat_history<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 대화 기록을 가져오는 함수를 설정합니다.</span>\n    input_messages_key<span class=\"token operator\">=</span><span class=\"token string\">\"question\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 입력 메시지의 키를 \"question\"으로 설정 (⭐️ chain에서 prompt 템플릿의 입력 변수와 같아야 함 ⭐️)</span>\n    history_messages_key<span class=\"token operator\">=</span><span class=\"token string\">\"chat_history\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 대화 기록 메시지의 키를 \"chat_history\"로 설정 (⭐️ chain에서 prompt 템플릿-메시지플레이스홀더의 입력 변수와 같아야 함 ⭐️)</span>\n    history_factory_config<span class=\"token operator\">=</span>config_fields<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 대화 기록 조회시 참고할 파라미터를 설정합니다. (⭐️ get_chat_history에서 사용하는 ConfigurableFieldSpece들을 전달하기 위한 것 ⭐️)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">chain</code>: 기존 체인(프롬프트-LLM-파서 연결)</p>\n</li>\n<li>\n<p><code class=\"language-text\">get_chat_history</code>: DB에서 데이터베이스 파일명-대화 세션-(유저별) 테이블을 찾아가서 메시지 히스토리 관리함</p>\n</li>\n<li>\n<p><code class=\"language-text\">input_messages_key</code>: 기존 체인에서 프롬프트 템플릿에서 사용하는 입력변수 값을 넣음</p>\n</li>\n<li>\n<p><code class=\"language-text\">history_messages_key</code>: 기존 체인에서 프롬프트 템플릿에서 <code class=\"language-text\">MessagesPlaceholder</code>에서 사용하는 변수 값을 넣음</p>\n</li>\n<li>\n<p><code class=\"language-text\">history_factory_config</code>: 대화 기록 조회할 때 참고할 파라미터 정보들 설정</p>\n</li>\n</ul>\n</li>\n<li>\n<p>config에 configurable 키 하위에 get_chat_history에서  <strong>DB 메시지 히스토리를 관리</strong>할 때 사용하는 <strong>파라미터(대화 세션 ID, 테이블명)들을 설정</strong>합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># config 설정</span>\n<span class=\"token triple-quoted-string string\">\"\"\"\nconfigurable 키 하위에 user_id, conversation_id 값을 설정\n(get_chat_history에서 DB 메시지 히스토리 관리할 때 사용하는 값들)\n\"\"\"</span>\nconfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"configurable\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"user1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"conversation_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"conversation1\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p><strong>table_name 테이블명=user_id=user1</strong></p>\n</li>\n<li>\n<p><strong>session_id 컬럼 값=conversation_id=conversation1</strong></p>\n</li>\n</ul>\n</li>\n<li>\n<p>앞에서 기존 체인과 이전 대화 기록 조회하는 것을 연결한 <strong><code class=\"language-text\">chain_with_history</code>에서 <code class=\"language-text\">invoke()</code> 메서드에 입력변수와 config을 전달하여 호출</strong>합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">chain_with_history<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"question\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"내 이름이 뭐라고?\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ol>\n<p> </p>\n<p>굉장히 복잡하고 어려워보이지만<br>갓 테디노트님 강의 들으니 이해하기 쉽더라고요,, 좋슴다…</p>\n<p> </p>\n<p> </p>\n<p>여기서 끄읕.<br>다음은 문서 로드하는 방법인데, 간단히 정리하고 다른 것을 쓰고자 합니다! See ya.</p>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#lcel%EC%97%90%EC%84%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\">LCEL에서 메모리 사용하는 방법</a></li>\n<li><a href=\"#sqlite-db%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%A0%80%EC%9E%A5-%EB%B0%A9%EB%B2%95\">SQLite DB를 이용한 메모리 저장 방법</a></li>\n</ul>\n</div>","excerpt":"참고 : 테디노트의 RAG 비법노트 (https://fastcampus.co.kr/data_online_teddy)소스코드: https://github.com/teddylee777/langchain-kr위키독스: https://wikidocs.net/book/14314   이번에는 ’LCEL에서 메모리 사용하는 방법‘을 간단히 정리하고,’SQLite DB를 이용한 메모리 저장하는 방법‘을 정리해보고자 합니다. 상당히 복잡해보여서 연습이 중요할 것 같습니다. (주의‼️ 마음의 준비를 하고, 심호흡 한번 크게 하고 들어가야 합니다.) 레츠기릿~!   LCEL에서 메모리 사용하는 방법 프롬프트 템플릿에  박아두기!  메모리 생성하면서의 값과 에 들어가는  값을 동일하게 하기 메모리에서 지정한 는 프롬프트 템플릿에서 이전 대화 자리에 박아두는 변수명과 같아야 함 에서 을 에 지정한 을 만들어 chain에서 이용함 는 와 같은 것임 즉,  키의 값에 대화들 리스트를 담은 딕셔너리일 것임 그리…","frontmatter":{"date":"January 01, 2026","title":"[LLM] 테디노트의 RAG 비법노트 끄적끄적-11","categories":"LLM RAG","author":"변우중","emoji":"☀️"},"fields":{"slug":"/26-01-01_1/"}},"next":{"id":"16d4151c-c0f0-5202-8651-703654b9bb3c","html":"<p>참고 : 테디노트의 RAG 비법노트 (<a href=\"https://fastcampus.co.kr/data_online_teddy)\">https://fastcampus.co.kr/data_online_teddy)</a><br>소스코드: <a href=\"https://github.com/teddylee777/langchain-kr\">https://github.com/teddylee777/langchain-kr</a><br>위키독스: <a href=\"https://wikidocs.net/book/14314\">https://wikidocs.net/book/14314</a></p>\n<p> </p>\n<p>이번에는 ’<strong>LCEL에서 메모리 사용하는 방법</strong>‘을 간단히 정리하고,<br>’<strong>SQLite DB를 이용한 메모리 저장하는 방법</strong>‘을 정리해보고자 합니다.</p>\n<p>상당히 복잡해보여서 연습이 중요할 것 같습니다.</p>\n<p>(<strong>주의‼️ 마음의 준비를 하고, 심호흡 한번 크게 하고 들어가야 합니다.</strong>)</p>\n<p>레츠기릿~!</p>\n<p> </p>\n<h2 id=\"lcel에서-메모리-사용하는-방법\" style=\"position:relative;\"><a href=\"#lcel%EC%97%90%EC%84%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\" aria-label=\"lcel에서 메모리 사용하는 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>LCEL에서 메모리 사용하는 방법</h2>\n<hr>\n<ol>\n<li>\n<p><strong>프롬프트 템플릿에 <code class=\"language-text\">MessagesPlaceholder(variable_name=\"chat_history\")</code> 박아두기</strong>!</p>\n</li>\n<li>\n<p><strong><code class=\"language-text\">memory = ConversationBufferMemory(return_messages=True, memory_key=\"chat_history\")</code> 메모리 생성하면서<br><code class=\"language-text\">memory_key</code>의 값과 <code class=\"language-text\">MessagesPlaceholder</code>에 들어가는 <code class=\"language-text\">variable_name</code> 값을 동일하게 하기</strong></p>\n<ul>\n<li><strong>메모리에서 지정한 <code class=\"language-text\">memory_key</code>는 프롬프트 템플릿에서 이전 대화 자리에 박아두는 변수명과 같아야 함</strong></li>\n</ul>\n</li>\n<li>\n<p><strong><code class=\"language-text\">RunnablePassthrough.assign()</code>에서 <code class=\"language-text\">RunnableLambda(memory.load_memory_variables) | itemgetter(memory.memory_key)</code>을 <code class=\"language-text\">chat_history</code>에 지정한 <code class=\"language-text\">runnable</code>을 만들어 chain에서 이용함</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables <span class=\"token keyword\">import</span> RunnableLambda<span class=\"token punctuation\">,</span> RunnablePassthrough\n\nrunnable <span class=\"token operator\">=</span> RunnablePassthrough<span class=\"token punctuation\">.</span>assign<span class=\"token punctuation\">(</span>  chat_history<span class=\"token operator\">=</span>RunnableLambda<span class=\"token punctuation\">(</span>memory<span class=\"token punctuation\">.</span>load_memory_variables<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">|</span> itemgetter<span class=\"token punctuation\">(</span><span class=\"token string\">\"chat_history\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># RunnableLambda(memory.load_memory_variables)의 반환값에서 chat_history만 추출</span>\n    <span class=\"token comment\"># | itemgetter(memory.memory_key) # 위와 똑같음</span>\n<span class=\"token punctuation\">)</span>\n\nrunnable<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"input\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"hi\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># {'input': 'hi'}과 chat_history 값이 합쳐져 아래의 프롬프트 템플릿의 변수값에 들어갈 것임 ({'input': 'hi', 'chat_history': [대화들]} 꼴)</span></code></pre></div>\n<ul>\n<li><strong><code class=\"language-text\">RunnableLambda(memory.load_memory_variables)</code>는 <code class=\"language-text\">memory.load_memory_variables({})</code>와 같은 것임</strong>\n<ul>\n<li>즉, <code class=\"language-text\">chat_history</code> 키의 값에 <strong>대화들 리스트</strong>를 담은 딕셔너리일 것임</li>\n</ul>\n</li>\n<li>그리고, ⭐️ <strong><code class=\"language-text\">memory.load_memory_variables({})</code>의 결과값(대화들 담긴 딕셔너리)에서 <code class=\"language-text\">memory.memory_key</code>값(‘chat_history’ 키의 값, 즉 대화들)만 추출해서 <code class=\"language-text\">chat_history</code> 변수에 전달함</strong> ⭐️\n<ul>\n<li><code class=\"language-text\">memory.load_memory_variables({})</code><br>: {‘chat_history’: [대화들]} 꼴</li>\n<li><code class=\"language-text\">memory.memory_key</code>값(‘chat_history’ 키의 값)만 추출<br>: [대화들] 꼴</li>\n<li><code class=\"language-text\">chat_history</code> 변수에 전달한 후의 최종 <code class=\"language-text\">RunnablePassthrough.assign()</code> 값<br>: {‘chat_history’: [대화들]}</li>\n<li><code class=\"language-text\">runnable.invoke({\"input\": \"hi\"})</code> 값<br>: <code class=\"language-text\">{'input': 'hi'}</code>과 <code class=\"language-text\">chat_history</code> 값이 합쳐져 <code class=\"language-text\">{'input': 'hi', 'chat_history': [대화들]}</code> 꼴이 됨</li>\n</ul>\n</li>\n</ul>\n<p> </p>\n<p>⭐️ **결국, runnable를 invoke 호출했을 때<br><code class=\"language-text\">{'input': 'hi', 'chat_history': [대화들]}</code>이 되므로 각각 사용자 입력값과 이전 대화로 프롬프트 템플릿에서 이용할 수 있습니다!!**⭐️</p>\n<p>(좀 복잡하지만 그 과정을 명확히 알고 있어야 본격적으로 chain에 연결할 때 헷갈리지 않을 것 같습니다..)</p>\n</li>\n</ol>\n<p> </p>\n<p>방금 만들었던 **이전 대화와 새로운 질문을 반환하는 <code class=\"language-text\">runnable</code>**을 가장 맨 앞에 붙여<br>그 결과를 프롬프트에 전달하는 ‘runnable-프롬프트-LLM-파서’ 이렇게 chain을 구성하면 될 듯 합니다.</p>\n<p> </p>\n<p> </p>\n<h2 id=\"sqlite-db를-이용한-메모리-저장-방법\" style=\"position:relative;\"><a href=\"#sqlite-db%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%A0%80%EC%9E%A5-%EB%B0%A9%EB%B2%95\" aria-label=\"sqlite db를 이용한 메모리 저장 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQLite DB를 이용한 메모리 저장 방법</h2>\n<hr>\n<p>이전까지는 인메모리에 캐시를 저장하는 방법을 정리해봤는데<br>사실, 대화 세션을 일회성으로 이용하는 것이면 데이터베이스에 저장하지 않아도 되긴 합니다.</p>\n<p>하지만, 이전 대화를 나중에 다시 사용해야 한다면 데이터베이스에 유저별 테이블 형식으로 저장해두고, 그 기반으로 답변을 할 수 있도록 하는 것이 좋습니다.</p>\n<p> </p>\n<p>흐름부터 정리하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">invoke() 호출\n    ↓\nconfig에서 user_id, session_id 추출 (history_factory_config 참조)\n    ↓\nget_chat_history(user_id, session_id) 호출 → ChatMessageHistory 반환\n    ↓\nchat_history를 프롬프트에 주입 (history_messages_key 사용)\n    ↓\nquestion을 프롬프트에 주입 (input_messages_key 사용)\n    ↓\nLLM 실행 → 응답 반환\n    ↓\n새 대화(질문+응답)를 ChatMessageHistory에 자동 저장</code></pre></div>\n<p>처음에 질문을 했을 때 config에서 어떠한 데이터베이스에서 어떠한 테이블에서 어떠한 컬럼값을 참고할지를 정합니다.</p>\n<p>이후, 해당 config를 참고하여 이전 대화를 가져온 후 프롬프트에 넣습니다.</p>\n<p>그리고, 처음 입력한 질문을 프롬프트에 넣으면서 LLM이 실행하고 응답을 받습니다.</p>\n<p>마지막에 그 새로운 대화를 해당 데이터베이스의 테이블에 데이터로 저장합니다.</p>\n<p> </p>\n<p>코드로 자세하게 봅시다.</p>\n<ol>\n<li>\n<p>**<code class=\"language-text\">ConfigurableFieldSpec</code>**을 이용해 <strong>DB 조회할 파라미터(컬럼명 등)를 설정</strong>해두어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables<span class=\"token punctuation\">.</span>utils <span class=\"token keyword\">import</span> ConfigurableFieldSpec\n\nconfig_fields <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    ConfigurableFieldSpec<span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">id</span><span class=\"token operator\">=</span><span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># ⭐️ get_chat_history 함수에서 사용할 파라미터 ⭐️</span>\n        annotation<span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"User ID\"</span><span class=\"token punctuation\">,</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Unique identifier for a user.\"</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n        is_shared<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    ConfigurableFieldSpec<span class=\"token punctuation\">(</span>\n        <span class=\"token builtin\">id</span><span class=\"token operator\">=</span><span class=\"token string\">\"conversation_id\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\"># ⭐️ get_chat_history 함수에서 사용할 파라미터 ⭐️</span>\n        annotation<span class=\"token operator\">=</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"Conversation ID\"</span><span class=\"token punctuation\">,</span>\n        description<span class=\"token operator\">=</span><span class=\"token string\">\"Unique identifier for a conversation.\"</span><span class=\"token punctuation\">,</span>\n        default<span class=\"token operator\">=</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n        is_shared<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n</li>\n<li>\n<p><strong><code class=\"language-text\">get_chat_history</code></strong> 함수에서 <strong>DB에서 사용할 파라미터명을 인자로 받아</strong>, **<code class=\"language-text\">SQLChatMessageHistory</code>**을 이용해 <strong>DB 메시지 히스토리를 관리</strong>하도록 정의합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">get_chat_history</span><span class=\"token punctuation\">(</span>user_id<span class=\"token punctuation\">,</span> conversation_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> SQLChatMessageHistory<span class=\"token punctuation\">(</span>\n        table_name<span class=\"token operator\">=</span>user_id<span class=\"token punctuation\">,</span>          <span class=\"token comment\"># (유저 ID별) 테이블</span>\n        session_id<span class=\"token operator\">=</span>conversation_id<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 대화 ID 컬럼</span>\n        connection<span class=\"token operator\">=</span><span class=\"token string\">\"sqlite:///sqlite.db\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 데이터베이스 파일명</span>\n    <span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">table_name</code>: (보통 유저 ID별) 테이블명 설정</p>\n</li>\n<li>\n<p><code class=\"language-text\">session_id</code>: 테이블에서 session_id 값에 넣는 대화 세션 ID 값 설정</p>\n</li>\n<li>\n<p><code class=\"language-text\">connection</code>: 데이터베이스 파일명 설정</p>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">RunnableWithMessageHistory()</code> 객체 생성하면서 <strong>대화 내용을 기록해주는 함수를 기존 체인에 연결</strong>해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>runnables<span class=\"token punctuation\">.</span>history <span class=\"token keyword\">import</span> RunnableWithMessageHistory\n\nchain_with_history <span class=\"token operator\">=</span> RunnableWithMessageHistory<span class=\"token punctuation\">(</span>\n    chain<span class=\"token punctuation\">,</span>\n    get_chat_history<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 대화 기록을 가져오는 함수를 설정합니다.</span>\n    input_messages_key<span class=\"token operator\">=</span><span class=\"token string\">\"question\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 입력 메시지의 키를 \"question\"으로 설정 (⭐️ chain에서 prompt 템플릿의 입력 변수와 같아야 함 ⭐️)</span>\n    history_messages_key<span class=\"token operator\">=</span><span class=\"token string\">\"chat_history\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 대화 기록 메시지의 키를 \"chat_history\"로 설정 (⭐️ chain에서 prompt 템플릿-메시지플레이스홀더의 입력 변수와 같아야 함 ⭐️)</span>\n    history_factory_config<span class=\"token operator\">=</span>config_fields<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 대화 기록 조회시 참고할 파라미터를 설정합니다. (⭐️ get_chat_history에서 사용하는 ConfigurableFieldSpece들을 전달하기 위한 것 ⭐️)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">chain</code>: 기존 체인(프롬프트-LLM-파서 연결)</p>\n</li>\n<li>\n<p><code class=\"language-text\">get_chat_history</code>: DB에서 데이터베이스 파일명-대화 세션-(유저별) 테이블을 찾아가서 메시지 히스토리 관리함</p>\n</li>\n<li>\n<p><code class=\"language-text\">input_messages_key</code>: 기존 체인에서 프롬프트 템플릿에서 사용하는 입력변수 값을 넣음</p>\n</li>\n<li>\n<p><code class=\"language-text\">history_messages_key</code>: 기존 체인에서 프롬프트 템플릿에서 <code class=\"language-text\">MessagesPlaceholder</code>에서 사용하는 변수 값을 넣음</p>\n</li>\n<li>\n<p><code class=\"language-text\">history_factory_config</code>: 대화 기록 조회할 때 참고할 파라미터 정보들 설정</p>\n</li>\n</ul>\n</li>\n<li>\n<p>config에 configurable 키 하위에 get_chat_history에서  <strong>DB 메시지 히스토리를 관리</strong>할 때 사용하는 <strong>파라미터(대화 세션 ID, 테이블명)들을 설정</strong>합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># config 설정</span>\n<span class=\"token triple-quoted-string string\">\"\"\"\nconfigurable 키 하위에 user_id, conversation_id 값을 설정\n(get_chat_history에서 DB 메시지 히스토리 관리할 때 사용하는 값들)\n\"\"\"</span>\nconfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"configurable\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"user_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"user1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"conversation_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"conversation1\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>\n<p><strong>table_name 테이블명=user_id=user1</strong></p>\n</li>\n<li>\n<p><strong>session_id 컬럼 값=conversation_id=conversation1</strong></p>\n</li>\n</ul>\n</li>\n<li>\n<p>앞에서 기존 체인과 이전 대화 기록 조회하는 것을 연결한 <strong><code class=\"language-text\">chain_with_history</code>에서 <code class=\"language-text\">invoke()</code> 메서드에 입력변수와 config을 전달하여 호출</strong>합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">chain_with_history<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"question\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"내 이름이 뭐라고?\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n</ol>\n<p> </p>\n<p>굉장히 복잡하고 어려워보이지만<br>갓 테디노트님 강의 들으니 이해하기 쉽더라고요,, 좋슴다…</p>\n<p> </p>\n<p> </p>\n<p>여기서 끄읕.<br>다음은 문서 로드하는 방법인데, 간단히 정리하고 다른 것을 쓰고자 합니다! See ya.</p>\n<div class=\"table-of-contents\">\n<ul>\n<li><a href=\"#lcel%EC%97%90%EC%84%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%B0%A9%EB%B2%95\">LCEL에서 메모리 사용하는 방법</a></li>\n<li><a href=\"#sqlite-db%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%A0%80%EC%9E%A5-%EB%B0%A9%EB%B2%95\">SQLite DB를 이용한 메모리 저장 방법</a></li>\n</ul>\n</div>","frontmatter":{"date":"December 31, 2025","title":"[LLM] 테디노트의 RAG 비법노트 끄적끄적-10","categories":"LLM","author":"변우중","emoji":"☀️"},"fields":{"slug":"/25-12-31_1/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://www.zoomkoding.com","comments":{"utterances":{"repo":"https://github.com/byeonwoojung/byeonwoojung.github.io"}}}}},"pageContext":{"slug":"/26-01-01_1/","nextSlug":"/25-12-31_1/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}