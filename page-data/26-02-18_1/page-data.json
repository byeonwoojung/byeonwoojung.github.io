{"componentChunkName":"component---src-templates-blog-template-js","path":"/26-02-18_1/","result":{"data":{"cur":{"id":"7157b519-9ebb-55a1-b211-c3ef1bff8fb3","html":"<p>참고 : 테디노트의 RAG 비법노트 (<a href=\"https://fastcampus.co.kr/data_online_teddy)\">https://fastcampus.co.kr/data_online_teddy)</a><br>소스코드: <a href=\"https://github.com/teddylee777/langchain-kr\">https://github.com/teddylee777/langchain-kr</a><br>위키독스: <a href=\"https://wikidocs.net/book/14314\">https://wikidocs.net/book/14314</a></p>\n<p> </p>\n<p>오늘도 LangGraph 기능들을 몇 가지 정리하고자 합니다..<br>레츠기리잇…!!</p>\n<p> </p>\n<h2 id=\"병렬-처리-fan-out-fan-in--신뢰도-따른-정렬\" style=\"position:relative;\"><a href=\"#%EB%B3%91%EB%A0%AC-%EC%B2%98%EB%A6%AC-fan-out-fan-in--%EC%8B%A0%EB%A2%B0%EB%8F%84-%EB%94%B0%EB%A5%B8-%EC%A0%95%EB%A0%AC\" aria-label=\"병렬 처리 fan out fan in  신뢰도 따른 정렬 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>병렬 처리 (fan-out, fan-in) + 신뢰도 따른 정렬</h2>\n<hr>\n<p>병렬 노드를 처리한 후 병렬로 처리된 결과를 신뢰도에 따라 정렬하는 코드를 봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> Annotated<span class=\"token punctuation\">,</span> Sequence\n<span class=\"token keyword\">from</span> typing_extensions <span class=\"token keyword\">import</span> TypedDict\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph <span class=\"token keyword\">import</span> StateGraph\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph<span class=\"token punctuation\">.</span>message <span class=\"token keyword\">import</span> add_messages\n\n\n<span class=\"token comment\"># 팬아웃 값들의 병합 로직 구현, 빈 리스트 처리 및 리스트 연결 수행</span>\n<span class=\"token triple-quoted-string string\">\"\"\"\nreducer에서는\n- left: 채널에 이미 있던 누적값(이전 상태)\n- right: 이번 단계에서 노드가 반환한 새 값(update/write)\n\n해당 노드에서 반환한 fanout_values 값이 right로 들어가는 것임\n - b,c,d에서는 right가 병렬로 처리된 값이 들어올 것임\n - e에서는 []를 반환하므로 right가 []로 들어올 것임 -> if not right 조건에 걸림\n\"\"\"</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">reduce_fanouts</span><span class=\"token punctuation\">(</span>left<span class=\"token punctuation\">,</span> right<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> left <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># left 없으면 (이전에 처리한 것이 없으면 -> 병렬처리 첫번째인 경우)</span>\n        <span class=\"token comment\"># left는 []로 넣음 -> [] or [] + right</span>\n        left <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> right<span class=\"token punctuation\">:</span>     <span class=\"token comment\"># right 없으면 (현재 반환된 값이 없거나 []이면 -> e인 경우)</span>\n        <span class=\"token comment\"># [] : 비우기 -> 해당 병렬처리 라운드 초기화</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> left <span class=\"token operator\">+</span> right  <span class=\"token comment\"># 누적</span>\n\n\n<span class=\"token comment\"># 상태 관리를 위한 타입 정의, 집계 및 팬아웃 값 저장 구조 설정</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">State</span><span class=\"token punctuation\">(</span>TypedDict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># add_messages 리듀서 사용</span>\n    aggregate<span class=\"token punctuation\">:</span> Annotated<span class=\"token punctuation\">[</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">,</span> add_messages<span class=\"token punctuation\">]</span>\n    fanout_values<span class=\"token punctuation\">:</span> Annotated<span class=\"token punctuation\">[</span><span class=\"token builtin\">list</span><span class=\"token punctuation\">,</span> reduce_fanouts<span class=\"token punctuation\">]</span>\n    which<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n\n\n<span class=\"token comment\"># 그래프 초기화</span>\nbuilder <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>State<span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> ReturnNodeValue<span class=\"token punctuation\">(</span><span class=\"token string\">\"I'm A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"a\"</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 병렬 노드 값 반환 클래스</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ParallelReturnNodeValue</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>\n        self<span class=\"token punctuation\">,</span>\n        node_secret<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span>\n        reliability<span class=\"token punctuation\">:</span> <span class=\"token builtin\">float</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>_value <span class=\"token operator\">=</span> node_secret\n        self<span class=\"token punctuation\">.</span>_reliability <span class=\"token operator\">=</span> reliability\n\n    <span class=\"token comment\"># 호출시 상태 업데이트</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__call__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Any<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Adding </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>self<span class=\"token punctuation\">.</span>_value<span class=\"token punctuation\">}</span></span><span class=\"token string\"> to </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">'aggregate'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> in parallel.\"</span></span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"fanout_values\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token string\">\"value\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>self<span class=\"token punctuation\">.</span>_value<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token string\">\"reliability\"</span><span class=\"token punctuation\">:</span> self<span class=\"token punctuation\">.</span>_reliability<span class=\"token punctuation\">,</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># 신뢰도(reliability)가 다른 병렬 노드들 추가</span>\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> ParallelReturnNodeValue<span class=\"token punctuation\">(</span><span class=\"token string\">\"I'm B\"</span><span class=\"token punctuation\">,</span> reliability<span class=\"token operator\">=</span><span class=\"token number\">0.1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"c\"</span><span class=\"token punctuation\">,</span> ParallelReturnNodeValue<span class=\"token punctuation\">(</span><span class=\"token string\">\"I'm C\"</span><span class=\"token punctuation\">,</span> reliability<span class=\"token operator\">=</span><span class=\"token number\">0.9</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"d\"</span><span class=\"token punctuation\">,</span> ParallelReturnNodeValue<span class=\"token punctuation\">(</span><span class=\"token string\">\"I'm D\"</span><span class=\"token punctuation\">,</span> reliability<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 팬아웃 값들을 신뢰도 기준으로 정렬하고 최종 집계 수행</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">aggregate_fanout_values</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Any<span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># ‼️ 신뢰도(reliability) 기준 정렬 (상태 fanout_values의 reliability 기준으로 state[\"fanout_values\"]을 정렬) ‼️</span>\n    ranked_values <span class=\"token operator\">=</span> <span class=\"token builtin\">sorted</span><span class=\"token punctuation\">(</span>\n        state<span class=\"token punctuation\">[</span><span class=\"token string\">\"fanout_values\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> key<span class=\"token operator\">=</span><span class=\"token keyword\">lambda</span> x<span class=\"token punctuation\">:</span> x<span class=\"token punctuation\">[</span><span class=\"token string\">\"reliability\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> reverse<span class=\"token operator\">=</span><span class=\"token boolean\">True</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>ranked_values<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># ‼️ 정렬된 state[\"fanout_values\"]에서 value 값만 가져와서 aggregate 상태에 넣고, E 부분 따로 추가 ‼️</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"aggregate\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>x<span class=\"token punctuation\">[</span><span class=\"token string\">\"value\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">for</span> x <span class=\"token keyword\">in</span> ranked_values<span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"I'm E\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"fanout_values\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># 집계 노드 추가</span>\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"e\"</span><span class=\"token punctuation\">,</span> aggregate_fanout_values<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 상태에 따른 조건부 라우팅 로직 구현</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">route_bc_or_cd</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Sequence<span class=\"token punctuation\">[</span><span class=\"token builtin\">str</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"which\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"cd\"</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"d\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c\"</span><span class=\"token punctuation\">]</span>\n\n\n<span class=\"token comment\"># 중간 노드들 설정 및 조건부 엣지 추가</span>\nintermediates <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"b\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"d\"</span><span class=\"token punctuation\">]</span>\nbuilder<span class=\"token punctuation\">.</span>add_conditional_edges<span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> route_bc_or_cd<span class=\"token punctuation\">,</span> intermediates<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 중간 노드들과 최종 집계 노드 연결</span>\n<span class=\"token keyword\">for</span> node <span class=\"token keyword\">in</span> intermediates<span class=\"token punctuation\">:</span>\n    builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> <span class=\"token string\">\"e\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 그래프 완성을 위한 최종</span>\ngraph <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<ol>\n<li>\n<p>병렬 처리할 때 상태 관리는 <code class=\"language-text\">fanout_values</code> 변수에서 하고, <code class=\"language-text\">Annotated[list, reduce_fanouts]</code> 타입 힌트를 갖습니다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">reduce_fanouts</code> 리듀서는 병렬처리용 리듀서입니다.</p>\n<ul>\n<li><code class=\"language-text\">def reduce_fanouts(left, right)</code>\n<ul>\n<li>left: <code class=\"language-text\">fanout_values</code>의 이전 상태</li>\n<li>right: 해당 노드의 이번 단계의 <code class=\"language-text\">fanout_values</code> 반환 값</li>\n<li><code class=\"language-text\">fanout_values</code> 값은 이전에 (병렬) 처리로 얻은 값이 없으면 이번 단계에 반환한 right만 누적하고, 이번 단계 처리한 값이 없으면(fan-in일 때=여기서는 <code class=\"language-text\">e</code> 노드) 빈 리스트 []로 초기화 합니다.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>노드 엣지 연결은 아래 그림과 코드를 보고 확인하면 됩니다. (<strong>which 상태 이용해서 병렬로 처리할 노드 설정 가능</strong>)</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 234px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 184.44444444444446%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAlCAIAAADNzV5SAAAACXBIWXMAAAsTAAALEwEAmpwYAAADs0lEQVRIx5VW23LbNhDlH3nqp7Sfl751pk3fmnbacTrppLdpxkk8thXVlq+RfIkvcWRZpC8iLYqkCIgQSRAAAYItSUlVLLu28MAhFnu4WOzBWSrpxCCCWyT0YoYER4L3OOtSTBIx6ancmHOZtMK+zYgZ+k27rdqmjqDDiI77Qso7wcVKJPhFgFwcNNut5fXS0lqpoV8AHFyEiAgxcrslcrEAGFERaAWoFfbzJ1IRgIzeQN6y7cKDy2yLyPeR7+fTRKbp/TnnYJlj0zAfmSWbyweBC+8sf4wjjEfTh4JTKXma7jUbu2f1/JSmAUsp34FO2THe2sYOtNM7xu1gniRV5KxcNVZ1db/vCplMAY6F2Om788e11yd7+32XC/FQMI/jEON153qrZ29Ca7trYozjOL4HzDmPoogylkoJY6oheN6HiLM0TSmjhBDO+S1gIQQhhFI6qEr+jBmLGRtNpZSUZp8QwywUKWUiJWVMfJpYRiwhuBA3qsSFYHFc0CaLzChr68Y4GYqXHgDQdSftbcNgOdUVh0ZVp/3qeP+kD4ngA/ZLeUXDknZaUusGwemQnBHnH3w4f7xfta97MVUOkfu3rdc8u2TrXRoNjkDK9W57u2dvQWsbdJJh6C6Nlm291rNWHEMLkHIaokXt44+Lf64B06VkAE6SPR+8PHy3cHpw4EORDEgCGKm47aevXpR1tUUC5Qi5FVvfNC/LjjEWOdkEnQ1L33CMKrSSYc5dGpVtfcO8XOten4dIMbBfg9YusPZ6Tsjj0Y2v98EOsGqgc+b3RsaAs92evQutGrRsgrPTJjFzIfzk6uUvXuCjwE/HblXh0IWA5PVXCoYAAEZMKEaapnhcDIbGjHwAFKQYMIwQAiGMomg8Ag5DnIOT/MCklBhjCCGldEI9pQyCwPO8bC2P8UFtHp01ijVKqed5QRCMq4oyQhZWIQQOQ03T3mj1CuysQnP5oqGpGg7DYqv/7f+m9A4XLMdZujyr6Opa+6LcUi3bvgH7PzHISBL05o+qC/X3h6E3nZIkGT2vK7CzAswt15xSPdMU8bgJuyrs9nk8nQBOin768I7B88qGURRGUZKL6UM7xqjdAMsGHWvYbu6LPMAw8sPlyVOj8eXBxuP3698bjZ+uPqK46JJ3l6q4eo8bOzOrv37x9sXssyezc998vvR8ZvW3r5r7hUjcA36iHX629PzRm2czc1/P/Pzto9dzs6Vfvrs8uQc8+jlYsK7+MM//clovnavfTW3RatGJ34J/wf8AKWBHX0nT22MAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"img 1\" title=\"img 1\" src=\"/static/77a4f58c4749a27bf8ffdb00dff591d7/7235c/img_1.png\" srcset=\"/static/77a4f58c4749a27bf8ffdb00dff591d7/e9ff0/img_1.png 180w,\n/static/77a4f58c4749a27bf8ffdb00dff591d7/7235c/img_1.png 234w\" sizes=\"(max-width: 234px) 100vw, 234px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n</li>\n<li>\n<p><code class=\"language-text\">e</code> 노드에서는 <code class=\"language-text\">aggregate_fanout_values</code> (병렬 처리 신뢰도 높은 순으로 정렬하는 함수)에서는<code class=\"language-text\">fanout_values</code> 상태를 <code class=\"language-text\">reliability</code>(신뢰도)에 따라 정렬합니다. 이후, <code class=\"language-text\">value</code> 값들과 [“I’m E”] 값을 추가하여 <code class=\"language-text\">aggregate</code> 상태에 넣고,  <code class=\"language-text\">fanout_values</code>  상태를 빈 리스트 []로 초기화합니다.</p>\n</li>\n</ol>\n<p> </p>\n<p> </p>\n<h2 id=\"서브그래프-추가\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B8%8C%EA%B7%B8%EB%9E%98%ED%94%84-%EC%B6%94%EA%B0%80\" aria-label=\"서브그래프 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서브그래프 추가</h2>\n<hr>\n<p>서브 그래프는 컴파일된 그래프를 어떤 그래프 안에 노드로서 추가된 것입니다.<br>(= <strong>컴파일된 그래프(서브그래프)를 부모 그래프에 노드로서 추가 가능하다.</strong>)</p>\n<p><strong>이때, 각 그래프별로 가지고 있는 상태 필드가 다르기 때문에 연결 시 주의할 점이 있습니다.</strong> ‼️</p>\n<p> </p>\n<h3 id=\"1-스키마-키-공유하는-경우\" style=\"position:relative;\"><a href=\"#1-%EC%8A%A4%ED%82%A4%EB%A7%88-%ED%82%A4-%EA%B3%B5%EC%9C%A0%ED%95%98%EB%8A%94-%EA%B2%BD%EC%9A%B0\" aria-label=\"1 스키마 키 공유하는 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 스키마 키 공유하는 경우</h3>\n<p>알아두어야 할 것은 <strong>“공유된 스키마 키는 상태 업데이트 될 때 부모 상태와 자식 상태 모두 변합니다.”</strong></p>\n<ol>\n<li>\n<p>자식 그래프 컴파일</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ChildState</span><span class=\"token punctuation\">(</span>TypedDict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>  <span class=\"token comment\"># 부모 그래프와 공유되는 상태 키</span>\n    family_name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n    \n<span class=\"token comment\"># 서브그래프의 첫 번째 노드, family_name 키에 초기값 설정</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">subgraph_node_1</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> ChildState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"family_name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Lee\"</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">subgraph_node_2</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> ChildState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># ‼️ 서브그래프 내부에서만 사용 가능한 family_name 키와 공유 상태 키 name를 사용하여 업데이트 수행 ‼️</span>\n    <span class=\"token comment\"># 즉, state[\"name\"]는 부모 그래프에서 설정된 name 키의 값을 가져와서 공유함 !!</span>\n    <span class=\"token comment\"># ‼️ 최종적으로 자식에서 name을 수정하면서 부모 그래프 name 상태도 수정됨 ‼️</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f'</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"family_name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">}</span>\n\nsubgraph_builder <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>ChildState<span class=\"token punctuation\">)</span>\nsubgraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span>subgraph_node_1<span class=\"token punctuation\">)</span>\nsubgraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span>subgraph_node_2<span class=\"token punctuation\">)</span>\nsubgraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"subgraph_node_1\"</span><span class=\"token punctuation\">)</span>\nsubgraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"subgraph_node_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"subgraph_node_2\"</span><span class=\"token punctuation\">)</span>\nsubgraph <span class=\"token operator\">=</span> subgraph_builder<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>checkpointer<span class=\"token operator\">=</span>memory<span class=\"token punctuation\">)</span>\n\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"child_node\"</span><span class=\"token punctuation\">,</span> subgraph<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">START</code> -> <code class=\"language-text\">subgraph_node_1</code> 노드 -> <code class=\"language-text\">subgraph_node_2</code> 노드로 이동하는 자식 그래프를 컴파일하여 만들었습니다.</p>\n</li>\n<li>\n<p><strong>자식 상태는 <code class=\"language-text\">name</code>와 <code class=\"language-text\">family_name</code>가 있고, <code class=\"language-text\">name</code>은 부모 상태와 공유하는 필드입니다.</strong></p>\n</li>\n</ul>\n</li>\n<li>\n<p>부모 그래프에 자식 그래프 노드를 연결하여 컴파일</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 부모 그래프의 상태 정의를 위한 TypedDict 클래스, name 키만 포함</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ParentState</span><span class=\"token punctuation\">(</span>TypedDict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n    company<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n\n\n<span class=\"token comment\"># 부모 그래프의 첫 번째 노드, name 키의 값을 수정하여 새로운 상태 생성</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">node_1</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> ParentState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f'My name is </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># 부모 그래프 구조 정의 및 서브그래프를 포함한 노드 간 연결 관계 설정</span>\nbuilder <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>ParentState<span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"node_1\"</span><span class=\"token punctuation\">,</span> node_1<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 컴파일된 서브그래프를 부모 그래프의 노드로 추가 (서브그래프를 노드로 추가 가능)</span>\n<span class=\"token triple-quoted-string string\">\"\"\"\n‼️ ParentState가 통째로 “ChildState로 변환”되는 게 아니라, 공유 키(예: name)를 통해 상태가 전달/반환됩니다. ‼️\n‼️ ChildState에 없는 키(예: company)는 서브그래프 내부에서 직접 못 쓰고, 부모 상태에는 그대로 유지됩니다. ‼️\nnode_1이 name만 반환해도 company는 지워지지 않습니다(부분 업데이트 병합, 당연함).\n\"\"\"</span>\n\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"node_2\"</span><span class=\"token punctuation\">,</span> subgraph<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 서브그래프 노드 추가</span>\nbuilder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"node_1\"</span><span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"node_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"node_2\"</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># node_1에서 서브그래프로 가는 엣지 추가</span>\nbuilder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"node_2\"</span><span class=\"token punctuation\">,</span> END<span class=\"token punctuation\">)</span>\n\ngraph <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>checkpointer<span class=\"token operator\">=</span>memory<span class=\"token punctuation\">)</span></code></pre></div>\n<ul>\n<li>\n<p><code class=\"language-text\">START</code> -> <code class=\"language-text\">node_1</code> -> <code class=\"language-text\">node_2</code>(자식 서브그래프) -> <code class=\"language-text\">END</code> 노드로 이동하는 부모 그래프를 컴파일하여 만듭니다.</p>\n</li>\n<li>\n<p>부모 상태는 <code class=\"language-text\">name</code>와  <code class=\"language-text\">company</code>가 있고, <code class=\"language-text\">name</code>은 자식 상태와 공유하는 필드입니다.</p>\n</li>\n</ul>\n</li>\n<li>\n<p><code class=\"language-text\">subgraphs=True</code> 설정하여 stream 호출 &#x26; 상태 출력</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">for</span> chunk <span class=\"token keyword\">in</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Teddy\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> subgraphs<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span>\n<span class=\"token triple-quoted-string string\">\"\"\"출력:\n((), {'node_1': {'name': 'My name is Teddy'}})\n(('node_2:142e5280-832c-0ccd-d554-5901a76bd5d1',), {'subgraph_node_1': {'family_name': 'Lee'}})\n(('node_2:142e5280-832c-0ccd-d554-5901a76bd5d1',), {'subgraph_node_2': {'name': 'My name is Teddy Lee'}})\n((), {'node_2': {'name': 'My name is Teddy Lee'}})\n\"\"\"</span>    \n    \n\nsnapshot <span class=\"token operator\">=</span> graph<span class=\"token punctuation\">.</span>get_state<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> subgraphs<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>snapshot<span class=\"token punctuation\">)</span>\n<span class=\"token triple-quoted-string string\">\"\"\"출력:\nStateSnapshot(values={'name': 'My name is Teddy Lee'}, next=(), config={'configurable': {'thread_id': 'teddy-1', 'checkpoint_ns': '', 'checkpoint_id': '1f10a41c-1ed1-6a70-8006-1f8f4a737d90'}}, metadata={'source': 'loop', 'step': 6, 'parents': {}}, created_at='2026-02-15T07:41:36.788947+00:00', parent_config={'configurable': {'thread_id': 'teddy-1', 'checkpoint_ns': '', 'checkpoint_id': '1f10a41c-1ecb-647c-8005-b481c2ced8ed'}}, tasks=(), interrupts=())\n\"\"\"</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">graph.stream({\"name\": \"Teddy\"}, config, subgraphs=True)</code>\n<ul>\n<li><code class=\"language-text\">subgraphs=True</code>을 설정하여, 현재 namespace 뿐만 아니라 부모 스냅샷, 각 서브그래프 스냅샷이 포함하여 stream 호출하게 됩니다.</li>\n<li><strong>즉, 부모 그래프에서 연결된 자식 그래프까지 각 노드(함수)를 호출하면서 반환되는 값들을 확인할 수 있습니다.</strong></li>\n</ul>\n</li>\n<li><code class=\"language-text\">graph.get_state(config, subgraphs=True)</code>\n<ul>\n<li><code class=\"language-text\">subgraphs=True</code>을 설정하여, 현재 상태 출력</li>\n<li><code class=\"language-text\">name</code>은 부모와 자식 상태 공유되어 있는 필드라서 현 namespace에서 공통으로 나옵니다.</li>\n<li>참고로, 부모 상태에서 company 값이 설정되어 있지 않아서 출력에서 보이지 않은 상태입니다.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<p> </p>\n<blockquote>\n<h4 id=\"️-참고\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-%EC%B0%B8%EA%B3%A0\" aria-label=\"️ 참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✔️ 참고</h4>\n<p>checkpointer 설정하여 get_state로 상태를 보고자 하면 config 설정을 해줘야 합니다.<br>이때 config에서 configurable에 thread_id, checkpoint_ns, checkpoint_id 중에 하나를 설정하여 stream 호출을 해야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># ‼️ checkpointer 설정하면 config에 (thread_id or checkpoint_ns or checkpoint_id)를 설정하여 stream() 호출해야 한다. ‼️</span>\nconfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"configurable\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"thread_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"teddy-1\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">for</span> chunk <span class=\"token keyword\">in</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Teddy\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span></code></pre></div>\n</blockquote>\n<p> </p>\n<h3 id=\"2-스키마-키-공유하지-않는-경우\" style=\"position:relative;\"><a href=\"#2-%EC%8A%A4%ED%82%A4%EB%A7%88-%ED%82%A4-%EA%B3%B5%EC%9C%A0%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-%EA%B2%BD%EC%9A%B0\" aria-label=\"2 스키마 키 공유하지 않는 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 스키마 키 공유하지 않는 경우</h3>\n<p>부모 상태와 자식 상태가 서로 공유하는 키가 없기 때문에<br><strong>업데이트 된 자식 상태에서 특정 상태 필드(name)를 부모 상태의 필드(full_name)에 변환해서 넣어주는 노드를 하나 거쳐야 합니다.</strong></p>\n<blockquote>\n<h4 id=\"️--소스코드-작성-순서-기억-️\" style=\"position:relative;\"><a href=\"#%EF%B8%8F--%EC%86%8C%EC%8A%A4%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1-%EC%88%9C%EC%84%9C-%EA%B8%B0%EC%96%B5-%EF%B8%8F\" aria-label=\"️  소스코드 작성 순서 기억 ️ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>‼️ ** 소스코드 작성 순서 기억** ‼️</h4>\n<ol>\n<li><strong>가장 자식 그래프부터 컴파일하고</strong></li>\n<li><strong>상위 부모 그래프 상태 업데이트할 때 자식 그래프를 invoke해서 상태 넣기</strong></li>\n</ol>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 서브그래프의 상태 타입 정의 (‼️ 부모 그래프와 키를 공유하지 않음 ‼️)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ChildState</span><span class=\"token punctuation\">(</span>TypedDict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 부모 그래프와 공유되지 않는 키들</span>\n    name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n\n\n<span class=\"token comment\"># 서브그래프의 첫 번째 노드: name 키에 초기값 설정 (예제를 위해 2단계로 쪼갠 것)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">subgraph_node_1</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> ChildState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Teddy \"</span> <span class=\"token operator\">+</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># 서브그래프의 두 번째 노드: name 값 그대로 반환</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">subgraph_node_2</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> ChildState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string-interpolation\"><span class=\"token string\">f'My name is </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">'</span></span><span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># 서브그래프 빌더 초기화 및 노드 연결 구성</span>\nsubgraph_builder <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>ChildState<span class=\"token punctuation\">)</span>\nsubgraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span>subgraph_node_1<span class=\"token punctuation\">)</span>\nsubgraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span>subgraph_node_2<span class=\"token punctuation\">)</span>\nsubgraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"subgraph_node_1\"</span><span class=\"token punctuation\">)</span>\nsubgraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"subgraph_node_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"subgraph_node_2\"</span><span class=\"token punctuation\">)</span>\nsubgraph <span class=\"token operator\">=</span> subgraph_builder<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 부모 그래프의 상태 타입 정의 (‼️ name이 없음 ‼️)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ParentState</span><span class=\"token punctuation\">(</span>TypedDict<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    family_name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n    full_name<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n\n\n<span class=\"token comment\"># 부모 그래프의 첫 번째 노드: family_name 값 그대로 반환</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">node_1</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> ParentState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"family_name\"</span><span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"family_name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># ⭐️ 부모 그래프의 두 번째 노드: 서브그래프와 상태 변환 및 결과 처리 ⭐️</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">node_2</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> ParentState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 부모 상태를 서브그래프 상태로 변환</span>\n    response <span class=\"token operator\">=</span> subgraph<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"family_name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 서브그래프 응답을 부모 상태로 변환</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"full_name\"</span><span class=\"token punctuation\">:</span> response<span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>  <span class=\"token comment\"># 자식 상태 name -> 부모 상태 full_name로 넣음</span>\n\n\n<span class=\"token comment\"># 부모 그래프 빌더 초기화 및 노드 연결 구성</span>\nbuilder <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>ParentState<span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"node_1\"</span><span class=\"token punctuation\">,</span> node_1<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 컴파일된 서브그래프 대신 서브그래프를 호출하는 node_2 함수 사용</span>\nbuilder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"node_2\"</span><span class=\"token punctuation\">,</span> node_2<span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"node_1\"</span><span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"node_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"node_2\"</span><span class=\"token punctuation\">)</span>\nbuilder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"node_2\"</span><span class=\"token punctuation\">,</span> END<span class=\"token punctuation\">)</span>\ngraph <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>자식 상태는 name 뿐이고 부모 상태는 family_name, full_name인데<br>자식 그래프(서브 그래프)를 바로 노드로 추가하지 않고 <strong><code class=\"language-text\">node_2</code>와 같이 부모 상태를 입력 받은 후, 자식 그래프를 호출하여 받은 응답을 부모 상태의 <code class=\"language-text\">full_name</code>에 넣으면서 상태 변환을 통해 연결할 수 있습니다.</strong></p>\n<p>이렇게 해야 컴파일 오류가 나지 않습니다!!</p>\n<p> </p>\n<p>⭐️ <strong>이때, 부모 그래프 노드에서 자식 그래프를 invoke할 때 자식 상태는 실제로 업데이트 되지 않고 업데이트된 상태를 반환만 하여 그 상태를 부모 상태에 전달만 해주는 것입니다.</strong> ⭐️</p>\n<p>⭐️ <strong><code class=\"language-text\">부모_graph.stream(input, config, subgraphs=True)</code>로 호출하면 부모 그래프 실행 중 호출된 하위 자식/손자 그래프 노드들의 진행 과정까지 순서대로 스트림으로 확인할 수 있고, 하위 그래프의 결과는 부모 노드로 다시 돌아와 매핑된 부모 상태 키에 저장됩니다.</strong>⭐️</p>\n<p> </p>\n<p>테디노트님의 라이브러리를 통해서</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_teddynote<span class=\"token punctuation\">.</span>graphs <span class=\"token keyword\">import</span> visualize_graph\n\nvisualize_graph<span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">,</span> xray<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></code></pre></div>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 254px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 190%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAmCAIAAABLWSz8AAAACXBIWXMAAAsTAAALEwEAmpwYAAAESElEQVRIx5WWW3PaRhiG/YNy0YtMb9qZtjf9c7npTaZObHyqD3GcOHYMPnCICdjYCBiOAgmEsEwMBnQ+r1a76sjYBAOp3Z13NJL2e/S92m9XqzlvqrkYD2xTAJaKkYaRBJ2+ZToITUfOTd/qWkbHNjqGlm9S2QbZEgc9x2qb2rPgjqlzqsQOusl8OpG/pG64tiZzhvosGGJ0a+ldS+8D68bQesC8MdTn2h41AIAkSp7nYYxnBsyA8Z18CxDquj6E8TPhUSpJkjiO8y9neZ6Eh4+/tYwk38mofLzDHbFURhmcC92WoYwC/gumNSncacW4+jFTiV03Tr+x0TaTVwbPgpumdsiQS8ef/toOvA3tBMlcqFao6NKzbNc16aTHJYVugu985W++3HKx/nVB6j+RedgMF14ZatvSW5pM870b27wyVBWCmZnxlB5mi+OoijJW58nIH5RqOEkcR34ET2VGyIXQhNB0xgSheZfYlOUBQvZ0r+MYCME5AHoAVCFkIGy4kBnKtulul6jTp61WUpZKilzGqAkdvwvCBoSM49Qs69scAF2EKM9rYY91cBMgxkGMblONVjIc2wp/2eoOcrJWgbjpIMbBTeSxfjCmbZvzYdelPI8rSqXTQeFSJdNa9VIlc1ad0KloJ5OSyxmDulCqZ2IpIZayYhHdw9c+DH34KiOXD1uJj9m91fjGe2J3O/1xNb4eYRMHleO1+Pr25YcImziiY2m5BFDTw/VHcE6tfKZja6f/vN5/PX8wv3C08PfB/AF58p7YfRN6sxJbDZInoVqEkMuP4KHtnFRMCMWsQWX02qVSyei1jF5LicW0Wsma9PA8JZUzYsHF7Hd4OGAWYgRACzbN25QAaBHQPZ28FvISrPNWTbApEdA8oA234XktNHrnIez5wziuFnTqqlLyvCuMmxNdeBbcGju5eoA5jMe7ZsGWy/APtnmLUlym1r4gyKiG2cG97ToPaH3C9nDAslIxLhQJrUroNV9aNa1Vk3whrZKEXktr1ZRYTIpFYmLAhqXKKuUQE9++2Fk8WdpIbm2evQucBI7o6KfCwVJ4ef3rxjEd2ysGMxOlup8kSjnYON08e7dwHFg8XlyKrATCy4dU9ENufymysnm2HayGQ1SEkEv2dJ2Lcik6yKdUMqVVz1UypfrHOF84k8sprXqmkAnRf6+sWMRjA9YZLQyI/VXhoAZEDYgZ064JUgF5rOPWHcTAOyG/bA8Lw7ZvLasMAA0A5YwJOrShV/hBzoV1YH+/D3zRtl22rOs5jDFC7rQwRrZtSZLoedh14awA/MMdA/ufISgr/uaI/tdedf8BBI4qyQ/Pwk/D95uGKl7K/SBT28ynCU0oy4OnMw/tkYrw5/n+78ndX3cXf9l5+1t464/zvXi/Pe1/BkyIvZfRrZ9Day8WX70IvHq5u/BTZONzh30CHrXTfnuJrWzeNje7zeWrarDDzvwz+BeHdT2uqA/5MQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"img 2\" title=\"img 2\" src=\"/static/9034b640001dfc9f80cdd1e644d41948/6a91e/img_2.png\" srcset=\"/static/9034b640001dfc9f80cdd1e644d41948/e9ff0/img_2.png 180w,\n/static/9034b640001dfc9f80cdd1e644d41948/6a91e/img_2.png 254w\" sizes=\"(max-width: 254px) 100vw, 254px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n<p>그래프를 출력하여 보면 요렇게 생겼습니다.</p>\n<p> </p>\n<p>끄읕.</p>\n<p> </p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EB%B3%91%EB%A0%AC-%EC%B2%98%EB%A6%AC-fan-out-fan-in--%EC%8B%A0%EB%A2%B0%EB%8F%84-%EB%94%B0%EB%A5%B8-%EC%A0%95%EB%A0%AC\">병렬 처리 (fan-out, fan-in) + 신뢰도 따른 정렬</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%84%9C%EB%B8%8C%EA%B7%B8%EB%9E%98%ED%94%84-%EC%B6%94%EA%B0%80\">서브그래프 추가</a></p>\n<ul>\n<li><a href=\"#1-%EC%8A%A4%ED%82%A4%EB%A7%88-%ED%82%A4-%EA%B3%B5%EC%9C%A0%ED%95%98%EB%8A%94-%EA%B2%BD%EC%9A%B0\">1. 스키마 키 공유하는 경우</a></li>\n<li><a href=\"#2-%EC%8A%A4%ED%82%A4%EB%A7%88-%ED%82%A4-%EA%B3%B5%EC%9C%A0%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94-%EA%B2%BD%EC%9A%B0\">2. 스키마 키 공유하지 않는 경우</a></li>\n</ul>\n</li>\n</ul>\n</div>","excerpt":"참고 : 테디노트의 RAG 비법노트 (https://fastcampus.co.kr/data_online_teddy)소스코드: https://github.com/teddylee777/langchain-kr위키독스: https://wikidocs.net/book/14314   오늘도 LangGraph 기능들을 몇 가지 정리하고자 합니다..레츠기리잇…!!   병렬 처리 (fan-out, fan-in) + 신뢰도 따른 정렬 병렬 노드를 처리한 후 병렬로 처리된 결과를 신뢰도에 따라 정렬하는 코드를 봅시다. 병렬 처리할 때 상태 관리는  변수에서 하고,  타입 힌트를 갖습니다.  리듀서는 병렬처리용 리듀서입니다.  left: 의 이전 상태 right: 해당 노드의 이번 단계의  반환 값  값은 이전에 (병렬) 처리로 얻은 값이 없으면 이번 단계에 반환한 right만 누적하고, 이번 단계 처리한 값이 없으면(fan-in일 때=여기서는  노드) 빈 리스트 []로 초기화 합니다. 노드 엣지 연결…","frontmatter":{"date":"February 18, 2026","title":"[LLM] 테디노트의 RAG 비법노트 끄적끄적-16","categories":"LLM","author":"변우중","emoji":"☀️"},"fields":{"slug":"/26-02-18_1/"}},"next":{"id":"0dfe15fa-7a6e-5ab9-8ce0-881477c61b57","html":"<p>참고 : 테디노트의 RAG 비법노트 (<a href=\"https://fastcampus.co.kr/data_online_teddy)\">https://fastcampus.co.kr/data_online_teddy)</a><br>소스코드: <a href=\"https://github.com/teddylee777/langchain-kr\">https://github.com/teddylee777/langchain-kr</a><br>위키독스: <a href=\"https://wikidocs.net/book/14314\">https://wikidocs.net/book/14314</a></p>\n<p> </p>\n<p>오늘은 LangGraph 기능들 좀 더 알아보고자 합니다.<br>[26-01-17 게시글][<a href=\"https://byeonwoojung.github.io/26-01-17_1/%5D%EC%97%90%EC%84%9C\">https://byeonwoojung.github.io/26-01-17_1/]에서</a> 좀 얘기를 하긴 했었지만 너무 줄줄이 적어나간 글인 것 같아 오늘은 좀 더 정리해서 올리고자 합니다.</p>\n<p> </p>\n<h2 id=\"human-in-the-loop\" style=\"position:relative;\"><a href=\"#human-in-the-loop\" aria-label=\"human in the loop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Human-in-the-loop</h2>\n<hr>\n<p>3가지만 기억합시다.</p>\n<ol>\n<li><strong>HumanRequest 툴과 human_node 노드(실제 실행되는 함수) 생성</strong></li>\n<li><strong>interrupt_before 설정</strong></li>\n<li><strong>그래프 상태 업데이트 &#x26; 계속 호출</strong></li>\n</ol>\n<p> </p>\n<h3 id=\"humanrequest-툴과-human_node-노드실제-실행되는-함수-생성\" style=\"position:relative;\"><a href=\"#humanrequest-%ED%88%B4%EA%B3%BC-human_node-%EB%85%B8%EB%93%9C%EC%8B%A4%EC%A0%9C-%EC%8B%A4%ED%96%89%EB%90%98%EB%8A%94-%ED%95%A8%EC%88%98-%EC%83%9D%EC%84%B1\" aria-label=\"humanrequest 툴과 human_node 노드실제 실행되는 함수 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>HumanRequest 툴과 human_node 노드(실제 실행되는 함수) 생성</h3>\n<p>HumanRequest는 LLM에게 docstring을 주는 방식으로 작성합시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> pydantic <span class=\"token keyword\">import</span> BaseModel\n\n<span class=\"token comment\"># 전문가의 도움이 필요할 때 적절한 가이드를 요청할 수 있는 클래스</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">HumanRequest</span><span class=\"token punctuation\">(</span>BaseModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Forward the conversation to an expert. Use when you can't assist directly or the user needs assistance that exceeds your authority.\n    To use this function, pass the user's 'request' so that an expert can provide appropriate guidance.\n    \"\"\"</span>\n\n    request<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span>\n    </code></pre></div>\n<p>이후, tools에 HumanRequest를 추가해주고 LLM에게 바인드해줍시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_openai <span class=\"token keyword\">import</span> ChatOpenAI\n\n<span class=\"token comment\"># 도구 추가</span>\ntool <span class=\"token operator\">=</span> TavilySearch<span class=\"token punctuation\">(</span>max_results<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 도구 목록 추가(HumanRequest 도구)</span>\ntools <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>tool<span class=\"token punctuation\">,</span> HumanRequest<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># LLM 추가</span>\nllm <span class=\"token operator\">=</span> ChatOpenAI<span class=\"token punctuation\">(</span>model<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">,</span> temperature<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 도구 바인딩</span>\nllm_with_tools <span class=\"token operator\">=</span> llm<span class=\"token punctuation\">.</span>bind_tools<span class=\"token punctuation\">(</span>tools<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">chatbot</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># LLM 도구 호출을 통한 응답 생성</span>\n    response <span class=\"token operator\">=</span> llm_with_tools<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 사람에게 질문할지 여부 초기화</span>\n    ask_human <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\n\n    <span class=\"token comment\"># 도구 호출이 있고 이름이 'HumanRequest' 인 경우 (여기서는 툴 중에 1번째만 가져옴)</span>\n    <span class=\"token keyword\">if</span> response<span class=\"token punctuation\">.</span>tool_calls <span class=\"token keyword\">and</span> response<span class=\"token punctuation\">.</span>tool_calls<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> HumanRequest<span class=\"token punctuation\">.</span>__name__<span class=\"token punctuation\">:</span>\n        ask_human <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n\n    <span class=\"token comment\"># 메시지와 ask_human 상태 반환</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>response<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ask_human\"</span><span class=\"token punctuation\">:</span> ask_human<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그리고,</p>\n<p>response의 툴 호출이 있을 때 그 이름이 HumanRequest이면 ask_human 상태값을 True로 바꾸도록 합시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 상태 그래프 초기화</span>\ngraph_builder <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>State<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 챗봇 노드 추가</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">,</span> chatbot<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 도구 노드 추가</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span> ToolNode<span class=\"token punctuation\">(</span>tools<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>tool<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>그래프 빌더에 상태 초기화, 챗봇과 도구 노드를 추가해준 후에</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>messages <span class=\"token keyword\">import</span> AIMessage<span class=\"token punctuation\">,</span> ToolMessage\n\n\n<span class=\"token comment\"># 응답 메시지 생성(ToolMessage 생성을 위한 함수) -> 사람이 아무 응답을 하지 않는 경우에 이용하기 위함</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">create_response</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">,</span> ai_message<span class=\"token punctuation\">:</span> AIMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> ToolMessage<span class=\"token punctuation\">(</span>\n        content<span class=\"token operator\">=</span>response<span class=\"token punctuation\">,</span>\n        tool_call_id<span class=\"token operator\">=</span>ai_message<span class=\"token punctuation\">.</span>tool_calls<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"id\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 인간 노드 처리</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">human_node</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    new_messages <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> ToolMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># ‼️ 사람으로부터 응답이 없는 경우 ‼️</span>\n        new_messages<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>\n            create_response<span class=\"token punctuation\">(</span><span class=\"token string\">\"No response from human.\"</span><span class=\"token punctuation\">,</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\"># 새 메시지 추가</span>\n        <span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> new_messages<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 사람으로부터 응답을 받았으면 추가하지 않음</span>\n        <span class=\"token comment\"># 플래그 해제</span>\n        <span class=\"token string\">\"ask_human\"</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># 그래프에 인간 노드 추가</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"human\"</span><span class=\"token punctuation\">,</span> human_node<span class=\"token punctuation\">)</span></code></pre></div>\n<p>human_node를 정의해줍시다.</p>\n<ol>\n<li>\n<p><code class=\"language-text\">human_node</code>는 <code class=\"language-text\">chatbot</code>이 <code class=\"language-text\">HumanReqeust</code>라는 도구를 호출하고자 할 때 사람에게 입력을 받은 후에 이루어집니다. <strong>즉, 사람에게 입력 받은 값이 가장 마지막 값에 들어가 있는 거죠.</strong></p>\n</li>\n<li>\n<p><strong>그러면 <code class=\"language-text\">human_node</code>에서 입력을 안 받는 것인데, 이것은 무엇이냐?</strong></p>\n<blockquote>\n<p><strong>human_node 이전에 interrupt해서 값을 받아서 메시지에 넣어두고,</strong></p>\n<p><strong>human_node에서는 사람의 응답을 처리하거나 보정합니다. (ex. 빈 값이면 “No response from human.”으로 변경 등)</strong></p>\n</blockquote>\n</li>\n<li>\n<p><code class=\"language-text\">create_response</code> 함수를 이용해서 툴 메시지에 tool_call_id와 사람의 답변(response)를 넣도록 합시다. 이 함수를 이용해서 <code class=\"language-text\">human_node</code>에서 상태 값을 보정하는 것을 <code class=\"language-text\">ToolMessage</code> 형태로 변환되도록 합시다.</p>\n</li>\n</ol>\n<p> </p>\n<p>그리고 <strong>인간 노드 관련 조건부 엣지</strong>를 추가해줍시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph <span class=\"token keyword\">import</span> END\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>prebuilt <span class=\"token keyword\">import</span> tools_condition\n\n\n<span class=\"token comment\"># ‼️ 다음 노드 선택 ‼️</span>\n<span class=\"token comment\"># 인간에게 질문하는 것 있을 때는 state[\"ask_human\"]이 true이면 human 노드로 반환함</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">select_next_node</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 인간에게 질문 여부 확인</span>\n    <span class=\"token keyword\">if</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"ask_human\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"human\"</span>\n    <span class=\"token comment\"># 이전과 동일한 경로 설정</span>\n    <span class=\"token keyword\">return</span> tools_condition<span class=\"token punctuation\">(</span>\n        state\n    <span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 현재 state[\"messages\"]의 마지막 메시지를 보고 AIMessage.tool_calls 있으면 tools, 없으면 END(__end__)를 반환</span>\n\n\n<span class=\"token comment\"># 조건부 엣지 추가 (문자열 보고 노드로 이동)</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_conditional_edges<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 출발 노드</span>\n    select_next_node<span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 분기 함수(state -> 라벨)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"human\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"human\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span>\n        END<span class=\"token punctuation\">:</span> END<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># select_next_node가 human 반환하면 human 노드로, tools 반환하면 tools 노드로, 그외 END (종료)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">select_next_node</code>에서는 현재 <code class=\"language-text\">ask_human</code> 상태 값이 true이면 <code class=\"language-text\">human</code>(human_node 이름)를 반환하고, 아니면 현재 상태(<code class=\"language-text\">tools</code> 또는 <code class=\"language-text\">END</code>) 이름을 반환합니다. (반환은 단순히 문자열임)</p>\n<p>(tools_condition와 같은 LangGraph에서 제공하는 라우팅 함수 말고 직접 구현도 가능합니다.)</p>\n<p>그리고 그 함수를 이용해서</p>\n<ol>\n<li><code class=\"language-text\">chatbot</code>에서 출발해서</li>\n<li><code class=\"language-text\">select_next_node</code> 분기 함수의 값이</li>\n<li>human이면 <code class=\"language-text\">human</code> 노드로, tools이면 <code class=\"language-text\">tools</code> 노드(액션노드)로, END이면 <code class=\"language-text\">END</code> 노드로 보내도록 <strong>조건부 엣지</strong>를 추가합니다.</li>\n</ol>\n<p> </p>\n<h3 id=\"interrupt_before-설정\" style=\"position:relative;\"><a href=\"#interrupt_before-%EC%84%A4%EC%A0%95\" aria-label=\"interrupt_before 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>interrupt_before 설정</h3>\n<p>다음은 각 엣지들 추가한 후에 메모리 체크포인터와 human 노드에서 Interrupt를 걸어둡시다.<br>이때 interrupt_before로 걸어둡시다!</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 엣지 추가: 'tools'에서 'chatbot'으로</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"tools\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 엣지 추가: 'human'에서 'chatbot'으로</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"human\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 엣지 추가: START에서 'chatbot'으로</span>\ngraph_builder<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"chatbot\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 메모리 저장소 초기화</span>\nmemory <span class=\"token operator\">=</span> MemorySaver<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 그래프 컴파일: 메모리 체크포인터 사용</span>\n<span class=\"token comment\"># ‼️‼️ 그래프 컴파일할 떄 interrupt_before를 걸어두기 ‼️‼️</span>\ngraph <span class=\"token operator\">=</span> graph_builder<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>\n    checkpointer<span class=\"token operator\">=</span>memory<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># 'human' 이전에 인터럽트 설정</span>\n    interrupt_before<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"human\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># ‼️ human 노드애서 인터럽트 ‼️</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>그래프 빌더를 컴파일할 때 메모리와 인터럽트를 설정 가능합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_teddynote<span class=\"token punctuation\">.</span>graphs <span class=\"token keyword\">import</span> visualize_graph\n\nvisualize_graph<span class=\"token punctuation\">(</span>graph<span class=\"token punctuation\">)</span></code></pre></div>\n<p>그래프 출력해보면</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 708px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 68.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACEUlEQVQ4y5WTb2/SUBjF+2184yfw4/iRTMxemcwXM5nT+MY/ccaxjc0VN5bNGMmADQa0FCi0pX/obW/7M72IYYOYeZKTPrk5Pc95nt5qk8mEh9B1HHqjIfW+wWXzilr3ltbQWtFp/AdcmdDxHar1nzQGBpaYrWi0PM95KGWWEaQJXjzDTwSxTOGe5p8JF6JFvYDvOJCtnquE9w2WjZZZYBCHXHo2unnLhTOk7jvrE657+U6jP8/CYKta5uXBJ17sf+TAbK1Moq01KPYlJWmaIoQgiiLEbEbbc6iMDPaua5xYHc6sHp7r3nlPWzZIkkQZJGmq6kQIZSpTqUZbwB6PieKYLMtUszAMlV4lzPIckabEQqivuEhcnI89lygRSCDJM8VQxEQiJs9y1WyBwPdVU+3OkpbQnQXsGy0qQwN90FX8bpuKZxOLsLgyWY7ruiRSEsyi+ciH4z4btSrPf1R4178hTOfRG1OH8thEt0229RKbe+/58OucU2/EN9vETWKluxgYlM02R/02tekY7en5Vx7tbPB46xlPSq9phVMlbAYuZavDce+Gk34H3epybLQpd5roIwMvEUpXnQzYPP7C5tEup7aJZscRV75DPXDphtO/O2z4Dp+Na7ZPD3lVKfH2ssKbixO29BK7t1dM5Xx/vcinHno0Qk/V2rorU2AUR2qE62hKs2DozVnUgUss5dq/6zf7wytsq5KuiAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"img 1\" title=\"img 1\" src=\"/static/c782591e791e65cf4a18191ea144524f/3cb0f/img_1.png\" srcset=\"/static/c782591e791e65cf4a18191ea144524f/e9ff0/img_1.png 180w,\n/static/c782591e791e65cf4a18191ea144524f/f21e7/img_1.png 360w,\n/static/c782591e791e65cf4a18191ea144524f/3cb0f/img_1.png 708w\" sizes=\"(max-width: 708px) 100vw, 708px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n<p>이런 식으로 human_interrupt를 통해 human 노드에 조건부 엣지가 생겨있음을 확인할 수 있습니다.</p>\n<p> </p>\n<h3 id=\"그래프-상태-업데이트--계속-호출\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%9E%98%ED%94%84-%EC%83%81%ED%83%9C-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8--%EA%B3%84%EC%86%8D-%ED%98%B8%EC%B6%9C\" aria-label=\"그래프 상태 업데이트  계속 호출 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그래프 상태 업데이트 &#x26; 계속 호출</h3>\n<p>먼저 config에 configurable의 쓰레드 ID를 설정해준 상태에서 <code class=\"language-text\">stream_mode</code>은 <code class=\"language-text\">values</code>로 설정하여<br>user 메시지에 input값을 넣어 stream으로 호출해봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># user_input = \"이 AI 에이전트를 구축하기 위해 전문가의 도움이 필요합니다. 검색해서 답변하세요\" (Human 이 아닌 웹검색을 수행하는 경우)</span>\nuser_input <span class=\"token operator\">=</span> <span class=\"token string\">\"이 AI 에이전트를 구축하기 위해 전문가의 도움이 필요합니다. 도움을 요청할 수 있나요?\"</span>\n\n<span class=\"token comment\"># config 설정</span>\nconfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"configurable\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"thread_id\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># 스트림 또는 호출의 두 번째 위치 인수로서의 구성</span>\nevents <span class=\"token operator\">=</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"user\"</span><span class=\"token punctuation\">,</span> user_input<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> stream_mode<span class=\"token operator\">=</span><span class=\"token string\">\"values\"</span>\n<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> event <span class=\"token keyword\">in</span> events<span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">\"messages\"</span> <span class=\"token keyword\">in</span> event<span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># 마지막 메시지의 예쁜 출력</span>\n        event<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>pretty_print<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token triple-quoted-string string\">\"\"\"출력:\n================================\u001b[1m Human Message \u001b[0m=================================\n\n이 AI 에이전트를 구축하기 위해 전문가의 도움이 필요합니다. 도움을 요청할 수 있나요?\n==================================\u001b[1m Ai Message \u001b[0m==================================\nTool Calls:\n  HumanRequest (call_KNeSo6khmAxmGlh4wLlTmY97)\n Call ID: call_KNeSo6khmAxmGlh4wLlTmY97\n  Args:\n    request: AI 에이전트를 구축하는 데 필요한 전문가의 도움을 요청합니다. 구체적으로 어떤 기술 스택과 방법론이 필요한지, 그리고 프로젝트를 시작하기 위한 단계에 대한 조언이 필요합니다.\n\"\"\"</span></code></pre></div>\n<p>for문으로 롤링할 때, 각 event에서 messages가 존재할 때 가장 마지막 메시지(최신 메시지)만 출력하는 코드입니다.</p>\n<p>아직 Tool을 호출하지 않은 상태네요. (ToolMessage가 아님)</p>\n<p>현재 chatbot은 HumanRequest 툴을 request 인자 값을 채워 호출을 준비하고 있는데,</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 그래프 상태 스냅샷 생성</span>\nsnapshot <span class=\"token operator\">=</span> graph<span class=\"token punctuation\">.</span>get_state<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 다음 스냅샷 상태 접근</span>\nsnapshot<span class=\"token punctuation\">.</span><span class=\"token builtin\">next</span>\n<span class=\"token triple-quoted-string string\">\"\"\"출력: ('human',)\"\"\"</span></code></pre></div>\n<p>위 코드로 현재 다음 노드를 확인하면 <code class=\"language-text\">human</code>임을 확인할 수 있습니다.<br>즉, human을 호출하기 직전에 interrupt 되어 있는 것을 확인할 수 있습니다.</p>\n<p>그러면</p>\n<p><strong>그 다음 할 일은 <code class=\"language-text\">ToolMessage</code>를 직접 채워준 후에 계속해서 호출을 진행하면 됩니다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 가장 마지막 AI 메시지 추출</span>\n<span class=\"token comment\"># -> create_response에서 tool_calls에서 해당 툴 id를 가져올 것임</span>\nai_message <span class=\"token operator\">=</span> snapshot<span class=\"token punctuation\">.</span>values<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># 인간 응답 생성</span>\nhuman_response <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"전문가들이 도와드리겠습니다! 에이전트 구축을 위해 LangGraph를 확인해 보시기를 적극 추천드립니다. \"</span>\n    <span class=\"token string\">\"단순한 자율 에이전트보다 훨씬 더 안정적이고 확장성이 뛰어납니다. \"</span>\n    <span class=\"token string\">\"https://wikidocs.net/233785 에서 더 많은 정보를 확인할 수 있습니다.\"</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 도구 메시지 생성 (content에 human_response 넣고, tool_call_id에 ai_message에서 해당 툴 id 가져옴)</span>\ntool_message <span class=\"token operator\">=</span> create_response<span class=\"token punctuation\">(</span>human_response<span class=\"token punctuation\">,</span> ai_message<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 그래프 상태 업데이트</span>\ngraph<span class=\"token punctuation\">.</span>update_state<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>tool_message<span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>인간의 응답과 가장 마지막 AI 메시지로 인자로 하여 <code class=\"language-text\">create_response</code> 함수를 호출하여<br>각각 <code class=\"language-text\">content</code>와 <code class=\"language-text\">tool_call_id</code> 값을 채워 ToolMessage로 감싸도록 합니다.</p>\n<p>그 이후 <code class=\"language-text\">config</code>와 메시지를 함께 주어 <code class=\"language-text\">update_state</code>를 통해 그래프 상태를 수동으로 업데이트 합니다.</p>\n<p>업데이트 이후 아래와 같이 계속 호출하면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 그래프에서 이벤트 스트림 생성</span>\nevents <span class=\"token operator\">=</span> graph<span class=\"token punctuation\">.</span>stream<span class=\"token punctuation\">(</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> stream_mode<span class=\"token operator\">=</span><span class=\"token string\">\"values\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 각 이벤트에 대한 처리</span>\n<span class=\"token keyword\">for</span> event <span class=\"token keyword\">in</span> events<span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 메시지가 있는 경우 마지막 메시지 출력</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">\"messages\"</span> <span class=\"token keyword\">in</span> event<span class=\"token punctuation\">:</span>\n        event<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>pretty_print<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        \n<span class=\"token triple-quoted-string string\">\"\"\"출력:\n=================================\u001b[1m Tool Message \u001b[0m=================================\n\n전문가들이 도와드리겠습니다! 에이전트 구축을 위해 LangGraph를 확인해 보시기를 적극 추천드립니다. 단순한 자율 에이전트보다 훨씬 더 안정적이고 확장성이 뛰어납니다. https://wikidocs.net/233785 에서 더 많은 정보를 확인할 수 있습니다.\n=================================\u001b[1m Tool Message \u001b[0m=================================\n\n전문가들이 도와드리겠습니다! 에이전트 구축을 위해 LangGraph를 확인해 보시기를 적극 추천드립니다. 단순한 자율 에이전트보다 훨씬 더 안정적이고 확장성이 뛰어납니다. https://wikidocs.net/233785 에서 더 많은 정보를 확인할 수 있습니다.\n==================================\u001b[1m Ai Message \u001b[0m==================================\n\n전문가의 추천에 따라, AI 에이전트를 구축하기 위해 LangGraph를 확인해 보시기를 권장합니다. LangGraph는 단순한 자율 에이전트보다 훨씬 더 안정적이고 확장성이 뛰어난 솔루션입니다. 더 많은 정보는 [여기](https://wikidocs.net/233785)에서 확인하실 수 있습니다. 도움이 필요하시면 언제든지 말씀해 주세요!\n\"\"\"</span></code></pre></div>\n<p>(참고로 같은 것이 출력된 것은 <code class=\"language-text\">stream_mode</code>가 <code class=\"language-text\">values</code>이기 때문에 ToolMessage 출력 후, 또 한번의 ToolMessage와 최종 AIMessage가 출력된 것입니다.)</p>\n<p> </p>\n<p> </p>\n<h2 id=\"deletemessages\" style=\"position:relative;\"><a href=\"#deletemessages\" aria-label=\"deletemessages permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DeleteMessages</h2>\n<hr>\n<p>특정 메시지를 삭제하는 방법은 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>messages <span class=\"token keyword\">import</span> RemoveMessage\n\n<span class=\"token comment\"># ⭐️ 메시지 배열의 특정 메시지(여기서는 1번째 메시지)를 ID 기반으로 제거하고 앱 상태 업데이트 ⭐️</span>\ngraph<span class=\"token punctuation\">.</span>update_state<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> RemoveMessage<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span>messages<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">update_state</code> 메서드에 현 설정값인 <code class=\"language-text\">config</code>와 <code class=\"language-text\">messages</code> 키 값에 <code class=\"language-text\">RemoveMessage()</code> 객체를 넣어준 딕셔너리를 인자로 주면 됩니다.</p>\n<p>이때, <code class=\"language-text\">RemoveMessage</code>에는 지우고자 하는 특정 메시지의 <code class=\"language-text\">id</code>를 넣어 인스턴스 생성하여 전달합니다.</p>\n<p> </p>\n<h3 id=\"agent가-tool-calling-모두-마쳤을-때-메시지-정리-후-종료하는-그래프-예시\" style=\"position:relative;\"><a href=\"#agent%EA%B0%80-tool-calling-%EB%AA%A8%EB%91%90-%EB%A7%88%EC%B3%A4%EC%9D%84-%EB%95%8C-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%95%EB%A6%AC-%ED%9B%84-%EC%A2%85%EB%A3%8C%ED%95%98%EB%8A%94-%EA%B7%B8%EB%9E%98%ED%94%84-%EC%98%88%EC%8B%9C\" aria-label=\"agent가 tool calling 모두 마쳤을 때 메시지 정리 후 종료하는 그래프 예시 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Agent가 Tool Calling 모두 마쳤을 때, 메시지 정리 후 종료하는 그래프 예시</h3>\n<p>아래는 Agent의 Tool calliing을 마친 뒤에 메시지 개수가 3개 초과 시, 최신 3개만 유지하는 코드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>messages <span class=\"token keyword\">import</span> RemoveMessage\n<span class=\"token keyword\">from</span> typing <span class=\"token keyword\">import</span> Literal\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>tools <span class=\"token keyword\">import</span> tool\n<span class=\"token keyword\">from</span> langchain_openai <span class=\"token keyword\">import</span> ChatOpenAI\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>checkpoint<span class=\"token punctuation\">.</span>memory <span class=\"token keyword\">import</span> MemorySaver\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph <span class=\"token keyword\">import</span> MessagesState<span class=\"token punctuation\">,</span> StateGraph<span class=\"token punctuation\">,</span> START<span class=\"token punctuation\">,</span> END\n<span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>prebuilt <span class=\"token keyword\">import</span> ToolNode<span class=\"token punctuation\">,</span> tools_condition\n\n<span class=\"token comment\"># 체크포인트 저장을 위한 메모리 객체 초기화</span>\nmemory <span class=\"token operator\">=</span> MemorySaver<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># 웹 검색 기능을 모방하는 도구 함수 정의</span>\n<span class=\"token decorator annotation punctuation\">@tool</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">search</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Call to surf on the web.\"\"\"</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"웹 검색 결과: LangGraph 한글 튜토리얼은 https://wikidocs.net/233785 에서 확인할 수 있습니다.\"</span>\n\n\n<span class=\"token comment\"># 도구 목록 생성 및 도구 노드 초기화</span>\ntools <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>search<span class=\"token punctuation\">]</span>\ntool_node <span class=\"token operator\">=</span> ToolNode<span class=\"token punctuation\">(</span>tools<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 모델 초기화 및 도구 바인딩</span>\nmodel <span class=\"token operator\">=</span> ChatOpenAI<span class=\"token punctuation\">(</span>model_name<span class=\"token operator\">=</span><span class=\"token string\">\"gpt-4o-mini\"</span><span class=\"token punctuation\">)</span>\nbound_model <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>bind_tools<span class=\"token punctuation\">(</span>tools<span class=\"token punctuation\">)</span>\n\n\n<span class=\"token comment\"># LLM 모델 호출 및 응답 처리 함수</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">call_model</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> MessagesState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    response <span class=\"token operator\">=</span> bound_model<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> response<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># ⭐️ 메시지 개수가 3개 초과 시 오래된 메시지 삭제 및 최신 메시지만 유지 ⭐️</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">delete_messages</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    messages <span class=\"token operator\">=</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>messages<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">3</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>RemoveMessage<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> messages<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># 메시지 상태에 따른 다음 실행 노드 결정 로직</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">should_continue</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> MessagesState<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Literal<span class=\"token punctuation\">[</span><span class=\"token string\">\"action\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"delete_messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Return the next node to execute.\"\"\"</span>\n    last_message <span class=\"token operator\">=</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># ‼️ 함수 호출이 없는 경우(더 이상 agent가 툴 호출할 것이 없을 때) 메시지 삭제 함수 실행 ‼️</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> last_message<span class=\"token punctuation\">.</span>tool_calls<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"delete_messages\"</span>\n    <span class=\"token comment\"># ‼️ 함수 호출이 있는 경우 액션(툴 호출) 실행 ‼️</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"action\"</span>\n\n\n<span class=\"token comment\"># 메시지 상태 기반 워크플로우 그래프 정의</span>\nworkflow <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>MessagesState<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 에이전트와 액션 노드 추가</span>\nworkflow<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"agent\"</span><span class=\"token punctuation\">,</span> call_model<span class=\"token punctuation\">)</span>\nworkflow<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"action\"</span><span class=\"token punctuation\">,</span> tool_node<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 메시지 삭제 노드 추가</span>\nworkflow<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span>delete_messages<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 시작 노드에서 에이전트 노드로 연결</span>\nworkflow<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"agent\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 조건부 엣지 추가를 통한 노드 간 흐름 제어</span>\nworkflow<span class=\"token punctuation\">.</span>add_conditional_edges<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"agent\"</span><span class=\"token punctuation\">,</span>\n    should_continue<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 액션 노드에서 에이전트 노드로 연결</span>\nworkflow<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"action\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"agent\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 메시지 삭제 노드에서 종료 노드로 연결</span>\nworkflow<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"delete_messages\"</span><span class=\"token punctuation\">,</span> END<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 메모리 체크포인터를 사용하여 워크플로우 컴파일</span>\napp <span class=\"token operator\">=</span> workflow<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>checkpointer<span class=\"token operator\">=</span>memory<span class=\"token punctuation\">)</span></code></pre></div>\n<p>간단히 정리하면</p>\n<ol>\n<li><code class=\"language-text\">agent</code> 노드에서 모델을 메시지 상태를 인자로 하여 <code class=\"language-text\">invoke()</code> 메서드로 호출한 후, 메시지 상태를 반환합니다.</li>\n<li><code class=\"language-text\">action</code> 노드는 툴을 모아놓은  <code class=\"language-text\">tool_node</code> (ToolNode)입니다.</li>\n<li><code class=\"language-text\">agent</code>에는 <code class=\"language-text\">should_continue</code> 분기 함수로 조건부 엣지가 있습니다. (메시지 삭제 또는 툴 호출)</li>\n<li><strong><code class=\"language-text\">should_continue</code>는 agent에서 매번 더이상 툴 호출할 것이 있는지 확인하여 있다면 action(툴 호출) 노드, 없다면 delete_messages(메시지 정리) 노드로 이동합니다.</strong></li>\n<li><strong><code class=\"language-text\">delete_messages</code>는 <code class=\"language-text\">state</code>를 인자로 받고, 메시지가 3개 이상이면 <code class=\"language-text\">{\"messages\": [RemoveMessage(id=m.id) for m in messages[:-3]]}</code>를 통해 가장 최신 3개 메시지만 남기고 지우면서 업데이트할 <code class=\"language-text\">messages</code> 상태를 반환합니다.</strong></li>\n</ol>\n<p> </p>\n<p><strong><code class=\"language-text\">should_continue</code>는 라우터 함수로서 이용하고, 이때 노드 이름을 반환하도록 하면 됩니다.<br>그리고 조건부 엣지의 분기 함수로 사용하게 되면 should_continue를 거치면서 계속 툴을 호출할지, 중간에 메시지를 삭제할지, 끝낼지 결정되면 됩니다.</strong></p>\n<p>그러면, 중간에 요약하는 노드도 <code class=\"language-text\">should_continue</code> 라우터에서 분기처리 하면 되겠죠?</p>\n<p> </p>\n<p> </p>\n<h2 id=\"중간-요약-및-메시지-삭제\" style=\"position:relative;\"><a href=\"#%EC%A4%91%EA%B0%84-%EC%9A%94%EC%95%BD-%EB%B0%8F-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%82%AD%EC%A0%9C\" aria-label=\"중간 요약 및 메시지 삭제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>중간 요약 및 메시지 삭제</h2>\n<hr>\n<p>위에서 메시지 삭제하는 노드</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> langgraph<span class=\"token punctuation\">.</span>graph <span class=\"token keyword\">import</span> END\n<span class=\"token keyword\">from</span> langchain_core<span class=\"token punctuation\">.</span>messages <span class=\"token keyword\">import</span> HumanMessage<span class=\"token punctuation\">,</span> AIMessage<span class=\"token punctuation\">,</span> RemoveMessage\n\n\n<span class=\"token comment\"># 대화 종료 또는 요약 결정 로직</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">should_continue</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Literal<span class=\"token punctuation\">[</span><span class=\"token string\">\"summarize_conversation\"</span><span class=\"token punctuation\">,</span> END<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 메시지 목록 확인</span>\n    messages <span class=\"token operator\">=</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token comment\"># 메시지 수가 6개 초과라면 요약 노드로 이동 ‼️</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>messages<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">6</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"summarize_conversation\"</span>\n    <span class=\"token keyword\">return</span> END\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">safe_delete_ops</span><span class=\"token punctuation\">(</span>messages<span class=\"token punctuation\">,</span> keep_last_human_turns<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 툴 호출 진행 중이면 정리하지 않음</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>messages<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> AIMessage<span class=\"token punctuation\">)</span> <span class=\"token keyword\">and</span> messages<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>tool_calls<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    human_idxs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>i <span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> m <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>messages<span class=\"token punctuation\">)</span> <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">,</span> HumanMessage<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>human_idxs<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;=</span> keep_last_human_turns<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token comment\"># 마지막 N개 human 턴 시작점 이전만 삭제</span>\n    cut <span class=\"token operator\">=</span> human_idxs<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span>keep_last_human_turns<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>RemoveMessage<span class=\"token punctuation\">(</span><span class=\"token builtin\">id</span><span class=\"token operator\">=</span>m<span class=\"token punctuation\">.</span><span class=\"token builtin\">id</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> m <span class=\"token keyword\">in</span> messages<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span>cut<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>\n\n\n<span class=\"token comment\"># 대화 내용 요약 및 메시지 정리 로직</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">summarize_conversation</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">:</span> State<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 이전 요약 정보 확인</span>\n    summary <span class=\"token operator\">=</span> state<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"summary\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 이전 요약 정보가 있다면 요약 메시지 생성</span>\n    <span class=\"token keyword\">if</span> summary<span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># 지금까지의 대화 요약이다. 위의 새로운 메시지를 고려하여 요약을 확장하라.</span>\n        summary_message <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n            <span class=\"token string-interpolation\"><span class=\"token string\">f\"This is summary of the conversation to date: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>summary<span class=\"token punctuation\">}</span></span><span class=\"token string\">\\n\\n\"</span></span>\n            <span class=\"token string\">\"Extend the summary by taking into account the new messages above in Korean:\"</span>\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># 요약 메시지 생성</span>\n        summary_message <span class=\"token operator\">=</span> <span class=\"token string\">\"Create a summary of the conversation above in Korean:\"</span>\n\n    <span class=\"token comment\"># 이전 메시지에 요약 메시지(HumanMessage로 감쌈)를 결합</span>\n    messages <span class=\"token operator\">=</span> state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">[</span>HumanMessage<span class=\"token punctuation\">(</span>content<span class=\"token operator\">=</span>summary_message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 모델 호출</span>\n    response <span class=\"token operator\">=</span> model<span class=\"token punctuation\">.</span>invoke<span class=\"token punctuation\">(</span>messages<span class=\"token punctuation\">)</span>\n    \n    delete_messages <span class=\"token operator\">=</span> safe_delete_ops<span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">[</span><span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> keep_last_human_turns<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"summary\"</span><span class=\"token punctuation\">:</span> response<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">,</span> <span class=\"token string\">\"messages\"</span><span class=\"token punctuation\">:</span> delete_messages<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\"># 워크플로우 그래프 초기화</span>\nworkflow <span class=\"token operator\">=</span> StateGraph<span class=\"token punctuation\">(</span>State<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 대화 및 요약 노드 추가</span>\nworkflow<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span><span class=\"token string\">\"conversation\"</span><span class=\"token punctuation\">,</span> ask_llm<span class=\"token punctuation\">)</span>\nworkflow<span class=\"token punctuation\">.</span>add_node<span class=\"token punctuation\">(</span>summarize_conversation<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 시작점을 대화 노드로 설정</span>\nworkflow<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span>START<span class=\"token punctuation\">,</span> <span class=\"token string\">\"conversation\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 조건부 엣지 추가</span>\nworkflow<span class=\"token punctuation\">.</span>add_conditional_edges<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"conversation\"</span><span class=\"token punctuation\">,</span>\n    should_continue<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"summarize_conversation\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"summarize_conversation\"</span><span class=\"token punctuation\">,</span>\n        END<span class=\"token punctuation\">:</span> END<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># 생략 가능</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 요약 노드에서 종료 노드로의 엣지 추가</span>\nworkflow<span class=\"token punctuation\">.</span>add_edge<span class=\"token punctuation\">(</span><span class=\"token string\">\"summarize_conversation\"</span><span class=\"token punctuation\">,</span> END<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 워크플로우 컴파일 및 메모리 체크포인터 설정</span>\napp <span class=\"token operator\">=</span> workflow<span class=\"token punctuation\">.</span><span class=\"token builtin\">compile</span><span class=\"token punctuation\">(</span>checkpointer<span class=\"token operator\">=</span>memory<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<ol>\n<li>(조건부 엣지 추가)  <code class=\"language-text\">conversation</code>에서 <code class=\"language-text\">should_continue</code> 분기 함수로 조건부 엣지를 추가합니다.</li>\n<li><strong>(노드 라우팅 조건) <code class=\"language-text\">should_continue</code>에서 메시지가 6개 초과하면 <code class=\"language-text\">summarize_conversation</code> 노드로 라우팅합니다.</strong></li>\n<li>(요약) <code class=\"language-text\">summarize_conversation</code>에서 이전 요약이 있다면 요약을 확장하고, 없다면 새롭게 요약을 진행합니다.</li>\n<li><strong>(요약 후 메시지 삭제) <code class=\"language-text\">summarize_conversation</code>에서 요약을 진행한 후, <code class=\"language-text\">safe_delete_ops</code> 함수를 통해 아래의 사항을 지키면서 메시지를 삭제합니다.</strong>\n<ul>\n<li><strong><code class=\"language-text\">AIMessage</code>인 가장 마지막 메시지에서 <code class=\"language-text\">tool_calls</code>가 있다면(툴 호출 진행 중이라면) 정리하지 않음</strong></li>\n<li><strong>2개의 <code class=\"language-text\">HumanMessage</code> 턴만큼만 남기고 삭제한다. (삭제할 것 없을 때는 <code class=\"language-text\">add_message</code> 리듀서라서 []를 반환)</strong></li>\n</ul>\n</li>\n</ol>\n<p> </p>\n<p>조건부 엣지와 노드 라우팅, 상태 업데이트만 잘 고려한다면 쉽게 할 수 있습니다.</p>\n<p> </p>\n<p> </p>\n<p>오늘은 우선 여기까지 쓰고 다음에 나머지를 쓰도록 하겠습니다. 👍🏻</p>\n<p> </p>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#human-in-the-loop\">Human-in-the-loop</a></p>\n<ul>\n<li><a href=\"#humanrequest-%ED%88%B4%EA%B3%BC-human_node-%EB%85%B8%EB%93%9C%EC%8B%A4%EC%A0%9C-%EC%8B%A4%ED%96%89%EB%90%98%EB%8A%94-%ED%95%A8%EC%88%98-%EC%83%9D%EC%84%B1\">HumanRequest 툴과 human_node 노드(실제 실행되는 함수) 생성</a></li>\n<li><a href=\"#interrupt_before-%EC%84%A4%EC%A0%95\">interrupt_before 설정</a></li>\n<li><a href=\"#%EA%B7%B8%EB%9E%98%ED%94%84-%EC%83%81%ED%83%9C-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8--%EA%B3%84%EC%86%8D-%ED%98%B8%EC%B6%9C\">그래프 상태 업데이트 &#x26; 계속 호출</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#deletemessages\">DeleteMessages</a></p>\n<ul>\n<li><a href=\"#agent%EA%B0%80-tool-calling-%EB%AA%A8%EB%91%90-%EB%A7%88%EC%B3%A4%EC%9D%84-%EB%95%8C-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%A0%95%EB%A6%AC-%ED%9B%84-%EC%A2%85%EB%A3%8C%ED%95%98%EB%8A%94-%EA%B7%B8%EB%9E%98%ED%94%84-%EC%98%88%EC%8B%9C\">Agent가 Tool Calling 모두 마쳤을 때, 메시지 정리 후 종료하는 그래프 예시</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%A4%91%EA%B0%84-%EC%9A%94%EC%95%BD-%EB%B0%8F-%EB%A9%94%EC%8B%9C%EC%A7%80-%EC%82%AD%EC%A0%9C\">중간 요약 및 메시지 삭제</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"February 15, 2026","title":"[LLM] 테디노트의 RAG 비법노트 끄적끄적-15","categories":"LLM","author":"변우중","emoji":"☀️"},"fields":{"slug":"/26-02-15_1/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://www.zoomkoding.com","comments":{"utterances":{"repo":"https://github.com/byeonwoojung/byeonwoojung.github.io"}}}}},"pageContext":{"slug":"/26-02-18_1/","nextSlug":"/26-02-15_1/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}